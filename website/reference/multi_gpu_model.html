<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Replicates a model on different GPUs. — multi_gpu_model • keras</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>



  <link href="../extra.css" rel="stylesheet">
  <script src="../extra.js"></script>

<meta property="og:title" content="Replicates a model on different GPUs. — multi_gpu_model" />
<meta property="og:description" content="Replicates a model on different GPUs." />
<meta property="og:image" content="/logo.png" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">keras</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.4.0.9002</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/getting_started.html">Getting Started</a>
    </li>
    <li>
      <a href="../articles/tutorial_basic_classification.html">Basic Classification</a>
    </li>
    <li>
      <a href="../articles/tutorial_basic_text_classification.html">Text Classification</a>
    </li>
    <li>
      <a href="../articles/tutorial_basic_regression.html">Basic Regression</a>
    </li>
    <li>
      <a href="../articles/tutorial_overfit_underfit.html">Overfitting and Underfitting</a>
    </li>
    <li>
      <a href="../articles/tutorial_save_and_restore.html">Save and Restore Models</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Using Keras</li>
    <li>
      <a href="../articles/guide_keras.html">Guide to Keras Basics</a>
    </li>
    <li>
      <a href="../articles/sequential_model.html">Sequential Model in Depth</a>
    </li>
    <li>
      <a href="../articles/functional_api.html">Functional API in Depth</a>
    </li>
    <li>
      <a href="../articles/about_keras_models.html">About Keras Models</a>
    </li>
    <li>
      <a href="../articles/about_keras_layers.html">About Keras Layers</a>
    </li>
    <li>
      <a href="../articles/training_visualization.html">Training Visualization</a>
    </li>
    <li>
      <a href="../articles/applications.html">Pre-Trained Models</a>
    </li>
    <li>
      <a href="../articles/faq.html">Frequently Asked Questions</a>
    </li>
    <li>
      <a href="../articles/why_use_keras.html">Why Use Keras?</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Advanced</li>
    <li>
      <a href="../articles/eager_guide.html">Eager Execution</a>
    </li>
    <li>
      <a href="../articles/training_callbacks.html">Training Callbacks</a>
    </li>
    <li>
      <a href="../articles/backend.html">Keras Backend</a>
    </li>
    <li>
      <a href="../articles/custom_layers.html">Custom Layers</a>
    </li>
    <li>
      <a href="../articles/custom_models.html">Custom Models</a>
    </li>
    <li>
      <a href="../articles/saving_serializing.html">Saving and serializing</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Guides (New for TF 2)
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/python_subclasses.html">Python Subclasses</a>
    </li>
    <li>
      <a href="../articles/guides/customizing_what_happens_in_fit.html">Customizing what happens in fit</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/learn.html">Learn</a>
</li>
<li>
  <a href="../articles/tools.html">Tools</a>
</li>
<li>
  <a href="../articles/examples/index.html">Examples</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="https://github.com/rstudio/keras">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/rstudio/keras/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Replicates a model on different GPUs.</h1>
    <small class="dont-index">Source: <a href='https://github.com/rstudio/keras/blob/master/R/model.R'><code>R/model.R</code></a></small>
    <div class="hidden name"><code>multi_gpu_model.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Replicates a model on different GPUs.</p>
    </div>

    <pre class="usage"><span class='fu'>multi_gpu_model</span><span class='op'>(</span><span class='va'>model</span>, gpus <span class='op'>=</span> <span class='cn'>NULL</span>, cpu_merge <span class='op'>=</span> <span class='cn'>TRUE</span>, cpu_relocation <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>model</th>
      <td><p>A Keras model instance. To avoid OOM errors,
this model could have been built on CPU, for instance
(see usage example below).</p></td>
    </tr>
    <tr>
      <th>gpus</th>
      <td><p><code>NULL</code> to use all available GPUs (default). Integer &gt;= 2 or
list of integers, number of GPUs or list of GPU IDs on which to create
model replicas.</p></td>
    </tr>
    <tr>
      <th>cpu_merge</th>
      <td><p>A boolean value to identify whether to force
merging model weights under the scope of the CPU or not.</p></td>
    </tr>
    <tr>
      <th>cpu_relocation</th>
      <td><p>A boolean value to identify whether to
create the model's weights under the scope of the CPU.
If the model is not defined under any preceding device
scope, you can still rescue it by activating this option.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A Keras model object which can be used just like the initial
<code>model</code> argument, but which distributes its workload on multiple GPUs.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>Specifically, this function implements single-machine
multi-GPU data parallelism. It works in the following way:</p><ul>
<li><p>Divide the model's input(s) into multiple sub-batches.</p></li>
<li><p>Apply a model copy on each sub-batch. Every model copy
is executed on a dedicated GPU.</p></li>
<li><p>Concatenate the results (on CPU) into one big batch.</p></li>
</ul>

<p>E.g. if your <code>batch_size</code> is 64 and you use <code>gpus=2</code>,
then we will divide the input into 2 sub-batches of 32 samples,
process each sub-batch on one GPU, then return the full
batch of 64 processed samples.</p>
<p>This induces quasi-linear speedup on up to 8 GPUs.</p>
<p>This function is only available with the TensorFlow backend
for the time being.</p>
    <h2 class="hasAnchor" id="note"><a class="anchor" href="#note"></a>Note</h2>

    <p>This function is deprecated and has been removed from tensorflow on
2020-04-01. To distribute your training across all available GPUS,
you can use <code>tensorflow::tf$distribute$MirroredStrategy()</code>
by creating your model like this:<div class="r"></p><pre>strategy &lt;- tensorflow::tf$distribute$MirroredStrategy()
with(strategy$scope(), {
  model &lt;- application_xception(
    weights = NULL,
    input_shape = c(height, width, 3),
    classes = num_classes
})
</pre><p></div></p>
    <h2 class="hasAnchor" id="model-saving"><a class="anchor" href="#model-saving"></a>Model Saving</h2>

    


<p>To save the multi-gpu model, use <code><a href='save_model_hdf5.html'>save_model_hdf5()</a></code> or
<code><a href='save_model_weights_hdf5.html'>save_model_weights_hdf5()</a></code> with the template model (the argument you
passed to <code>multi_gpu_model</code>), rather than the model returned
by <code>multi_gpu_model</code>.</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p>Other model functions: 
<code><a href='compile.keras.engine.training.Model.html'>compile.keras.engine.training.Model</a>()</code>,
<code><a href='evaluate.keras.engine.training.Model.html'>evaluate.keras.engine.training.Model</a>()</code>,
<code><a href='evaluate_generator.html'>evaluate_generator</a>()</code>,
<code><a href='fit.keras.engine.training.Model.html'>fit.keras.engine.training.Model</a>()</code>,
<code><a href='fit_generator.html'>fit_generator</a>()</code>,
<code><a href='get_config.html'>get_config</a>()</code>,
<code><a href='get_layer.html'>get_layer</a>()</code>,
<code><a href='keras_model_sequential.html'>keras_model_sequential</a>()</code>,
<code><a href='keras_model.html'>keras_model</a>()</code>,
<code><a href='pop_layer.html'>pop_layer</a>()</code>,
<code><a href='predict.keras.engine.training.Model.html'>predict.keras.engine.training.Model</a>()</code>,
<code><a href='predict_generator.html'>predict_generator</a>()</code>,
<code><a href='predict_on_batch.html'>predict_on_batch</a>()</code>,
<code><a href='predict_proba.html'>predict_proba</a>()</code>,
<code><a href='summary.keras.engine.training.Model.html'>summary.keras.engine.training.Model</a>()</code>,
<code><a href='train_on_batch.html'>train_on_batch</a>()</code></p></div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><span class='r-in'><span class='kw'>if</span> <span class='op'>(</span><span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>{</span></span>
<span class='r-in'></span>
<span class='r-in'><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://keras.rstudio.com'>keras</a></span><span class='op'>)</span></span>
<span class='r-in'><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/rstudio/tensorflow'>tensorflow</a></span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'><span class='va'>num_samples</span> <span class='op'>&lt;-</span> <span class='fl'>1000</span></span>
<span class='r-in'><span class='va'>height</span> <span class='op'>&lt;-</span> <span class='fl'>224</span></span>
<span class='r-in'><span class='va'>width</span> <span class='op'>&lt;-</span> <span class='fl'>224</span></span>
<span class='r-in'><span class='va'>num_classes</span> <span class='op'>&lt;-</span> <span class='fl'>1000</span></span>
<span class='r-in'></span>
<span class='r-in'><span class='co'># Instantiate the base model (or "template" model).</span></span>
<span class='r-in'><span class='co'># We recommend doing this with under a CPU device scope,</span></span>
<span class='r-in'><span class='co'># so that the model's weights are hosted on CPU memory.</span></span>
<span class='r-in'><span class='co'># Otherwise they may end up hosted on a GPU, which would</span></span>
<span class='r-in'><span class='co'># complicate weight sharing.</span></span>
<span class='r-in'><span class='fu'><a href='https://rdrr.io/r/base/with.html'>with</a></span><span class='op'>(</span><span class='va'>tf</span><span class='op'>$</span><span class='fu'>device</span><span class='op'>(</span><span class='st'>"/cpu:0"</span><span class='op'>)</span>, <span class='op'>{</span></span>
<span class='r-in'>  <span class='va'>model</span> <span class='op'>&lt;-</span> <span class='fu'><a href='application_xception.html'>application_xception</a></span><span class='op'>(</span></span>
<span class='r-in'>    weights <span class='op'>=</span> <span class='cn'>NULL</span>,</span>
<span class='r-in'>    input_shape <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>height</span>, <span class='va'>width</span>, <span class='fl'>3</span><span class='op'>)</span>,</span>
<span class='r-in'>    classes <span class='op'>=</span> <span class='va'>num_classes</span></span>
<span class='r-in'>  <span class='op'>)</span></span>
<span class='r-in'><span class='op'>}</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'><span class='co'># Replicates the model on 8 GPUs.</span></span>
<span class='r-in'><span class='co'># This assumes that your machine has 8 available GPUs.</span></span>
<span class='r-in'><span class='va'>parallel_model</span> <span class='op'>&lt;-</span> <span class='fu'>multi_gpu_model</span><span class='op'>(</span><span class='va'>model</span>, gpus <span class='op'>=</span> <span class='fl'>8</span><span class='op'>)</span></span>
<span class='r-in'><span class='va'>parallel_model</span> <span class='op'><a href='%>%.html'>%&gt;%</a></span> <span class='fu'><a href='https://generics.r-lib.org/reference/compile.html'>compile</a></span><span class='op'>(</span></span>
<span class='r-in'>  loss <span class='op'>=</span> <span class='st'>"categorical_crossentropy"</span>,</span>
<span class='r-in'>  optimizer <span class='op'>=</span> <span class='st'>"rmsprop"</span></span>
<span class='r-in'><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'><span class='co'># Generate dummy data.</span></span>
<span class='r-in'><span class='va'>x</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/array.html'>array</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='va'>num_samples</span> <span class='op'>*</span> <span class='va'>height</span> <span class='op'>*</span> <span class='va'>width</span><span class='op'>*</span><span class='fl'>3</span><span class='op'>)</span>,</span>
<span class='r-in'>           dim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>num_samples</span>, <span class='va'>height</span>, <span class='va'>width</span>, <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'><span class='va'>y</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/array.html'>array</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='va'>num_samples</span> <span class='op'>*</span> <span class='va'>num_classes</span><span class='op'>)</span>,</span>
<span class='r-in'>           dim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>num_samples</span>, <span class='va'>num_classes</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'><span class='co'># This `fit` call will be distributed on 8 GPUs.</span></span>
<span class='r-in'><span class='co'># Since the batch size is 256, each GPU will process 32 samples.</span></span>
<span class='r-in'><span class='va'>parallel_model</span> <span class='op'><a href='%>%.html'>%&gt;%</a></span> <span class='fu'><a href='https://generics.r-lib.org/reference/fit.html'>fit</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span>, epochs <span class='op'>=</span> <span class='fl'>20</span>, batch_size <span class='op'>=</span> <span class='fl'>256</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'><span class='co'># Save model via the template model (which shares the same weights):</span></span>
<span class='r-in'><span class='va'>model</span> <span class='op'><a href='%>%.html'>%&gt;%</a></span> <span class='fu'><a href='save_model_hdf5.html'>save_model_hdf5</a></span><span class='op'>(</span><span class='st'>"my_model.h5"</span><span class='op'>)</span></span>
<span class='r-in'><span class='op'>}</span></span>
<span class='r-in'></span>
</pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Tomasz Kalinowski, JJ Allaire, François Chollet,  RStudio,  Google.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


