<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customizing Saving and Serialization • keras</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><link href="../../extra.css" rel="stylesheet">
<script src="../../extra.js"></script><meta property="og:title" content="Customizing Saving and Serialization">
<meta property="og:description" content="A more advanced guide on customizing saving for your layers and models.">
<meta property="og:image" content="https://keras.posit.co/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">keras</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.13.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/getting_started.html">Getting Started</a>
    </li>
    <li>
      <a href="../../articles/tutorial_basic_classification.html">Basic Classification</a>
    </li>
    <li>
      <a href="../../articles/tutorial_basic_text_classification.html">Text Classification</a>
    </li>
    <li>
      <a href="../../articles/tutorial_basic_regression.html">Basic Regression</a>
    </li>
    <li>
      <a href="../../articles/tutorial_overfit_underfit.html">Overfitting and Underfitting</a>
    </li>
    <li>
      <a href="../../articles/tutorial_save_and_restore.html">Save and Restore Models</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Guides
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/writing_your_own_callbacks.html">Writing Your Own Callbacks</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Guides (New for TF 2.6)</li>
    <li>
      <a href="../../articles/new-guides/python_subclasses.html">Python Subclasses</a>
    </li>
    <li>
      <a href="../../articles/new-guides/making_new_layers_and_models_via_subclassing.html">Making New Layers and Models via Subclassing</a>
    </li>
    <li>
      <a href="../../articles/new-guides/customizing_what_happens_in_fit.html">Customizing What Happens in Fit</a>
    </li>
    <li>
      <a href="../../articles/new-guides/writing_your_own_callbacks.html">Writing Your Own Callbacks</a>
    </li>
    <li>
      <a href="../../articles/new-guides/preprocessing_layers.html">Working with Preprocessing Layers</a>
    </li>
    <li>
      <a href="../../argicles/new-guides/working_with_rnns.html">Working with RNNs</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Using Keras</li>
    <li>
      <a href="../../articles/guide_keras.html">Guide to Keras Basics</a>
    </li>
    <li>
      <a href="../../articles/sequential_model.html">Sequential Model in Depth</a>
    </li>
    <li>
      <a href="../../articles/functional_api.html">Functional API in Depth</a>
    </li>
    <li>
      <a href="../../articles/about_keras_models.html">About Keras Models</a>
    </li>
    <li>
      <a href="../../articles/about_keras_layers.html">About Keras Layers</a>
    </li>
    <li>
      <a href="../../articles/training_visualization.html">Training Visualization</a>
    </li>
    <li>
      <a href="../../articles/applications.html">Pre-Trained Models</a>
    </li>
    <li>
      <a href="../../articles/faq.html">Frequently Asked Questions</a>
    </li>
    <li>
      <a href="../../articles/why_use_keras.html">Why Use Keras?</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Advanced</li>
    <li>
      <a href="../../articles/eager_guide.html">Eager Execution</a>
    </li>
    <li>
      <a href="../../articles/training_callbacks.html">Training Callbacks</a>
    </li>
    <li>
      <a href="../../articles/backend.html">Keras Backend</a>
    </li>
    <li>
      <a href="../../articles/custom_layers.html">Custom Layers</a>
    </li>
    <li>
      <a href="../../articles/custom_models.html">Custom Models</a>
    </li>
    <li>
      <a href="../../articles/saving_serializing.html">Saving and serializing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../articles/learn.html">Learn</a>
</li>
<li>
  <a href="../../articles/tools.html">Tools</a>
</li>
<li>
  <a href="../../articles/examples/index.html">Examples</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/keras/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Customizing Saving and Serialization</h1>
                        <h4 data-toc-skip class="author">Neel
Kovelamudi</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/keras/blob/HEAD/vignettes/guides/customizing_saving_and_serialization.Rmd" class="external-link"><code>vignettes/guides/customizing_saving_and_serialization.Rmd</code></a></small>
      <div class="hidden name"><code>customizing_saving_and_serialization.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This guide covers advanced methods that can be customized in Keras
saving. For most users, the methods outlined in the primary <a href="https://keras.io/guides/serialization_and_saving" class="external-link">Serialize, save,
and export guide</a> are sufficient.</p>
<div class="section level3">
<h3 id="apis">APIs<a class="anchor" aria-label="anchor" href="#apis"></a>
</h3>
<p>We will cover the following APIs:</p>
<ul>
<li>
<code>save_assets()</code> and <code>load_assets()</code>
</li>
<li>
<code>save_own_variables()</code> and
<code>load_own_variables()</code>
</li>
<li>
<code>get_build_config()</code> and
<code>build_from_config()</code>
</li>
<li>
<code>get_compile_config()</code> and
<code>compile_from_config()</code>
</li>
</ul>
<p>When restoring a model, these get executed in the following
order:</p>
<ul>
<li><code>build_from_config()</code></li>
<li><code>compile_from_config()</code></li>
<li><code>load_own_variables()</code></li>
<li><code>load_assets()</code></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="im">import</span> keras</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="state-saving-customization">State saving customization<a class="anchor" aria-label="anchor" href="#state-saving-customization"></a>
</h2>
<p>These methods determine how the state of your model’s layers is saved
when calling <code>model.save()</code>. You can override them to take
full control of the state saving process.</p>
<div class="section level3">
<h3 id="save_own_variables-and-load_own_variables">
<code>save_own_variables()</code> and
<code>load_own_variables()</code><a class="anchor" aria-label="anchor" href="#save_own_variables-and-load_own_variables"></a>
</h3>
<p>These methods save and load the state variables of the layer when
<code>model.save()</code> and <code>keras.models.load_model()</code> are
called, respectively. By default, the state variables saved and loaded
are the weights of the layer (both trainable and non-trainable). Here is
the default implementation of <code>save_own_variables()</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="kw">def</span> save_own_variables(<span class="va">self</span>, store):</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    all_vars <span class="op">=</span> <span class="va">self</span>._trainable_weights <span class="op">+</span> <span class="va">self</span>._non_trainable_weights</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="cf">for</span> i, v <span class="kw">in</span> <span class="bu">enumerate</span>(all_vars):</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>        store[<span class="ss">f"</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> v.numpy()</span></code></pre></div>
<p>The store used by these methods is a dictionary that can be populated
with the layer variables. Let’s take a look at an example customizing
this.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="at">@keras.utils.register_keras_serializable</span>(package<span class="op">=</span><span class="st">"my_custom_package"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="kw">class</span> LayerWithCustomVariables(keras.layers.Dense):</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, units, <span class="op">**</span>kwargs):</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(units, <span class="op">**</span>kwargs)</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>        <span class="va">self</span>.stored_variables <span class="op">=</span> tf.Variable(</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>            np.random.random((<span class="dv">10</span>,)), name<span class="op">=</span><span class="st">"special_arr"</span>, dtype<span class="op">=</span>tf.float32</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>        )</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>    <span class="kw">def</span> save_own_variables(<span class="va">self</span>, store):</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>        <span class="bu">super</span>().save_own_variables(store)</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>        <span class="co"># Stores the value of the `tf.Variable` upon saving</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>        store[<span class="st">"variables"</span>] <span class="op">=</span> <span class="va">self</span>.stored_variables.numpy()</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>    <span class="kw">def</span> load_own_variables(<span class="va">self</span>, store):</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>        <span class="co"># Assigns the value of the `tf.Variable` upon loading</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>        <span class="va">self</span>.stored_variables.assign(store[<span class="st">"variables"</span>])</span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>        <span class="co"># Load the remaining weights</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>        <span class="cf">for</span> i, v <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.weights):</span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>            v.assign(store[<span class="ss">f"</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>])</span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>        <span class="co"># Note: You must specify how all variables (including layer weights)</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>        <span class="co"># are loaded in `load_own_variables.`</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, inputs):</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">super</span>().call(inputs) <span class="op">*</span> <span class="va">self</span>.stored_variables</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>model <span class="op">=</span> keras.Sequential([LayerWithCustomVariables(<span class="dv">1</span>)])</span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>ref_input <span class="op">=</span> np.random.random((<span class="dv">8</span>, <span class="dv">10</span>))</span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>ref_output <span class="op">=</span> np.random.random((<span class="dv">8</span>,))</span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">"adam"</span>, loss<span class="op">=</span><span class="st">"mean_squared_error"</span>)</span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>model.fit(ref_input, ref_output)</span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a>model.save(<span class="st">"custom_vars_model.keras"</span>)</span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a>restored_model <span class="op">=</span> keras.models.load_model(<span class="st">"custom_vars_model.keras"</span>)</span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a>np.testing.assert_allclose(</span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a>    model.layers[<span class="dv">0</span>].stored_variables.numpy(),</span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a>    restored_model.layers[<span class="dv">0</span>].stored_variables.numpy(),</span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="save_assets-and-load_assets">
<code>save_assets()</code> and <code>load_assets()</code><a class="anchor" aria-label="anchor" href="#save_assets-and-load_assets"></a>
</h3>
<p>These methods can be added to your model class definition to store
and load any additional information that your model needs.</p>
<p>For example, NLP domain layers such as TextVectorization layers and
IndexLookup layers may need to store their associated vocabulary (or
lookup table) in a text file upon saving.</p>
<p>Let’s take at the basics of this workflow with a simple file
<code>assets.txt</code>.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="at">@keras.saving.register_keras_serializable</span>(package<span class="op">=</span><span class="st">"my_custom_package"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="kw">class</span> LayerWithCustomAssets(keras.layers.Dense):</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, vocab<span class="op">=</span><span class="va">None</span>, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>        <span class="va">self</span>.vocab <span class="op">=</span> vocab</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    <span class="kw">def</span> save_assets(<span class="va">self</span>, inner_path):</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>        <span class="co"># Writes the vocab (sentence) to text file at save time.</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(os.path.join(inner_path, <span class="st">"vocabulary.txt"</span>), <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>            f.write(<span class="va">self</span>.vocab)</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>    <span class="kw">def</span> load_assets(<span class="va">self</span>, inner_path):</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>        <span class="co"># Reads the vocab (sentence) from text file at load time.</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(os.path.join(inner_path, <span class="st">"vocabulary.txt"</span>), <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>            text <span class="op">=</span> f.read()</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>        <span class="va">self</span>.vocab <span class="op">=</span> text.replace(<span class="st">"&lt;unk&gt;"</span>, <span class="st">"little"</span>)</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>model <span class="op">=</span> keras.Sequential(</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>    [LayerWithCustomAssets(vocab<span class="op">=</span><span class="st">"Mary had a &lt;unk&gt; lamb."</span>, units<span class="op">=</span><span class="dv">5</span>)]</span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>)</span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>x <span class="op">=</span> np.random.random((<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>y <span class="op">=</span> model(x)</span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>model.save(<span class="st">"custom_assets_model.keras"</span>)</span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>restored_model <span class="op">=</span> keras.models.load_model(<span class="st">"custom_assets_model.keras"</span>)</span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>np.testing.assert_string_equal(</span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>    restored_model.layers[<span class="dv">0</span>].vocab, <span class="st">"Mary had a little lamb."</span></span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a>)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="build-and-compile-saving-customization">
<code>build</code> and <code>compile</code> saving
customization<a class="anchor" aria-label="anchor" href="#build-and-compile-saving-customization"></a>
</h2>
<div class="section level3">
<h3 id="get_build_config-and-build_from_config">
<code>get_build_config()</code> and
<code>build_from_config()</code><a class="anchor" aria-label="anchor" href="#get_build_config-and-build_from_config"></a>
</h3>
<p>These methods work together to save the layer’s built states and
restore them upon loading.</p>
<p>By default, this only includes a build config dictionary with the
layer’s input shape, but overriding these methods can be used to include
further Variables and Lookup Tables that can be useful to restore for
your built model.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="at">@keras.saving.register_keras_serializable</span>(package<span class="op">=</span><span class="st">"my_custom_package"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="kw">class</span> LayerWithCustomBuild(keras.layers.Layer):</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, units<span class="op">=</span><span class="dv">32</span>, <span class="op">**</span>kwargs):</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">**</span>kwargs)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>        <span class="va">self</span>.units <span class="op">=</span> units</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, inputs):</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>        <span class="cf">return</span> tf.matmul(inputs, <span class="va">self</span>.w) <span class="op">+</span> <span class="va">self</span>.b</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>    <span class="kw">def</span> get_config(<span class="va">self</span>):</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">dict</span>(units<span class="op">=</span><span class="va">self</span>.units, <span class="op">**</span><span class="bu">super</span>().get_config())</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>    <span class="kw">def</span> build(<span class="va">self</span>, input_shape, layer_init):</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>        <span class="co"># Note the customization in overriding `build()` adds an extra argument.</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>        <span class="co"># Therefore, we will need to manually call build with `layer_init` argument</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>        <span class="co"># before the first execution of `call()`.</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>        <span class="bu">super</span>().build(input_shape)</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>        <span class="va">self</span>.w <span class="op">=</span> <span class="va">self</span>.add_weight(</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>            shape<span class="op">=</span>(input_shape[<span class="op">-</span><span class="dv">1</span>], <span class="va">self</span>.units),</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>            initializer<span class="op">=</span>layer_init,</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>            trainable<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>        )</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>        <span class="va">self</span>.b <span class="op">=</span> <span class="va">self</span>.add_weight(</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>            shape<span class="op">=</span>(<span class="va">self</span>.units,),</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>            initializer<span class="op">=</span>layer_init,</span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>            trainable<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>        )</span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>        <span class="va">self</span>.layer_init <span class="op">=</span> layer_init</span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>    <span class="kw">def</span> get_build_config(<span class="va">self</span>):</span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a>        build_config <span class="op">=</span> <span class="bu">super</span>().get_build_config()  <span class="co"># only gives `input_shape`</span></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a>        build_config.update(</span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>            {<span class="st">"layer_init"</span>: <span class="va">self</span>.layer_init}  <span class="co"># Stores our initializer for `build()`</span></span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a>        )</span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a>        <span class="cf">return</span> build_config</span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a></span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a>    <span class="kw">def</span> build_from_config(<span class="va">self</span>, config):</span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a>        <span class="co"># Calls `build()` with the parameters at loading time</span></span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a>        <span class="va">self</span>.build(config[<span class="st">"input_shape"</span>], config[<span class="st">"layer_init"</span>])</span>
<span id="cb5-40"><a href="#cb5-40" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" tabindex="-1"></a></span>
<span id="cb5-42"><a href="#cb5-42" tabindex="-1"></a>custom_layer <span class="op">=</span> LayerWithCustomBuild(units<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb5-43"><a href="#cb5-43" tabindex="-1"></a>custom_layer.build(input_shape<span class="op">=</span>(<span class="dv">8</span>,), layer_init<span class="op">=</span><span class="st">"random_normal"</span>)</span>
<span id="cb5-44"><a href="#cb5-44" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" tabindex="-1"></a>model <span class="op">=</span> keras.Sequential(</span>
<span id="cb5-46"><a href="#cb5-46" tabindex="-1"></a>    [</span>
<span id="cb5-47"><a href="#cb5-47" tabindex="-1"></a>        custom_layer,</span>
<span id="cb5-48"><a href="#cb5-48" tabindex="-1"></a>        keras.layers.Dense(<span class="dv">1</span>, activation<span class="op">=</span><span class="st">"sigmoid"</span>),</span>
<span id="cb5-49"><a href="#cb5-49" tabindex="-1"></a>    ]</span>
<span id="cb5-50"><a href="#cb5-50" tabindex="-1"></a>)</span>
<span id="cb5-51"><a href="#cb5-51" tabindex="-1"></a></span>
<span id="cb5-52"><a href="#cb5-52" tabindex="-1"></a>x <span class="op">=</span> np.random.random((<span class="dv">16</span>, <span class="dv">8</span>))</span>
<span id="cb5-53"><a href="#cb5-53" tabindex="-1"></a>y <span class="op">=</span> model(x)</span>
<span id="cb5-54"><a href="#cb5-54" tabindex="-1"></a></span>
<span id="cb5-55"><a href="#cb5-55" tabindex="-1"></a>model.save(<span class="st">"custom_build_model.keras"</span>)</span>
<span id="cb5-56"><a href="#cb5-56" tabindex="-1"></a>restored_model <span class="op">=</span> keras.models.load_model(<span class="st">"custom_build_model.keras"</span>)</span>
<span id="cb5-57"><a href="#cb5-57" tabindex="-1"></a></span>
<span id="cb5-58"><a href="#cb5-58" tabindex="-1"></a>np.testing.assert_equal(restored_model.layers[<span class="dv">0</span>].layer_init, <span class="st">"random_normal"</span>)</span>
<span id="cb5-59"><a href="#cb5-59" tabindex="-1"></a>np.testing.assert_equal(restored_model.built, <span class="va">True</span>)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="get_compile_config-and-compile_from_config">
<code>get_compile_config()</code> and
<code>compile_from_config()</code><a class="anchor" aria-label="anchor" href="#get_compile_config-and-compile_from_config"></a>
</h3>
<p>These methods work together to save the information with which the
model was compiled (optimizers, losses, etc.) and restore and re-compile
the model with this information.</p>
<p>Overriding these methods can be useful for compiling the restored
model with custom optimizers, custom losses, etc., as these will need to
be deserialized prior to calling <code>model.compile</code> in
<code>compile_from_config()</code>.</p>
<p>Let’s take a look at an example of this.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="at">@keras.saving.register_keras_serializable</span>(package<span class="op">=</span><span class="st">"my_custom_package"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="kw">def</span> small_square_sum_loss(y_true, y_pred):</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    loss <span class="op">=</span> tf.math.squared_difference(y_pred, y_true)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    loss <span class="op">=</span> loss <span class="op">/</span> <span class="fl">10.0</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    loss <span class="op">=</span> tf.reduce_sum(loss, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    <span class="cf">return</span> loss</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="at">@keras.saving.register_keras_serializable</span>(package<span class="op">=</span><span class="st">"my_custom_package"</span>)</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="kw">def</span> mean_pred(y_true, y_pred):</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>    <span class="cf">return</span> tf.reduce_mean(y_pred)</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a><span class="at">@keras.saving.register_keras_serializable</span>(package<span class="op">=</span><span class="st">"my_custom_package"</span>)</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="kw">class</span> ModelWithCustomCompile(keras.Model):</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>        <span class="va">self</span>.dense1 <span class="op">=</span> keras.layers.Dense(<span class="dv">8</span>, activation<span class="op">=</span><span class="st">"relu"</span>)</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>        <span class="va">self</span>.dense2 <span class="op">=</span> keras.layers.Dense(<span class="dv">4</span>, activation<span class="op">=</span><span class="st">"softmax"</span>)</span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, inputs):</span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.dense1(inputs)</span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.dense2(x)</span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a>    <span class="kw">def</span> <span class="bu">compile</span>(<span class="va">self</span>, optimizer, loss_fn, metrics):</span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>        <span class="bu">super</span>().<span class="bu">compile</span>(optimizer<span class="op">=</span>optimizer, loss<span class="op">=</span>loss_fn, metrics<span class="op">=</span>metrics)</span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>        <span class="va">self</span>.model_optimizer <span class="op">=</span> optimizer</span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>        <span class="va">self</span>.loss_fn <span class="op">=</span> loss_fn</span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>        <span class="va">self</span>.loss_metrics <span class="op">=</span> metrics</span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a>    <span class="kw">def</span> get_compile_config(<span class="va">self</span>):</span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a>        <span class="co"># These parameters will be serialized at saving time.</span></span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a>            <span class="st">"model_optimizer"</span>: <span class="va">self</span>.model_optimizer,</span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a>            <span class="st">"loss_fn"</span>: <span class="va">self</span>.loss_fn,</span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a>            <span class="st">"metric"</span>: <span class="va">self</span>.loss_metrics,</span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a>        }</span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a>    <span class="kw">def</span> compile_from_config(<span class="va">self</span>, config):</span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a>        <span class="co"># Deserializes the compile parameters (important, since many are custom)</span></span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a>        optimizer <span class="op">=</span> keras.utils.deserialize_keras_object(config[<span class="st">"model_optimizer"</span>])</span>
<span id="cb6-42"><a href="#cb6-42" tabindex="-1"></a>        loss_fn <span class="op">=</span> keras.utils.deserialize_keras_object(config[<span class="st">"loss_fn"</span>])</span>
<span id="cb6-43"><a href="#cb6-43" tabindex="-1"></a>        metrics <span class="op">=</span> keras.utils.deserialize_keras_object(config[<span class="st">"metric"</span>])</span>
<span id="cb6-44"><a href="#cb6-44" tabindex="-1"></a></span>
<span id="cb6-45"><a href="#cb6-45" tabindex="-1"></a>        <span class="co"># Calls compile with the deserialized parameters</span></span>
<span id="cb6-46"><a href="#cb6-46" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">compile</span>(optimizer<span class="op">=</span>optimizer, loss_fn<span class="op">=</span>loss_fn, metrics<span class="op">=</span>metrics)</span>
<span id="cb6-47"><a href="#cb6-47" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" tabindex="-1"></a></span>
<span id="cb6-49"><a href="#cb6-49" tabindex="-1"></a>model <span class="op">=</span> ModelWithCustomCompile()</span>
<span id="cb6-50"><a href="#cb6-50" tabindex="-1"></a>model.<span class="bu">compile</span>(</span>
<span id="cb6-51"><a href="#cb6-51" tabindex="-1"></a>    optimizer<span class="op">=</span><span class="st">"SGD"</span>, loss_fn<span class="op">=</span>small_square_sum_loss, metrics<span class="op">=</span>[<span class="st">"accuracy"</span>, mean_pred]</span>
<span id="cb6-52"><a href="#cb6-52" tabindex="-1"></a>)</span>
<span id="cb6-53"><a href="#cb6-53" tabindex="-1"></a></span>
<span id="cb6-54"><a href="#cb6-54" tabindex="-1"></a>x <span class="op">=</span> np.random.random((<span class="dv">4</span>, <span class="dv">8</span>))</span>
<span id="cb6-55"><a href="#cb6-55" tabindex="-1"></a>y <span class="op">=</span> np.random.random((<span class="dv">4</span>,))</span>
<span id="cb6-56"><a href="#cb6-56" tabindex="-1"></a></span>
<span id="cb6-57"><a href="#cb6-57" tabindex="-1"></a>model.fit(x, y)</span>
<span id="cb6-58"><a href="#cb6-58" tabindex="-1"></a></span>
<span id="cb6-59"><a href="#cb6-59" tabindex="-1"></a>model.save(<span class="st">"custom_compile_model.keras"</span>)</span>
<span id="cb6-60"><a href="#cb6-60" tabindex="-1"></a>restored_model <span class="op">=</span> keras.models.load_model(<span class="st">"custom_compile_model.keras"</span>)</span>
<span id="cb6-61"><a href="#cb6-61" tabindex="-1"></a></span>
<span id="cb6-62"><a href="#cb6-62" tabindex="-1"></a>np.testing.assert_equal(model.model_optimizer, restored_model.model_optimizer)</span>
<span id="cb6-63"><a href="#cb6-63" tabindex="-1"></a>np.testing.assert_equal(model.loss_fn, restored_model.loss_fn)</span>
<span id="cb6-64"><a href="#cb6-64" tabindex="-1"></a>np.testing.assert_equal(model.loss_metrics, restored_model.loss_metrics)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>Using the methods learned in this tutorial allows for a wide variety
of use cases, allowing the saving and loading of complex models with
exotic assets and state elements. To recap:</p>
<ul>
<li>
<code>save_own_variables</code> and <code>load_own_variables</code>
determine how your states are saved and loaded.</li>
<li>
<code>save_assets</code> and <code>load_assets</code> can be added
to store and load any additional information your model needs.</li>
<li>
<code>get_build_config</code> and <code>build_from_config</code>
save and restore the model’s built states.</li>
<li>
<code>get_compile_config</code> and <code>compile_from_config</code>
save and restore the model’s compiled states.</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Tomasz Kalinowski, JJ Allaire, François Chollet, RStudio, Google.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
