<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>The Functional API • keras3</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="The Functional API">
<meta name="description" content="Complete guide to the functional API.">
<meta property="og:description" content="Complete guide to the functional API.">
<meta name="robots" content="noindex">
<!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KHBDBW7');</script><!-- End Google Tag Manager -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KHBDBW7" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) -->


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="inverse" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">keras3</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.4.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/getting_started.html">Getting Started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-guides" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Guides</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-guides">
<li><h6 class="dropdown-header" data-toc-skip>Model definition</h6></li>
    <li><a class="dropdown-item" href="../articles/sequential_model.html">Sequential Model</a></li>
    <li><a class="dropdown-item" href="../articles/functional_api.html">Functional API</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Extending and customizing</h6></li>
    <li><a class="dropdown-item" href="../articles/training_with_built_in_methods.html">Training &amp; evaluation with the built-in methods</a></li>
    <li><a class="dropdown-item" href="../articles/custom_train_step_in_tensorflow.html">Customizing `fit()` with Tensorflow</a></li>
    <li><a class="dropdown-item" href="../articles/writing_your_own_callbacks.html">Writing your own callbacks</a></li>
    <li><a class="dropdown-item" href="../articles/making_new_layers_and_models_via_subclassing.html">Making new layers and models via subclassing</a></li>
    <li><a class="dropdown-item" href="../articles/writing_a_custom_training_loop_in_tensorflow.html">Writing a training loop from scratch in TensorFlow</a></li>
    <li><a class="dropdown-item" href="../articles/serialization_and_saving.html">Serialization and Saving</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Other topics</h6></li>
    <li><a class="dropdown-item" href="../articles/transfer_learning.html">Transfer learning and fine tuning</a></li>
    <li><a class="dropdown-item" href="../articles/distributed_training_with_tensorflow.html">Distributed training with TensorFlow</a></li>
    <li><a class="dropdown-item" href="../articles/distribution.html">Distributed training with Jax</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/examples/index.html">Examples</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rstudio/keras3/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>The Functional API</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/keras3/blob/HEAD/vignettes/functional_api.Rmd" class="external-link"><code>vignettes/functional_api.Rmd</code></a></small>
      <div class="d-none name"><code>functional_api.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keras3.posit.co/">keras3</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The Keras <em>functional API</em> is a way to create models that are
more flexible than the sequential API. The functional API can handle
models with non-linear topology, shared layers, and even multiple inputs
or outputs.</p>
<p>The main idea is that a deep learning model is usually a directed
acyclic graph (DAG) of layers. So the functional API is a way to build
<em>graphs of layers</em>.</p>
<p>Consider the following model:</p>
<div class="k-default-codeblock">
<pre><code>(input: 784-dimensional vectors)
       ↧
[Dense (64 units, relu activation)]
       ↧
[Dense (64 units, relu activation)]
       ↧
[Dense (10 units, softmax activation)]
       ↧
(output: logits of a probability distribution over 10 classes)</code></pre>
</div>
<p>This is a basic graph with three layers. To build this model using
the functional API, start by creating an input node:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">784</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The shape of the data is set as a 784-dimensional vector. The batch
size is always omitted since only the shape of each sample is
specified.</p>
<p>If, for example, you have an image input with a shape of
<code>(32, 32, 3)</code>, you would use:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Just for demonstration purposes.</span></span>
<span><span class="va">img_inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">32</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The <code>inputs</code> that is returned contains information about
the shape and <code>dtype</code> of the input data that you feed to your
model. Here’s the shape:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## shape(NA, 784)</span></span></code></pre>
<p>Here’s the dtype:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inputs</span><span class="op">$</span><span class="va">dtype</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "float32"</span></span></code></pre>
<p>You create a new node in the graph of layers by calling a layer on
this <code>inputs</code> object:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dense</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">64</span>, activation<span class="op">=</span><span class="st">"relu"</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">dense</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span></span></code></pre></div>
<p>The “layer call” action is like drawing an arrow from “inputs” to
this layer you created. You’re “passing” the inputs to the
<code>dense</code> layer, and you get <code>x</code> as the output.</p>
<p>Let’s add a few more layers to the graph of layers:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outputs</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>At this point, you can create a <code>Model</code> by specifying its
inputs and outputs in the graph of layers:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">inputs</span>, outputs <span class="op">=</span> <span class="va">outputs</span>, name <span class="op">=</span> <span class="st">"mnist_model"</span><span class="op">)</span></span></code></pre></div>
<p>Let’s check out what the model summary looks like:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="font-weight: bold;">Model: "mnist_model"</span></span></span>
<span><span class="co">## ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓</span></span>
<span><span class="co">## ┃<span style="font-weight: bold;"> Layer (type)                    </span>┃<span style="font-weight: bold;"> Output Shape           </span>┃<span style="font-weight: bold;">       Param # </span>┃</span></span>
<span><span class="co">## ┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩</span></span>
<span><span class="co">## │ input_layer (<span style="color: #0087FF;">InputLayer</span>)        │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">784</span>)            │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ dense (<span style="color: #0087FF;">Dense</span>)                   │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">64</span>)             │        <span style="color: #00AF00;">50,240</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ dense_1 (<span style="color: #0087FF;">Dense</span>)                 │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">64</span>)             │         <span style="color: #00AF00;">4,160</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ dense_2 (<span style="color: #0087FF;">Dense</span>)                 │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">10</span>)             │           <span style="color: #00AF00;">650</span> │</span></span>
<span><span class="co">## └─────────────────────────────────┴────────────────────────┴───────────────┘</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Total params: </span><span style="color: #00AF00;">55,050</span> (215.04 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Trainable params: </span><span style="color: #00AF00;">55,050</span> (215.04 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Non-trainable params: </span><span style="color: #00AF00;">0</span> (0.00 B)</span></span></code></pre>
<p>You can also plot the model as a graph:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<p><img src="functional_api/unnamed-chunk-10-1.png" width="176"></p>
<p>And, optionally, display the input and output shapes of each layer in
the plotted graph:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model</span>, show_shapes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="functional_api/unnamed-chunk-11-1.png" width="580"></p>
<p>This figure and the code are almost identical. In the code version,
the connection arrows are replaced by the call operation.</p>
<p>A “graph of layers” is an intuitive mental image for a deep learning
model, and the functional API is a way to create models that closely
mirrors this.</p>
</div>
<div class="section level2">
<h2 id="training-evaluation-and-inference">Training, evaluation, and inference<a class="anchor" aria-label="anchor" href="#training-evaluation-and-inference"></a>
</h2>
<p>Training, evaluation, and inference work exactly in the same way for
models built using the functional API as for <code>Sequential</code>
models.</p>
<p>The <code>Model</code> class offers a built-in training loop (the
<code><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit()</a></code> method) and a built-in evaluation loop (the
<code><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html" class="external-link">evaluate()</a></code> method). Note that you can easily <a href="custom_train_step_in_tensorflow.html">customize these loops</a> to
implement training routines beyond supervised learning (e.g. <a href="https://keras.io/examples/generative/dcgan_overriding_train_step/" class="external-link">GANs</a>).</p>
<!-- See also the guides on customizing what happens in `fit()`: -->
<!-- - [Writing a custom train step with TensorFlow](/guides/custom_train_step_in_tensorflow/) -->
<!-- - [Writing a custom train step with JAX](/guides/custom_train_step_in_jax/) -->
<!-- - [Writing a custom train step with PyTorch](/guides/custom_train_step_in_torch/) -->
<p>Here, load the MNIST image data, reshape it into vectors, fit the
model on the data (while monitoring performance on a validation split),
then evaluate the model on the test data:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">x_train</span>, <span class="va">y_train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">x_test</span>, <span class="va">y_test</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/multi-assign.html">%&lt;-%</a></span> <span class="fu"><a href="../reference/dataset_mnist.html">dataset_mnist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/reticulate/reference/array_reshape.html" class="external-link">array_reshape</a></span><span class="op">(</span><span class="va">x_train</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">60000</span>, <span class="fl">784</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">255</span></span>
<span><span class="va">x_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/reticulate/reference/array_reshape.html" class="external-link">array_reshape</a></span><span class="op">(</span><span class="va">x_test</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10000</span>, <span class="fl">784</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">255</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html" class="external-link">compile</a></span><span class="op">(</span></span>
<span>  loss <span class="op">=</span> <span class="fu"><a href="../reference/loss_sparse_categorical_crossentropy.html">loss_sparse_categorical_crossentropy</a></span><span class="op">(</span>from_logits <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  optimizer <span class="op">=</span> <span class="fu"><a href="../reference/optimizer_rmsprop.html">optimizer_rmsprop</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  metrics <span class="op">=</span> <span class="st">"accuracy"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">history</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span></span>
<span>    <span class="va">x_train</span>, <span class="va">y_train</span>, batch_size <span class="op">=</span> <span class="fl">64</span>, epochs <span class="op">=</span> <span class="fl">2</span>, validation_split <span class="op">=</span> <span class="fl">0.2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Epoch 1/2</span></span>
<span><span class="co">## 750/750 - 2s - 3ms/step - accuracy: 0.8980 - loss: 0.3540 - val_accuracy: 0.9444 - val_loss: 0.1898</span></span>
<span><span class="co">## Epoch 2/2</span></span>
<span><span class="co">## 750/750 - 1s - 1ms/step - accuracy: 0.9512 - loss: 0.1633 - val_accuracy: 0.9605 - val_loss: 0.1387</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_scores</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/evaluate.html" class="external-link">evaluate</a></span><span class="op">(</span><span class="va">x_test</span>, <span class="va">y_test</span>, verbose<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 313/313 - 1s - 2ms/step - accuracy: 0.9598 - loss: 0.1322</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Test loss:"</span>, <span class="va">test_scores</span><span class="op">$</span><span class="va">loss</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Test accuracy:"</span>, <span class="va">test_scores</span><span class="op">$</span><span class="va">accuracy</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Test loss: 0.1321879</span></span>
<span><span class="co">## Test accuracy: 0.9598</span></span></code></pre>
<p>For further reading, see the <a href="training_with_built_in_methods.html">training and evaluation</a>
guide.</p>
</div>
<div class="section level2">
<h2 id="save-and-serialize">Save and serialize<a class="anchor" aria-label="anchor" href="#save-and-serialize"></a>
</h2>
<p>Saving the model and serialization work the same way for models built
using the functional API as they do for <code>Sequential</code> models.
The standard way to save a functional model is to call
<code>model.save()</code> to save the entire model as a single file. You
can later recreate the same model from this file, even if the code that
built the model is no longer available.</p>
<p>This saved file includes the: - model architecture - model weight
values (that were learned during training) - model training config, if
any (as passed to <code><a href="https://generics.r-lib.org/reference/compile.html" class="external-link">compile()</a></code>) - optimizer and its state, if
any (to restart training where you left off)</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/save_model.html">save_model</a></span><span class="op">(</span><span class="st">"my_model.keras"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="co"># Recreate the exact same model purely from the file:</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_model.html">load_model</a></span><span class="op">(</span><span class="st">"my_model.keras"</span><span class="op">)</span></span></code></pre></div>
<p>For details, read the model <a href="serialization_and_saving.html">serialization &amp; saving</a>
guide.</p>
</div>
<div class="section level2">
<h2 id="use-the-same-graph-of-layers-to-define-multiple-models">Use the same graph of layers to define multiple models<a class="anchor" aria-label="anchor" href="#use-the-same-graph-of-layers-to-define-multiple-models"></a>
</h2>
<p>In the functional API, models are created by specifying their inputs
and outputs in a graph of layers. That means that a single graph of
layers can be used to generate multiple models.</p>
<p>In the example below, you use the same stack of layers to instantiate
two models: an <code>encoder</code> model that turns image inputs into
16-dimensional vectors, and an end-to-end <code>autoencoder</code> model
for training.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">encoder_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">28</span>, <span class="fl">28</span>, <span class="fl">1</span><span class="op">)</span>, name<span class="op">=</span><span class="st">"img"</span><span class="op">)</span></span>
<span><span class="va">encoder_output</span> <span class="op">&lt;-</span> <span class="va">encoder_input</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_max_pooling_2d.html">layer_max_pooling_2d</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_global_max_pooling_2d.html">layer_global_max_pooling_2d</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">encoder</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">encoder_input</span>, <span class="va">encoder_output</span>, name<span class="op">=</span><span class="st">"encoder"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">encoder</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="font-weight: bold;">Model: "encoder"</span></span></span>
<span><span class="co">## ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓</span></span>
<span><span class="co">## ┃<span style="font-weight: bold;"> Layer (type)                    </span>┃<span style="font-weight: bold;"> Output Shape           </span>┃<span style="font-weight: bold;">       Param # </span>┃</span></span>
<span><span class="co">## ┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩</span></span>
<span><span class="co">## │ img (<span style="color: #0087FF;">InputLayer</span>)                │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">28</span>, <span style="color: #00AF00;">28</span>, <span style="color: #00AF00;">1</span>)      │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d (<span style="color: #0087FF;">Conv2D</span>)                 │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">26</span>, <span style="color: #00AF00;">26</span>, <span style="color: #00AF00;">16</span>)     │           <span style="color: #00AF00;">160</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_1 (<span style="color: #0087FF;">Conv2D</span>)               │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">24</span>, <span style="color: #00AF00;">24</span>, <span style="color: #00AF00;">32</span>)     │         <span style="color: #00AF00;">4,640</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ max_pooling2d (<span style="color: #0087FF;">MaxPooling2D</span>)    │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">8</span>, <span style="color: #00AF00;">8</span>, <span style="color: #00AF00;">32</span>)       │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_2 (<span style="color: #0087FF;">Conv2D</span>)               │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">6</span>, <span style="color: #00AF00;">6</span>, <span style="color: #00AF00;">32</span>)       │         <span style="color: #00AF00;">9,248</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_3 (<span style="color: #0087FF;">Conv2D</span>)               │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">4</span>, <span style="color: #00AF00;">4</span>, <span style="color: #00AF00;">16</span>)       │         <span style="color: #00AF00;">4,624</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ global_max_pooling2d            │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">16</span>)             │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## │ (<span style="color: #0087FF;">GlobalMaxPooling2D</span>)            │                        │               │</span></span>
<span><span class="co">## └─────────────────────────────────┴────────────────────────┴───────────────┘</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Total params: </span><span style="color: #00AF00;">18,672</span> (72.94 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Trainable params: </span><span style="color: #00AF00;">18,672</span> (72.94 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Non-trainable params: </span><span style="color: #00AF00;">0</span> (0.00 B)</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">decoder_output</span> <span class="op">&lt;-</span> <span class="va">encoder_output</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_reshape.html">layer_reshape</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_upsampling_2d.html">layer_upsampling_2d</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">autoencoder</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">encoder_input</span>, <span class="va">decoder_output</span>, name<span class="op">=</span><span class="st">"autoencoder"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">autoencoder</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="font-weight: bold;">Model: "autoencoder"</span></span></span>
<span><span class="co">## ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓</span></span>
<span><span class="co">## ┃<span style="font-weight: bold;"> Layer (type)                    </span>┃<span style="font-weight: bold;"> Output Shape           </span>┃<span style="font-weight: bold;">       Param # </span>┃</span></span>
<span><span class="co">## ┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩</span></span>
<span><span class="co">## │ img (<span style="color: #0087FF;">InputLayer</span>)                │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">28</span>, <span style="color: #00AF00;">28</span>, <span style="color: #00AF00;">1</span>)      │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d (<span style="color: #0087FF;">Conv2D</span>)                 │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">26</span>, <span style="color: #00AF00;">26</span>, <span style="color: #00AF00;">16</span>)     │           <span style="color: #00AF00;">160</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_1 (<span style="color: #0087FF;">Conv2D</span>)               │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">24</span>, <span style="color: #00AF00;">24</span>, <span style="color: #00AF00;">32</span>)     │         <span style="color: #00AF00;">4,640</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ max_pooling2d (<span style="color: #0087FF;">MaxPooling2D</span>)    │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">8</span>, <span style="color: #00AF00;">8</span>, <span style="color: #00AF00;">32</span>)       │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_2 (<span style="color: #0087FF;">Conv2D</span>)               │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">6</span>, <span style="color: #00AF00;">6</span>, <span style="color: #00AF00;">32</span>)       │         <span style="color: #00AF00;">9,248</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_3 (<span style="color: #0087FF;">Conv2D</span>)               │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">4</span>, <span style="color: #00AF00;">4</span>, <span style="color: #00AF00;">16</span>)       │         <span style="color: #00AF00;">4,624</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ global_max_pooling2d            │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">16</span>)             │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## │ (<span style="color: #0087FF;">GlobalMaxPooling2D</span>)            │                        │               │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ reshape (<span style="color: #0087FF;">Reshape</span>)               │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">4</span>, <span style="color: #00AF00;">4</span>, <span style="color: #00AF00;">1</span>)        │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_transpose                │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">6</span>, <span style="color: #00AF00;">6</span>, <span style="color: #00AF00;">16</span>)       │           <span style="color: #00AF00;">160</span> │</span></span>
<span><span class="co">## │ (<span style="color: #0087FF;">Conv2DTranspose</span>)               │                        │               │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_transpose_1              │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">8</span>, <span style="color: #00AF00;">8</span>, <span style="color: #00AF00;">32</span>)       │         <span style="color: #00AF00;">4,640</span> │</span></span>
<span><span class="co">## │ (<span style="color: #0087FF;">Conv2DTranspose</span>)               │                        │               │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ up_sampling2d (<span style="color: #0087FF;">UpSampling2D</span>)    │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">24</span>, <span style="color: #00AF00;">24</span>, <span style="color: #00AF00;">32</span>)     │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_transpose_2              │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">26</span>, <span style="color: #00AF00;">26</span>, <span style="color: #00AF00;">16</span>)     │         <span style="color: #00AF00;">4,624</span> │</span></span>
<span><span class="co">## │ (<span style="color: #0087FF;">Conv2DTranspose</span>)               │                        │               │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_transpose_3              │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">28</span>, <span style="color: #00AF00;">28</span>, <span style="color: #00AF00;">1</span>)      │           <span style="color: #00AF00;">145</span> │</span></span>
<span><span class="co">## │ (<span style="color: #0087FF;">Conv2DTranspose</span>)               │                        │               │</span></span>
<span><span class="co">## └─────────────────────────────────┴────────────────────────┴───────────────┘</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Total params: </span><span style="color: #00AF00;">28,241</span> (110.32 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Trainable params: </span><span style="color: #00AF00;">28,241</span> (110.32 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Non-trainable params: </span><span style="color: #00AF00;">0</span> (0.00 B)</span></span></code></pre>
<p>Here, the decoding architecture is strictly symmetrical to the
encoding architecture, so the output shape is the same as the input
shape <code>(28, 28, 1)</code>.</p>
<p>The reverse of a <code>conv_2d</code> layer is a
<code>conv_2d_transpose</code> layer, and the reverse of a
<code>max_pooling_2d</code> layer is an <code>upsampling_2d</code>
layer.</p>
</div>
<div class="section level2">
<h2 id="all-models-are-callable-just-like-layers">All models are callable, just like layers<a class="anchor" aria-label="anchor" href="#all-models-are-callable-just-like-layers"></a>
</h2>
<p>You can treat any model as if it were a layer by invoking it on an
<code>Input</code> or on the output of another layer. By calling a model
you aren’t just reusing the architecture of the model, you’re also
reusing its weights.</p>
<p>To see this in action, here’s a different take on the autoencoder
example that creates an encoder model, a decoder model, and chains them
in two calls to obtain the autoencoder model:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">encoder_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">28</span>, <span class="fl">28</span>, <span class="fl">1</span><span class="op">)</span>, name<span class="op">=</span><span class="st">"img"</span><span class="op">)</span></span>
<span><span class="va">encoder_output</span> <span class="op">&lt;-</span> <span class="va">encoder_input</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_max_pooling_2d.html">layer_max_pooling_2d</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_global_max_pooling_2d.html">layer_global_max_pooling_2d</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">encoder</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">encoder_input</span>, <span class="va">encoder_output</span>, name<span class="op">=</span><span class="st">"encoder"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">encoder</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="font-weight: bold;">Model: "encoder"</span></span></span>
<span><span class="co">## ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓</span></span>
<span><span class="co">## ┃<span style="font-weight: bold;"> Layer (type)                    </span>┃<span style="font-weight: bold;"> Output Shape           </span>┃<span style="font-weight: bold;">       Param # </span>┃</span></span>
<span><span class="co">## ┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩</span></span>
<span><span class="co">## │ img (<span style="color: #0087FF;">InputLayer</span>)                │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">28</span>, <span style="color: #00AF00;">28</span>, <span style="color: #00AF00;">1</span>)      │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_4 (<span style="color: #0087FF;">Conv2D</span>)               │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">26</span>, <span style="color: #00AF00;">26</span>, <span style="color: #00AF00;">16</span>)     │           <span style="color: #00AF00;">160</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_5 (<span style="color: #0087FF;">Conv2D</span>)               │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">24</span>, <span style="color: #00AF00;">24</span>, <span style="color: #00AF00;">32</span>)     │         <span style="color: #00AF00;">4,640</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ max_pooling2d_1 (<span style="color: #0087FF;">MaxPooling2D</span>)  │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">8</span>, <span style="color: #00AF00;">8</span>, <span style="color: #00AF00;">32</span>)       │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_6 (<span style="color: #0087FF;">Conv2D</span>)               │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">6</span>, <span style="color: #00AF00;">6</span>, <span style="color: #00AF00;">32</span>)       │         <span style="color: #00AF00;">9,248</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_7 (<span style="color: #0087FF;">Conv2D</span>)               │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">4</span>, <span style="color: #00AF00;">4</span>, <span style="color: #00AF00;">16</span>)       │         <span style="color: #00AF00;">4,624</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ global_max_pooling2d_1          │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">16</span>)             │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## │ (<span style="color: #0087FF;">GlobalMaxPooling2D</span>)            │                        │               │</span></span>
<span><span class="co">## └─────────────────────────────────┴────────────────────────┴───────────────┘</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Total params: </span><span style="color: #00AF00;">18,672</span> (72.94 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Trainable params: </span><span style="color: #00AF00;">18,672</span> (72.94 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Non-trainable params: </span><span style="color: #00AF00;">0</span> (0.00 B)</span></span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">decoder_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">16</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"encoded_img"</span><span class="op">)</span></span>
<span><span class="va">decoder_output</span> <span class="op">&lt;-</span> <span class="va">decoder_input</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_reshape.html">layer_reshape</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_upsampling_2d.html">layer_upsampling_2d</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d_transpose.html">layer_conv_2d_transpose</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">decoder</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">decoder_input</span>, <span class="va">decoder_output</span>, name <span class="op">=</span> <span class="st">"decoder"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">decoder</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="font-weight: bold;">Model: "decoder"</span></span></span>
<span><span class="co">## ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓</span></span>
<span><span class="co">## ┃<span style="font-weight: bold;"> Layer (type)                    </span>┃<span style="font-weight: bold;"> Output Shape           </span>┃<span style="font-weight: bold;">       Param # </span>┃</span></span>
<span><span class="co">## ┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩</span></span>
<span><span class="co">## │ encoded_img (<span style="color: #0087FF;">InputLayer</span>)        │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">16</span>)             │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ reshape_1 (<span style="color: #0087FF;">Reshape</span>)             │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">4</span>, <span style="color: #00AF00;">4</span>, <span style="color: #00AF00;">1</span>)        │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_transpose_4              │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">6</span>, <span style="color: #00AF00;">6</span>, <span style="color: #00AF00;">16</span>)       │           <span style="color: #00AF00;">160</span> │</span></span>
<span><span class="co">## │ (<span style="color: #0087FF;">Conv2DTranspose</span>)               │                        │               │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_transpose_5              │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">8</span>, <span style="color: #00AF00;">8</span>, <span style="color: #00AF00;">32</span>)       │         <span style="color: #00AF00;">4,640</span> │</span></span>
<span><span class="co">## │ (<span style="color: #0087FF;">Conv2DTranspose</span>)               │                        │               │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ up_sampling2d_1 (<span style="color: #0087FF;">UpSampling2D</span>)  │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">24</span>, <span style="color: #00AF00;">24</span>, <span style="color: #00AF00;">32</span>)     │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_transpose_6              │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">26</span>, <span style="color: #00AF00;">26</span>, <span style="color: #00AF00;">16</span>)     │         <span style="color: #00AF00;">4,624</span> │</span></span>
<span><span class="co">## │ (<span style="color: #0087FF;">Conv2DTranspose</span>)               │                        │               │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ conv2d_transpose_7              │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">28</span>, <span style="color: #00AF00;">28</span>, <span style="color: #00AF00;">1</span>)      │           <span style="color: #00AF00;">145</span> │</span></span>
<span><span class="co">## │ (<span style="color: #0087FF;">Conv2DTranspose</span>)               │                        │               │</span></span>
<span><span class="co">## └─────────────────────────────────┴────────────────────────┴───────────────┘</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Total params: </span><span style="color: #00AF00;">9,569</span> (37.38 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Trainable params: </span><span style="color: #00AF00;">9,569</span> (37.38 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Non-trainable params: </span><span style="color: #00AF00;">0</span> (0.00 B)</span></span></code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">autoencoder_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">28</span>, <span class="fl">28</span>, <span class="fl">1</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"img"</span><span class="op">)</span></span>
<span><span class="va">encoded_img</span> <span class="op">&lt;-</span> <span class="fu">encoder</span><span class="op">(</span><span class="va">autoencoder_input</span><span class="op">)</span></span>
<span><span class="va">decoded_img</span> <span class="op">&lt;-</span> <span class="fu">decoder</span><span class="op">(</span><span class="va">encoded_img</span><span class="op">)</span></span>
<span><span class="va">autoencoder</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">autoencoder_input</span>, <span class="va">decoded_img</span>,</span>
<span>                           name <span class="op">=</span> <span class="st">"autoencoder"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">autoencoder</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="font-weight: bold;">Model: "autoencoder"</span></span></span>
<span><span class="co">## ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓</span></span>
<span><span class="co">## ┃<span style="font-weight: bold;"> Layer (type)                    </span>┃<span style="font-weight: bold;"> Output Shape           </span>┃<span style="font-weight: bold;">       Param # </span>┃</span></span>
<span><span class="co">## ┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩</span></span>
<span><span class="co">## │ img (<span style="color: #0087FF;">InputLayer</span>)                │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">28</span>, <span style="color: #00AF00;">28</span>, <span style="color: #00AF00;">1</span>)      │             <span style="color: #00AF00;">0</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ encoder (<span style="color: #0087FF;">Functional</span>)            │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">16</span>)             │        <span style="color: #00AF00;">18,672</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ decoder (<span style="color: #0087FF;">Functional</span>)            │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">28</span>, <span style="color: #00AF00;">28</span>, <span style="color: #00AF00;">1</span>)      │         <span style="color: #00AF00;">9,569</span> │</span></span>
<span><span class="co">## └─────────────────────────────────┴────────────────────────┴───────────────┘</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Total params: </span><span style="color: #00AF00;">28,241</span> (110.32 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Trainable params: </span><span style="color: #00AF00;">28,241</span> (110.32 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Non-trainable params: </span><span style="color: #00AF00;">0</span> (0.00 B)</span></span></code></pre>
<p>As you can see, the model can be nested: a model can contain
sub-models (since a model is just like a layer). A common use case for
model nesting is <em>ensembling</em>. For example, here’s how to
ensemble a set of models into a single model that averages their
predictions:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fl">128</span><span class="op">)</span></span>
<span>  <span class="va">outputs</span> <span class="op">&lt;-</span> <span class="va">inputs</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">outputs</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">model1</span> <span class="op">&lt;-</span> <span class="fu">get_model</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model2</span> <span class="op">&lt;-</span> <span class="fu">get_model</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model3</span> <span class="op">&lt;-</span> <span class="fu">get_model</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fl">128</span><span class="op">)</span></span>
<span><span class="va">y1</span> <span class="op">&lt;-</span> <span class="fu">model1</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span></span>
<span><span class="va">y2</span> <span class="op">&lt;-</span> <span class="fu">model2</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span></span>
<span><span class="va">y3</span> <span class="op">&lt;-</span> <span class="fu">model3</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span></span>
<span><span class="va">outputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_average.html">layer_average</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y1</span>, <span class="va">y2</span>, <span class="va">y3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ensemble_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">inputs</span>, outputs <span class="op">=</span> <span class="va">outputs</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="manipulate-complex-graph-topologies">Manipulate complex graph topologies<a class="anchor" aria-label="anchor" href="#manipulate-complex-graph-topologies"></a>
</h2>
<div class="section level3">
<h3 id="models-with-multiple-inputs-and-outputs">Models with multiple inputs and outputs<a class="anchor" aria-label="anchor" href="#models-with-multiple-inputs-and-outputs"></a>
</h3>
<p>The functional API makes it easy to manipulate multiple inputs and
outputs. This cannot be handled with the <code>Sequential</code>
API.</p>
<p>For example, if you’re building a system for ranking customer issue
tickets by priority and routing them to the correct department, then the
model will have three inputs:</p>
<ul>
<li>the title of the ticket (text input),</li>
<li>the text body of the ticket (text input), and</li>
<li>any tags added by the user (categorical input)</li>
</ul>
<p>This model will have two outputs:</p>
<ul>
<li>the priority score between 0 and 1 (scalar sigmoid output), and</li>
<li>the department that should handle the ticket (softmax output over
the set of departments).</li>
</ul>
<p>You can build this model in a few lines with the functional API:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_tags</span> <span class="op">&lt;-</span> <span class="fl">12</span>  <span class="co"># Number of unique issue tags</span></span>
<span><span class="va">num_words</span> <span class="op">&lt;-</span> <span class="fl">10000</span>  <span class="co"># Size of vocabulary obtained when preprocessing text data</span></span>
<span><span class="va">num_departments</span> <span class="op">&lt;-</span> <span class="fl">4</span>  <span class="co"># Number of departments for predictions</span></span>
<span></span>
<span><span class="va">title_input</span> <span class="op">&lt;-</span> <span class="co"># Variable-length sequence of ints</span></span>
<span>  <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span><span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"title"</span><span class="op">)</span></span>
<span><span class="va">body_input</span> <span class="op">&lt;-</span>  <span class="co"># Variable-length sequence of ints</span></span>
<span>  <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span><span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"body"</span><span class="op">)</span></span>
<span><span class="va">tags_input</span> <span class="op">&lt;-</span>  <span class="co"># Binary vectors of size `num_tags`</span></span>
<span>  <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="va">num_tags</span>, name <span class="op">=</span> <span class="st">"tags"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Embed each word in the title into a 64-dimensional vector</span></span>
<span><span class="va">title_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_embedding.html">layer_embedding</a></span><span class="op">(</span><span class="va">title_input</span>, <span class="va">num_words</span>, <span class="fl">64</span><span class="op">)</span></span>
<span><span class="co"># Embed each word in the text into a 64-dimensional vector</span></span>
<span><span class="va">body_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_embedding.html">layer_embedding</a></span><span class="op">(</span><span class="va">body_input</span>, <span class="va">num_words</span>, <span class="fl">64</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Reduce sequence of embedded words in the title</span></span>
<span><span class="co"># into a single 128-dimensional vector</span></span>
<span><span class="va">title_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_lstm.html">layer_lstm</a></span><span class="op">(</span><span class="va">title_features</span>, <span class="fl">128</span><span class="op">)</span></span>
<span><span class="co"># Reduce sequence of embedded words in the body</span></span>
<span><span class="co"># into a single 32-dimensional vector</span></span>
<span><span class="va">body_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_lstm.html">layer_lstm</a></span><span class="op">(</span><span class="va">body_features</span>, <span class="fl">32</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge all available features into a single large vector via concatenation</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_concatenate.html">layer_concatenate</a></span><span class="op">(</span><span class="va">title_features</span>, <span class="va">body_features</span>, <span class="va">tags_input</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Stick a logistic regression for priority prediction on top of the features</span></span>
<span><span class="va">priority_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, name <span class="op">=</span> <span class="st">"priority"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Stick a department classifier on top of the features</span></span>
<span><span class="va">department_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">num_departments</span>, name <span class="op">=</span> <span class="st">"department"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Instantiate an end-to-end model predicting both priority and department</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span></span>
<span>  inputs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">title_input</span>, <span class="va">body_input</span>, <span class="va">tags_input</span><span class="op">)</span>,</span>
<span>  outputs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>priority <span class="op">=</span> <span class="va">priority_pred</span>, department <span class="op">=</span> <span class="va">department_pred</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now plot the model:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model</span>, show_shapes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="functional_api/unnamed-chunk-20-1.png" width="1637"></p>
<p>When compiling this model, you can assign different losses to each
output. You can even assign different weights to each loss – to modulate
their contribution to the total training loss.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html" class="external-link">compile</a></span><span class="op">(</span></span>
<span>  optimizer <span class="op">=</span> <span class="fu"><a href="../reference/optimizer_rmsprop.html">optimizer_rmsprop</a></span><span class="op">(</span><span class="fl">1e-3</span><span class="op">)</span>,</span>
<span>  loss <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/loss_binary_crossentropy.html">loss_binary_crossentropy</a></span><span class="op">(</span>from_logits <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/loss_categorical_crossentropy.html">loss_categorical_crossentropy</a></span><span class="op">(</span>from_logits <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  loss_weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.0</span>, <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Since the output layers have different names, you could also specify
the losses and loss weights with the corresponding layer names:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html" class="external-link">compile</a></span><span class="op">(</span></span>
<span>  optimizer <span class="op">=</span> <span class="fu"><a href="../reference/optimizer_rmsprop.html">optimizer_rmsprop</a></span><span class="op">(</span><span class="fl">1e-3</span><span class="op">)</span>,</span>
<span>  loss <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    priority <span class="op">=</span> <span class="fu"><a href="../reference/loss_binary_crossentropy.html">loss_binary_crossentropy</a></span><span class="op">(</span>from_logits <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    department <span class="op">=</span> <span class="fu"><a href="../reference/loss_categorical_crossentropy.html">loss_categorical_crossentropy</a></span><span class="op">(</span>from_logits <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  loss_weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>priority <span class="op">=</span> <span class="fl">1.0</span>, department <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Train the model by passing lists of NumPy arrays of inputs and
targets:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Dummy input data</span></span>
<span><span class="va">title_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_integer.html">random_integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1280</span>, <span class="fl">12</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">num_words</span><span class="op">)</span></span>
<span><span class="va">body_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_integer.html">random_integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1280</span>, <span class="fl">100</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">num_words</span><span class="op">)</span></span>
<span><span class="va">tags_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_integer.html">random_integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1280</span>, <span class="va">num_tags</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Dummy target data</span></span>
<span><span class="va">priority_targets</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_normal.html">random_normal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1280</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dept_targets</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_integer.html">random_integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1280</span>, <span class="va">num_departments</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>title <span class="op">=</span> <span class="va">title_data</span>, body <span class="op">=</span> <span class="va">body_data</span>, tags <span class="op">=</span> <span class="va">tags_data</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>priority <span class="op">=</span> <span class="va">priority_targets</span>, department <span class="op">=</span> <span class="va">dept_targets</span><span class="op">)</span>,</span>
<span>  epochs <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">32</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Epoch 1/2</span></span>
<span><span class="co">## 40/40 - 3s - 64ms/step - department_loss: 2.8465 - loss: 0.7669 - priority_loss: 0.1976</span></span>
<span><span class="co">## Epoch 2/2</span></span>
<span><span class="co">## 40/40 - 0s - 5ms/step - department_loss: 2.8554 - loss: 0.7538 - priority_loss: 0.1828</span></span></code></pre>
<p>When calling fit with a <code>Dataset</code> object, it should yield
either a list of lists like
<code>list(list(title_data, body_data, tags_data), list(priority_targets, dept_targets))</code>
or a list of named lists like
<code>list(list(title = title_data, body = body_data, tags = tags_data), list(priority = priority_targets, department = dept_targets))</code>.</p>
<p>For more detailed explanation, refer to the <a href="training_with_built_in_methods.html">training and evaluation</a>
guide.</p>
</div>
<div class="section level3">
<h3 id="a-toy-resnet-model">A toy ResNet model<a class="anchor" aria-label="anchor" href="#a-toy-resnet-model"></a>
</h3>
<p>In addition to models with multiple inputs and outputs, the
functional API makes it easy to manipulate non-linear connectivity
topologies – these are models with layers that are not connected
sequentially, which the <code>Sequential</code> API cannot handle.</p>
<p>A common use case for this is residual connections. Let’s build a toy
ResNet model for CIFAR10 to demonstrate this:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">32</span>, <span class="fl">3</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"img"</span><span class="op">)</span></span>
<span><span class="va">block_1_output</span> <span class="op">&lt;-</span> <span class="va">inputs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span><span class="fl">32</span>, kernel_size <span class="op">=</span> <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span><span class="fl">64</span>, kernel_size <span class="op">=</span> <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_max_pooling_2d.html">layer_max_pooling_2d</a></span><span class="op">(</span>pool_size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">block_2_output</span> <span class="op">&lt;-</span> <span class="va">block_1_output</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span><span class="fl">32</span>, kernel_size <span class="op">=</span> <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, padding <span class="op">=</span> <span class="st">"same"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span><span class="fl">64</span>, kernel_size <span class="op">=</span> <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, padding <span class="op">=</span> <span class="st">"same"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_add.html">layer_add</a></span><span class="op">(</span><span class="va">block_1_output</span><span class="op">)</span></span>
<span></span>
<span><span class="va">block_3_output</span> <span class="op">&lt;-</span> <span class="va">block_2_output</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span><span class="fl">64</span>, kernel_size <span class="op">=</span> <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, padding <span class="op">=</span> <span class="st">"same"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span><span class="fl">64</span>, kernel_size <span class="op">=</span> <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, padding <span class="op">=</span> <span class="st">"same"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_add.html">layer_add</a></span><span class="op">(</span><span class="va">block_2_output</span><span class="op">)</span></span>
<span></span>
<span><span class="va">outputs</span> <span class="op">&lt;-</span> <span class="va">block_3_output</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_2d.html">layer_conv_2d</a></span><span class="op">(</span><span class="fl">64</span>, <span class="fl">3</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_global_average_pooling_2d.html">layer_global_average_pooling_2d</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">256</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">outputs</span>, name <span class="op">=</span> <span class="st">"toy_resnet"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="font-weight: bold;">Model: "toy_resnet"</span></span></span>
<span><span class="co">## ┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓</span></span>
<span><span class="co">## ┃<span style="font-weight: bold;"> Layer (type)        </span>┃<span style="font-weight: bold;"> Output Shape      </span>┃<span style="font-weight: bold;">    Param # </span>┃<span style="font-weight: bold;"> Connected to      </span>┃</span></span>
<span><span class="co">## ┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩</span></span>
<span><span class="co">## │ img (<span style="color: #0087FF;">InputLayer</span>)    │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">32</span>, <span style="color: #00AF00;">32</span>, <span style="color: #00AF00;">3</span>) │          <span style="color: #00AF00;">0</span> │ -                 │</span></span>
<span><span class="co">## ├─────────────────────┼───────────────────┼────────────┼───────────────────┤</span></span>
<span><span class="co">## │ conv2d_8 (<span style="color: #0087FF;">Conv2D</span>)   │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">30</span>, <span style="color: #00AF00;">30</span>,    │        <span style="color: #00AF00;">896</span> │ img[<span style="color: #00AF00;">0</span>][<span style="color: #00AF00;">0</span>]         │</span></span>
<span><span class="co">## │                     │ <span style="color: #00AF00;">32</span>)               │            │                   │</span></span>
<span><span class="co">## ├─────────────────────┼───────────────────┼────────────┼───────────────────┤</span></span>
<span><span class="co">## │ conv2d_9 (<span style="color: #0087FF;">Conv2D</span>)   │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">28</span>, <span style="color: #00AF00;">28</span>,    │     <span style="color: #00AF00;">18,496</span> │ conv2d_8[<span style="color: #00AF00;">0</span>][<span style="color: #00AF00;">0</span>]    │</span></span>
<span><span class="co">## │                     │ <span style="color: #00AF00;">64</span>)               │            │                   │</span></span>
<span><span class="co">## ├─────────────────────┼───────────────────┼────────────┼───────────────────┤</span></span>
<span><span class="co">## │ max_pooling2d_2     │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">9</span>, <span style="color: #00AF00;">9</span>, <span style="color: #00AF00;">64</span>)  │          <span style="color: #00AF00;">0</span> │ conv2d_9[<span style="color: #00AF00;">0</span>][<span style="color: #00AF00;">0</span>]    │</span></span>
<span><span class="co">## │ (<span style="color: #0087FF;">MaxPooling2D</span>)      │                   │            │                   │</span></span>
<span><span class="co">## ├─────────────────────┼───────────────────┼────────────┼───────────────────┤</span></span>
<span><span class="co">## │ conv2d_10 (<span style="color: #0087FF;">Conv2D</span>)  │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">9</span>, <span style="color: #00AF00;">9</span>, <span style="color: #00AF00;">32</span>)  │     <span style="color: #00AF00;">18,464</span> │ max_pooling2d_2[<span style="color: #00AF00;">…</span> │</span></span>
<span><span class="co">## ├─────────────────────┼───────────────────┼────────────┼───────────────────┤</span></span>
<span><span class="co">## │ conv2d_11 (<span style="color: #0087FF;">Conv2D</span>)  │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">9</span>, <span style="color: #00AF00;">9</span>, <span style="color: #00AF00;">64</span>)  │     <span style="color: #00AF00;">18,496</span> │ conv2d_10[<span style="color: #00AF00;">0</span>][<span style="color: #00AF00;">0</span>]   │</span></span>
<span><span class="co">## ├─────────────────────┼───────────────────┼────────────┼───────────────────┤</span></span>
<span><span class="co">## │ add (<span style="color: #0087FF;">Add</span>)           │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">9</span>, <span style="color: #00AF00;">9</span>, <span style="color: #00AF00;">64</span>)  │          <span style="color: #00AF00;">0</span> │ conv2d_11[<span style="color: #00AF00;">0</span>][<span style="color: #00AF00;">0</span>],  │</span></span>
<span><span class="co">## │                     │                   │            │ max_pooling2d_2[<span style="color: #00AF00;">…</span> │</span></span>
<span><span class="co">## ├─────────────────────┼───────────────────┼────────────┼───────────────────┤</span></span>
<span><span class="co">## │ conv2d_12 (<span style="color: #0087FF;">Conv2D</span>)  │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">9</span>, <span style="color: #00AF00;">9</span>, <span style="color: #00AF00;">64</span>)  │     <span style="color: #00AF00;">36,928</span> │ add[<span style="color: #00AF00;">0</span>][<span style="color: #00AF00;">0</span>]         │</span></span>
<span><span class="co">## ├─────────────────────┼───────────────────┼────────────┼───────────────────┤</span></span>
<span><span class="co">## │ conv2d_13 (<span style="color: #0087FF;">Conv2D</span>)  │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">9</span>, <span style="color: #00AF00;">9</span>, <span style="color: #00AF00;">64</span>)  │     <span style="color: #00AF00;">36,928</span> │ conv2d_12[<span style="color: #00AF00;">0</span>][<span style="color: #00AF00;">0</span>]   │</span></span>
<span><span class="co">## ├─────────────────────┼───────────────────┼────────────┼───────────────────┤</span></span>
<span><span class="co">## │ add_1 (<span style="color: #0087FF;">Add</span>)         │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">9</span>, <span style="color: #00AF00;">9</span>, <span style="color: #00AF00;">64</span>)  │          <span style="color: #00AF00;">0</span> │ conv2d_13[<span style="color: #00AF00;">0</span>][<span style="color: #00AF00;">0</span>],  │</span></span>
<span><span class="co">## │                     │                   │            │ add[<span style="color: #00AF00;">0</span>][<span style="color: #00AF00;">0</span>]         │</span></span>
<span><span class="co">## ├─────────────────────┼───────────────────┼────────────┼───────────────────┤</span></span>
<span><span class="co">## │ conv2d_14 (<span style="color: #0087FF;">Conv2D</span>)  │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">7</span>, <span style="color: #00AF00;">7</span>, <span style="color: #00AF00;">64</span>)  │     <span style="color: #00AF00;">36,928</span> │ add_1[<span style="color: #00AF00;">0</span>][<span style="color: #00AF00;">0</span>]       │</span></span>
<span><span class="co">## ├─────────────────────┼───────────────────┼────────────┼───────────────────┤</span></span>
<span><span class="co">## │ global_average_poo… │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">64</span>)        │          <span style="color: #00AF00;">0</span> │ conv2d_14[<span style="color: #00AF00;">0</span>][<span style="color: #00AF00;">0</span>]   │</span></span>
<span><span class="co">## │ (<span style="color: #0087FF;">GlobalAveragePool…</span> │                   │            │                   │</span></span>
<span><span class="co">## ├─────────────────────┼───────────────────┼────────────┼───────────────────┤</span></span>
<span><span class="co">## │ dense_6 (<span style="color: #0087FF;">Dense</span>)     │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">256</span>)       │     <span style="color: #00AF00;">16,640</span> │ global_average_p… │</span></span>
<span><span class="co">## ├─────────────────────┼───────────────────┼────────────┼───────────────────┤</span></span>
<span><span class="co">## │ dropout (<span style="color: #0087FF;">Dropout</span>)   │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">256</span>)       │          <span style="color: #00AF00;">0</span> │ dense_6[<span style="color: #00AF00;">0</span>][<span style="color: #00AF00;">0</span>]     │</span></span>
<span><span class="co">## ├─────────────────────┼───────────────────┼────────────┼───────────────────┤</span></span>
<span><span class="co">## │ dense_7 (<span style="color: #0087FF;">Dense</span>)     │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">10</span>)        │      <span style="color: #00AF00;">2,570</span> │ dropout[<span style="color: #00AF00;">0</span>][<span style="color: #00AF00;">0</span>]     │</span></span>
<span><span class="co">## └─────────────────────┴───────────────────┴────────────┴───────────────────┘</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Total params: </span><span style="color: #00AF00;">186,346</span> (727.91 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Trainable params: </span><span style="color: #00AF00;">186,346</span> (727.91 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Non-trainable params: </span><span style="color: #00AF00;">0</span> (0.00 B)</span></span></code></pre>
<p>Plot the model:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model</span>, show_shapes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="functional_api/unnamed-chunk-25-1.png" width="953"></p>
<p>Now train the model:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">x_train</span>, <span class="va">y_train</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">x_test</span>, <span class="va">y_test</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/multi-assign.html">%&lt;-%</a></span> <span class="fu"><a href="../reference/dataset_cifar10.html">dataset_cifar10</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x_train</span> <span class="op">&lt;-</span> <span class="va">x_train</span> <span class="op">/</span> <span class="fl">255.0</span></span>
<span><span class="va">x_test</span> <span class="op">&lt;-</span> <span class="va">x_test</span> <span class="op">/</span> <span class="fl">255.0</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html" class="external-link">compile</a></span><span class="op">(</span></span>
<span>  optimizer <span class="op">=</span> <span class="fu"><a href="../reference/optimizer_rmsprop.html">optimizer_rmsprop</a></span><span class="op">(</span><span class="fl">1e-3</span><span class="op">)</span>,</span>
<span>  loss <span class="op">=</span> <span class="fu"><a href="../reference/loss_sparse_categorical_crossentropy.html">loss_sparse_categorical_crossentropy</a></span><span class="op">(</span>from_logits <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  metrics <span class="op">=</span> <span class="st">"acc"</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># We restrict the data to the first 1000 samples so as to limit the</span></span>
<span><span class="co"># guide render time.</span></span>
<span><span class="co"># Try to train on the entire dataset until convergence!</span></span>
<span><span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span></span>
<span>  <span class="va">x_train</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>, , , <span class="op">]</span>,</span>
<span>  <span class="va">y_train</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>, <span class="op">]</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">64</span>,</span>
<span>  epochs <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  validation_split <span class="op">=</span> <span class="fl">0.2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 13/13 - 6s - 430ms/step - acc: 0.1250 - loss: 2.2998 - val_acc: 0.1250 - val_loss: 2.2939</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="shared-layers">Shared layers<a class="anchor" aria-label="anchor" href="#shared-layers"></a>
</h2>
<p>Another good use for the functional API are models that use
<em>shared layers</em>. Shared layers are layer instances that are
reused multiple times in the same model – they learn features that
correspond to multiple paths in the graph-of-layers.</p>
<p>Shared layers are often used to encode inputs from similar spaces
(say, two different pieces of text that feature similar vocabulary).
They enable sharing of information across these different inputs, and
they make it possible to train such a model on less data. If a given
word is seen in one of the inputs, that will benefit the processing of
all inputs that pass through the shared layer.</p>
<p>To share a layer in the functional API, call the same layer instance
multiple times. For instance, here’s an <code>Embedding</code> layer
shared across two different text inputs:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Embedding for 1000 unique words mapped to 128-dimensional vectors</span></span>
<span><span class="va">shared_embedding</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_embedding.html">layer_embedding</a></span><span class="op">(</span>input_dim <span class="op">=</span> <span class="fl">1000</span>, output_dim <span class="op">=</span> <span class="fl">128</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Variable-length sequence of integers</span></span>
<span><span class="va">text_input_a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>, dtype<span class="op">=</span><span class="st">"int32"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Variable-length sequence of integers</span></span>
<span><span class="va">text_input_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>, dtype<span class="op">=</span><span class="st">"int32"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Reuse the same layer to encode both inputs</span></span>
<span><span class="va">encoded_input_a</span> <span class="op">&lt;-</span> <span class="fu">shared_embedding</span><span class="op">(</span><span class="va">text_input_a</span><span class="op">)</span></span>
<span><span class="va">encoded_input_b</span> <span class="op">&lt;-</span> <span class="fu">shared_embedding</span><span class="op">(</span><span class="va">text_input_b</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="extract-and-reuse-nodes-in-the-graph-of-layers">Extract and reuse nodes in the graph of layers<a class="anchor" aria-label="anchor" href="#extract-and-reuse-nodes-in-the-graph-of-layers"></a>
</h2>
<p>Because the graph of layers you are manipulating is a static data
structure, it can be accessed and inspected. And this is how you are
able to plot functional models as images.</p>
<p>This also means that you can access the activations of intermediate
layers (“nodes” in the graph) and reuse them elsewhere – which is very
useful for something like feature extraction.</p>
<p>Let’s look at an example. This is a VGG19 model with weights
pretrained on ImageNet:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vgg19</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/application_vgg19.html">application_vgg19</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>And these are the intermediate activations of the model, obtained by
querying the graph data structure:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">features_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">vgg19</span><span class="op">$</span><span class="va">layers</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">output</span><span class="op">)</span></span></code></pre></div>
<p>Use these features to create a new feature-extraction model that
returns the values of the intermediate layer activations:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">feat_extraction_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">vgg19</span><span class="op">$</span><span class="va">input</span>,</span>
<span>                                     outputs <span class="op">=</span> <span class="va">features_list</span><span class="op">)</span></span>
<span></span>
<span><span class="va">img</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_normal.html">random_normal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">224</span>, <span class="fl">224</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">extracted_features</span> <span class="op">&lt;-</span> <span class="fu">feat_extraction_model</span><span class="op">(</span><span class="va">img</span><span class="op">)</span></span></code></pre></div>
<p>This comes in handy for tasks like <a href="https://keras.io/examples/generative/neural_style_transfer/" class="external-link">neural
style transfer</a>, among other things.</p>
</div>
<div class="section level2">
<h2 id="extend-the-api-using-custom-layers">Extend the API using custom layers<a class="anchor" aria-label="anchor" href="#extend-the-api-using-custom-layers"></a>
</h2>
<p><code>keras</code> includes a wide range of built-in layers, for
example:</p>
<ul>
<li>Convolutional layers: <code>conv_1d</code>, <code>conv_2d</code>,
<code>conv_3d</code>, <code>conv_2d_transpose</code>
</li>
<li>Pooling layers: <code>max_pooling_1d</code>,
<code>max_pooling_2d</code>, <code>max_pooling_3d</code>,
<code>average_pooling_3d</code>
</li>
<li>RNN layers: <code>gru</code>, <code>lstm</code>,
<code>conv_lstm_2d</code>
</li>
<li>
<code>batch_normalization</code>, <code>dropout</code>,
<code>embedding</code>, etc.</li>
</ul>
<p>But if you don’t find what you need, it’s easy to extend the API by
creating your own layers. All layers subclass the <code>Layer</code>
class and implement:</p>
<ul>
<li>
<code>call</code> method, that specifies the computation done by the
layer.</li>
<li>
<code>build</code> method, that creates the weights of the layer
(this is just a style convention since you can create weights in
<code>initialize</code>, as well).</li>
</ul>
<p>To learn more about creating layers from scratch, read <a href="making_new_layers_and_models_via_subclassing.html">custom layers
and models</a> guide.</p>
<p>The following is a basic implementation of
<code><a href="../reference/layer_dense.html">layer_dense()</a></code>:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_dense</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Layer.html">Layer</a></span><span class="op">(</span></span>
<span>  classname <span class="op">=</span> <span class="st">"CustomDense"</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">units</span> <span class="op">=</span> <span class="fl">32</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">units</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">units</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  build <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">input_shape</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">w</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">add_weight</span><span class="op">(</span></span>
<span>      shape <span class="op">=</span> <span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="va">input_shape</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">self</span><span class="op">$</span><span class="va">units</span><span class="op">)</span>,</span>
<span>      initializer <span class="op">=</span> <span class="st">"random_normal"</span>,</span>
<span>      trainable <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">b</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">add_weight</span><span class="op">(</span></span>
<span>      shape <span class="op">=</span> <span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">units</span><span class="op">)</span>,</span>
<span>            initializer<span class="op">=</span><span class="st">"random_normal"</span>,</span>
<span>      trainable <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>        <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  call <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/op_matmul.html">op_matmul</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">self</span><span class="op">$</span><span class="va">w</span><span class="op">)</span> <span class="op">+</span> <span class="va">self</span><span class="op">$</span><span class="va">b</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">outputs</span> <span class="op">&lt;-</span> <span class="fu">custom_dense</span><span class="op">(</span><span class="va">inputs</span>, <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">outputs</span><span class="op">)</span></span></code></pre></div>
<p>For serialization support in your custom layer, define a
<code><a href="../reference/get_config.html">get_config()</a></code> method that returns the constructor arguments
of the layer instance:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_dense</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Layer.html">Layer</a></span><span class="op">(</span></span>
<span>  classname <span class="op">=</span> <span class="st">"CustomDense"</span>,</span>
<span></span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">units</span> <span class="op">=</span> <span class="fl">32</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">units</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">units</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  build <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">input_shape</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">w</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">add_weight</span><span class="op">(</span></span>
<span>      shape <span class="op">=</span> <span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="va">input_shape</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">self</span><span class="op">$</span><span class="va">units</span><span class="op">)</span>,</span>
<span>      initializer <span class="op">=</span> <span class="st">"random_normal"</span>,</span>
<span>      trainable <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">b</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">add_weight</span><span class="op">(</span></span>
<span>      shape <span class="op">=</span> <span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">units</span><span class="op">)</span>,</span>
<span>            initializer<span class="op">=</span><span class="st">"random_normal"</span>,</span>
<span>      trainable <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>        <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  call <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/op_matmul.html">op_matmul</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">self</span><span class="op">$</span><span class="va">w</span><span class="op">)</span> <span class="op">+</span> <span class="va">self</span><span class="op">$</span><span class="va">b</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  get_config <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">units</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">outputs</span> <span class="op">&lt;-</span> <span class="fu">custom_dense</span><span class="op">(</span><span class="va">inputs</span>, <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">outputs</span><span class="op">)</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_config.html">get_config</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">new_model</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/get_config.html">from_config</a></span><span class="op">(</span><span class="va">config</span>, custom_objects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>CustomDense <span class="op">=</span> <span class="va">custom_dense</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Optionally, implement the class method
<code>from_config(cls, config)</code> which is used when recreating a
layer instance given its config dictionary. The default implementation
of <code>from_config</code> is:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">from_config</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cls</span>, <span class="va">config</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cls</span>, <span class="va">config</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="when-to-use-the-functional-api">When to use the functional API<a class="anchor" aria-label="anchor" href="#when-to-use-the-functional-api"></a>
</h2>
<p>Should you use the Keras functional API to create a new model, or
just subclass the <code>Model</code> class directly? In general, the
functional API is higher-level, easier and safer, and has a number of
features that subclassed models do not support.</p>
<p>However, model subclassing provides greater flexibility when building
models that are not easily expressible as directed acyclic graphs of
layers. For example, you could not implement a Tree-RNN with the
functional API and would have to subclass <code>Model</code>
directly.</p>
<p>For an in-depth look at the differences between the functional API
and model subclassing, read <a href="https://blog.tensorflow.org/2019/01/what-are-symbolic-and-imperative-apis.html" class="external-link">What
are Symbolic and Imperative APIs in TensorFlow 2.0?</a>.</p>
<div class="section level3">
<h3 id="functional-api-strengths">Functional API strengths:<a class="anchor" aria-label="anchor" href="#functional-api-strengths"></a>
</h3>
<p>The following properties are also true for Sequential models (which
are also data structures), but are not true for subclassed models (which
are R and Python (byte)code, not data structures).</p>
<div class="section level4">
<h4 id="less-verbose">Less verbose<a class="anchor" aria-label="anchor" href="#less-verbose"></a>
</h4>
<p>There is no <code>super$initialize(...)</code>, no
<code>call = function(...)</code>, no <code>self$...</code>, etc.</p>
<p>Compare:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="fl">32</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">outputs</span> <span class="op">&lt;-</span> <span class="va">inputs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">mlp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">outputs</span><span class="op">)</span></span></code></pre></div>
<p>With the subclassed version:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MLP</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Model.html">Model</a></span><span class="op">(</span></span>
<span>  classname <span class="op">=</span> <span class="st">"MLP"</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">dense_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">dense_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  call <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">inputs</span> <span class="op">|&gt;</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="fu">dense_1</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="fu">dense_2</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Instantiate the model.</span></span>
<span><span class="va">mlp</span> <span class="op">&lt;-</span> <span class="fu">MLP</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Necessary to create the model's state.</span></span>
<span><span class="co"># The model doesn't have a state until it's called at least once.</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">mlp</span><span class="op">(</span><span class="fu"><a href="../reference/op_zeros.html">op_zeros</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">32</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="model-validation-while-defining-its-connectivity-graph">Model validation while defining its connectivity graph<a class="anchor" aria-label="anchor" href="#model-validation-while-defining-its-connectivity-graph"></a>
</h4>
<p>In the functional API, the input specification (shape and dtype) is
created in advance (using <code>Input</code>). Every time you call a
layer, the layer checks that the specification passed to it matches its
assumptions, and it will raise a helpful error message if not.</p>
<p>This guarantees that any model you can build with the functional API
will run. All debugging – other than convergence-related debugging –
happens statically during the model construction and not at execution
time. This is similar to type checking in a compiler.</p>
</div>
<div class="section level4">
<h4 id="a-functional-model-is-plottable-and-inspectable">A functional model is plottable and inspectable<a class="anchor" aria-label="anchor" href="#a-functional-model-is-plottable-and-inspectable"></a>
</h4>
<p>You can plot the model as a graph, and you can easily access
intermediate nodes in this graph. For example, to extract and reuse the
activations of intermediate layers (as seen in a previous example):</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">features_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">vgg19</span><span class="op">$</span><span class="va">layers</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">output</span><span class="op">)</span></span>
<span><span class="va">feat_extraction_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">vgg19</span><span class="op">$</span><span class="va">input</span>,</span>
<span>                                     outputs <span class="op">=</span> <span class="va">features_list</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="a-functional-model-can-be-serialized-or-cloned">A functional model can be serialized or cloned<a class="anchor" aria-label="anchor" href="#a-functional-model-can-be-serialized-or-cloned"></a>
</h4>
<p>Because a functional model is a data structure rather than a piece of
code, it is safely serializable and can be saved as a single file that
allows you to recreate the exact same model without having access to any
of the original code. See the <a href="serialization_and_saving.html">serialization &amp; saving
guide</a>.</p>
<p>To serialize a subclassed model, it is necessary for the implementer
to specify a <code><a href="../reference/get_config.html">get_config()</a></code> and <code><a href="../reference/get_config.html">from_config()</a></code>
method at the model level.</p>
</div>
</div>
<div class="section level3">
<h3 id="functional-api-weakness">Functional API weakness:<a class="anchor" aria-label="anchor" href="#functional-api-weakness"></a>
</h3>
<div class="section level4">
<h4 id="it-does-not-support-dynamic-architectures">It does not support dynamic architectures<a class="anchor" aria-label="anchor" href="#it-does-not-support-dynamic-architectures"></a>
</h4>
<p>The functional API treats models as DAGs of layers. This is true for
most deep learning architectures, but not all – for example, recursive
networks or Tree RNNs do not follow this assumption and cannot be
implemented in the functional API.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="mix-and-match-api-styles">Mix-and-match API styles<a class="anchor" aria-label="anchor" href="#mix-and-match-api-styles"></a>
</h2>
<p>Choosing between the functional API or Model subclassing isn’t a
binary decision that restricts you into one category of models. All
models in the <code>keras</code> API can interact with each other,
whether they’re <code>Sequential</code> models, functional models, or
subclassed models that are written from scratch.</p>
<p>You can always use a functional model or <code>Sequential</code>
model as part of a subclassed model or layer:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">units</span> <span class="op">&lt;-</span> <span class="fl">32</span></span>
<span><span class="va">timesteps</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">input_dim</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span></span>
<span><span class="co"># Define a Functional model</span></span>
<span><span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span><span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">units</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">outputs</span> <span class="op">&lt;-</span> <span class="va">inputs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_global_average_pooling_1d.html">layer_global_average_pooling_1d</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">outputs</span><span class="op">)</span></span>
<span></span>
<span><span class="va">layer_custom_rnn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Layer.html">Layer</a></span><span class="op">(</span></span>
<span>  classname <span class="op">=</span> <span class="st">"CustomRNN"</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">units</span> <span class="op">&lt;-</span> <span class="va">units</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">projection_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">units</span>, activation <span class="op">=</span> <span class="st">"tanh"</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">projection_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">units</span>, activation <span class="op">=</span> <span class="st">"tanh"</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">classifier</span> <span class="op">&lt;-</span> <span class="va">model</span></span>
<span>  <span class="op">}</span>,</span>
<span>  call <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">outputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/op_zeros.html">op_zeros</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">self</span><span class="op">$</span><span class="va">units</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">inputs</span><span class="op">[</span>, <span class="va">t</span>, <span class="op">]</span></span>
<span>      <span class="va">h</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">projection_1</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>      <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">h</span> <span class="op">+</span> <span class="va">self</span><span class="op">$</span><span class="fu">projection_2</span><span class="op">(</span><span class="va">state</span><span class="op">)</span></span>
<span>      <span class="va">state</span> <span class="op">&lt;-</span> <span class="va">y</span></span>
<span>      <span class="va">outputs</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">features</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/op_stack.html">op_stack</a></span><span class="op">(</span><span class="va">outputs</span>, axis <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="fu">classifier</span><span class="op">(</span><span class="va">features</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">rnn</span> <span class="op">&lt;-</span> <span class="fu">layer_custom_rnn</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">rnn</span><span class="op">(</span><span class="fu"><a href="../reference/op_zeros.html">op_zeros</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">timesteps</span>, <span class="va">input_dim</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>You can use any subclassed layer or model in the functional API as
long as it implements a <code>call</code> method that follows one of the
following patterns:</p>
<ul>
<li>
<code>call(inputs, ...)</code> – Where <code>inputs</code> is a
tensor or a nested structure of tensors (e.g. a list of tensors), and
where <code>...</code> are non-tensor arguments (non-inputs).</li>
<li>
<code>call(inputs, training = NULL, ...)</code> – Where
<code>training</code> is a boolean indicating whether the layer should
behave in training mode and inference mode.</li>
<li>
<code>call(inputs, mask = NULL, ...)</code> – Where
<code>mask</code> is a boolean mask tensor (useful for RNNs, for
instance).</li>
<li>
<code>call(inputs, training = NULL, mask = NULL, ...)</code> – Of
course, you can have both masking and training-specific behavior at the
same time.</li>
</ul>
<p>Additionally, if you implement the <code><a href="../reference/get_config.html">get_config()</a></code> method
on your custom Layer or model, the functional models you create will
still be serializable and cloneable.</p>
<p>Here’s a quick example of a custom RNN, written from scratch, being
used in a functional model:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">units</span> <span class="op">&lt;-</span> <span class="fl">32</span></span>
<span><span class="va">timesteps</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">input_dim</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">batch_size</span> <span class="op">&lt;-</span> <span class="fl">16</span></span>
<span></span>
<span><span class="va">layer_custom_rnn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Layer.html">Layer</a></span><span class="op">(</span></span>
<span>  <span class="st">"custom_rnn"</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">units</span> <span class="op">&lt;-</span> <span class="va">units</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">projection_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">units</span>, activation <span class="op">=</span> <span class="st">"tanh"</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">projection_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">units</span>, activation <span class="op">=</span> <span class="st">"tanh"</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">classifier</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  call <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">outputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/op_zeros.html">op_zeros</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">self</span><span class="op">$</span><span class="va">units</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">inputs</span><span class="op">[</span>, <span class="va">t</span>, <span class="op">]</span></span>
<span>      <span class="va">h</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">projection_1</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>      <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">h</span> <span class="op">+</span> <span class="va">self</span><span class="op">$</span><span class="fu">projection_2</span><span class="op">(</span><span class="va">state</span><span class="op">)</span></span>
<span>      <span class="va">state</span> <span class="op">&lt;-</span> <span class="va">y</span></span>
<span>      <span class="va">outputs</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">features</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/op_stack.html">op_stack</a></span><span class="op">(</span><span class="va">outputs</span>, axis <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="fu">classifier</span><span class="op">(</span><span class="va">features</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Note that you specify a static batch size for the inputs with the `batch_shape`</span></span>
<span><span class="co"># arg, because the inner computation of `layer_custom_rnn()` requires a static batch size</span></span>
<span><span class="co"># (when you create the `state` zeros tensor).</span></span>
<span><span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>batch_shape <span class="op">=</span> <span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="va">batch_size</span>, <span class="va">timesteps</span>, <span class="va">input_dim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">outputs</span> <span class="op">&lt;-</span> <span class="va">inputs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_conv_1d.html">layer_conv_1d</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="fl">32</span>, kernel_size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">layer_custom_rnn</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">outputs</span><span class="op">)</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">model</span><span class="op">(</span><span class="fu"><a href="../reference/op_zeros.html">op_zeros</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Tomasz Kalinowski, JJ Allaire, François Chollet, Posit Software, PBC, Google.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
