<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Train a Siamese MLP on pairs of digits from the MNIST dataset. • keras3</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../../apple-touch-icon-60x60.png">
<script src="../../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../../deps/search-1.0.0/fuse.min.js"></script><script src="../../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../../pkgdown.js"></script><link href="../../../extra.css" rel="stylesheet">
<meta property="og:title" content="Train a Siamese MLP on pairs of digits from the MNIST dataset.">
<meta name="robots" content="noindex">
<!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KHBDBW7');</script><!-- End Google Tag Manager -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KHBDBW7" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) -->


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="inverse" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../../index.html">keras3</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.2.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../../../articles/getting_started.html">Getting Started</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-guides" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Guides</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-guides">
<li><h6 class="dropdown-header" data-toc-skip>Model definition</h6></li>
    <li><a class="dropdown-item" href="../../../articles/sequential_model.html">Sequential Model</a></li>
    <li><a class="dropdown-item" href="../../../articles/functional_api.html">Functional API</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Extending and customizing</h6></li>
    <li><a class="dropdown-item" href="../../../articles/training_with_built_in_methods.html">Training &amp; evaluation with the built-in methods</a></li>
    <li><a class="dropdown-item" href="../../../articles/custom_train_step_in_tensorflow.html">Customizing `fit()` with Tensorflow</a></li>
    <li><a class="dropdown-item" href="../../../articles/writing_your_own_callbacks.html">Writing your own callbacks</a></li>
    <li><a class="dropdown-item" href="../../../articles/making_new_layers_and_models_via_subclassing.html">Making new layers and models via subclassing</a></li>
    <li><a class="dropdown-item" href="../../../articles/writing_a_custom_training_loop_in_tensorflow.html">Writing a training loop from scratch in TensorFlow</a></li>
    <li><a class="dropdown-item" href="../../../articles/serialization_and_saving.html">Serialization and Saving</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Other topics</h6></li>
    <li><a class="dropdown-item" href="../../../articles/transfer_learning.html">Transfer learning and fine tuning</a></li>
    <li><a class="dropdown-item" href="../../../articles/distributed_training_with_tensorflow.html">Distributed training with TensorFlow</a></li>
    <li><a class="dropdown-item" href="../../../articles/distribution.html">Distributed training with Jax</a></li>
  </ul>
</li>
<li class="active nav-item"><a class="nav-link" href="../../../articles/examples/index.html">Examples</a></li>
<li class="nav-item"><a class="nav-link" href="../../../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../../../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../../../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rstudio/keras3/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Train a Siamese MLP on pairs of digits from the MNIST dataset.</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/keras3/blob/HEAD/vignettes/examples/vision/mnist_siamese_graph.Rmd" class="external-link"><code>vignettes/examples/vision/mnist_siamese_graph.Rmd</code></a></small>
      <div class="d-none name"><code>mnist_siamese_graph.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><a href="https://en.wikipedia.org/wiki/Siamese_neural_network" class="external-link">Siamese
Networks</a> are neural networks which share weights between two or more
sister networks, each producing embedding vectors of its respective
inputs.</p>
<p>In supervised similarity learning, the networks are then trained to
maximize the contrast (distance) between embeddings of inputs of
different classes, while minimizing the distance between embeddings of
similar classes, resulting in embedding spaces that reflect the class
segmentation of the training inputs.</p>
<p>This implementation loosely follows Hadsell-et-al.’06 [1] (see paper
for mode details) but the euclidean distance is replaced by a
subtraction layer and one fully-connect (FC) layer.</p>
<p>[1] “Dimensionality Reduction by Learning an Invariant Mapping” <a href="https://yann.lecun.com/exdb/publis/pdf/hadsell-chopra-lecun-06.pdf" class="external-link uri">https://yann.lecun.com/exdb/publis/pdf/hadsell-chopra-lecun-06.pdf</a></p>
<p>Gets to 98.11% test accuracy after 20 epochs. 3 seconds per epoch on
a AMD Ryzen 7 PRO 4750U (CPU)</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keras3.posit.co/">keras3</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">contrastive_loss</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y_true</span>, <span class="va">y_pred</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Contrastive loss from Hadsell-et-al.'06</span></span>
<span>    <span class="co"># https://yann.lecun.com/exdb/publis/pdf/hadsell-chopra-lecun-06.pdf</span></span>
<span>    <span class="va">margin</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>    <span class="va">margin_square</span> <span class="op">=</span> <span class="fu"><a href="../../../reference/op_square.html">op_square</a></span><span class="op">(</span><span class="fu"><a href="../../../reference/op_maximum.html">op_maximum</a></span><span class="op">(</span><span class="va">margin</span> <span class="op">-</span> <span class="op">(</span><span class="va">y_pred</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../../../reference/op_mean.html">op_mean</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">y_true</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="../../../reference/op_square.html">op_square</a></span><span class="op">(</span><span class="va">y_pred</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">y_true</span><span class="op">)</span> <span class="op">*</span> <span class="va">margin_square</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="create-pairs-of-images">Create pairs of images<a class="anchor" aria-label="anchor" href="#create-pairs-of-images"></a>
</h2>
<p>We will train the model to differentiate between digits of different
classes. For example, digit <code>0</code> needs to be differentiated
from the rest of the digits (<code>1</code> through <code>9</code>),
digit <code>1</code> - from <code>0</code> and <code>2</code> through
<code>9</code>, and so on. To carry this out, we will select N random
images from class A (for example, for digit <code>0</code>) and pair
them with N random images from another class B (for example, for digit
<code>1</code>). Then, we can repeat this process for all classes of
digits (until digit <code>9</code>). Once we have paired digit
<code>0</code> with other digits, we can repeat this process for the
remaining classes for the rest of the digits (from <code>1</code> until
<code>9</code>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">create_pairs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Positive and negative pair creation.</span></span>
<span>    <span class="co"># Alternates between positive and negative pairs.</span></span>
<span>    <span class="va">digit_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, <span class="va">y</span>, <span class="va">list</span><span class="op">)</span></span>
<span>    <span class="va">y1</span> <span class="op">&lt;-</span> <span class="va">y</span></span>
<span>    <span class="va">y2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">y</span>, <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">9</span>,<span class="fl">1</span>,prob<span class="op">=</span><span class="fl">0.1</span><span class="op">+</span><span class="fl">0.8</span><span class="op">*</span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">9</span><span class="op">==</span><span class="va">a</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">idx1</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">idx2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">y2</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">digit_indices</span><span class="op">[[</span><span class="va">a</span><span class="op">]</span><span class="op">]</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">is_same</span>  <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">*</span><span class="op">(</span><span class="va">y1</span><span class="op">==</span><span class="va">y2</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pair1 <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">idx1</span>,<span class="op">]</span>, pair2 <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">idx2</span>,<span class="op">]</span>, y <span class="op">=</span> <span class="va">is_same</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">compute_accuracy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">predictions</span>, <span class="va">labels</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Compute classification accuracy with a fixed threshold on distances.</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">labels</span><span class="op">[</span><span class="va">predictions</span> <span class="op">&gt;</span> <span class="fl">0.5</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># the data, shuffled and split between train and test sets</span></span>
<span><span class="va">mnist</span>   <span class="op">&lt;-</span> <span class="fu"><a href="../../../reference/dataset_mnist.html">dataset_mnist</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">x_train</span> <span class="op">&lt;-</span> <span class="va">mnist</span><span class="op">$</span><span class="va">train</span><span class="op">$</span><span class="va">x</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">mnist</span><span class="op">$</span><span class="va">train</span><span class="op">$</span><span class="va">y</span></span>
<span><span class="va">x_test</span>  <span class="op">&lt;-</span> <span class="va">mnist</span><span class="op">$</span><span class="va">test</span><span class="op">$</span><span class="va">x</span></span>
<span><span class="va">y_test</span>  <span class="op">&lt;-</span> <span class="va">mnist</span><span class="op">$</span><span class="va">test</span><span class="op">$</span><span class="va">y</span></span>
<span><span class="va">x_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/reticulate/reference/array_reshape.html" class="external-link">array_reshape</a></span><span class="op">(</span><span class="va">x_train</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">x_train</span><span class="op">)</span>, <span class="fl">784</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_test</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/reticulate/reference/array_reshape.html" class="external-link">array_reshape</a></span><span class="op">(</span><span class="va">x_test</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">x_test</span><span class="op">)</span>, <span class="fl">784</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_train</span> <span class="op">&lt;-</span> <span class="va">x_train</span> <span class="op">/</span> <span class="fl">255</span></span>
<span><span class="va">x_test</span>  <span class="op">&lt;-</span> <span class="va">x_test</span> <span class="op">/</span> <span class="fl">255</span></span>
<span></span>
<span><span class="co"># create training+test positive and negative pairs</span></span>
<span><span class="va">tr</span> <span class="op">&lt;-</span> <span class="fu">create_pairs</span><span class="op">(</span><span class="va">x_train</span>, <span class="va">y_train</span><span class="op">)</span></span>
<span><span class="va">te</span> <span class="op">&lt;-</span> <span class="fu">create_pairs</span><span class="op">(</span><span class="va">x_test</span>,  <span class="va">y_test</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "pair1" "pair2" "y"</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="network-definition">Network definition<a class="anchor" aria-label="anchor" href="#network-definition"></a>
</h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># input layers</span></span>
<span><span class="va">input_dim</span> <span class="op">=</span> <span class="fl">784</span></span>
<span><span class="va">input_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../../reference/layer_input.html">layer_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_dim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">input_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../../reference/layer_input.html">layer_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">input_dim</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># definition of the base network that will be shared</span></span>
<span><span class="va">base_network</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../../reference/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../../../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../../../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">128</span>, activation <span class="op">=</span> <span class="st">'relu'</span><span class="op">)</span> <span class="op"><a href="../../../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../../../reference/layer_dropout.html">layer_dropout</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op"><a href="../../../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../../../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">128</span>, activation <span class="op">=</span> <span class="st">'relu'</span><span class="op">)</span> <span class="op"><a href="../../../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../../../reference/layer_dropout.html">layer_dropout</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op"><a href="../../../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../../../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">128</span>, activation <span class="op">=</span> <span class="st">'relu'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># because we re-use the same instance `base_network`, the weights of</span></span>
<span><span class="co"># the network will be shared across the two branches</span></span>
<span><span class="va">branch_1</span> <span class="op">&lt;-</span> <span class="fu">base_network</span><span class="op">(</span><span class="va">input_1</span><span class="op">)</span></span>
<span><span class="va">branch_2</span> <span class="op">&lt;-</span> <span class="fu">base_network</span><span class="op">(</span><span class="va">input_2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># merging layer</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../../reference/layer_subtract.html">layer_subtract</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">branch_1</span>, <span class="va">branch_2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../../../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../../../reference/layer_dropout.html">layer_dropout</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op"><a href="../../../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../../../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">16</span>, activation <span class="op">=</span> <span class="st">'relu'</span><span class="op">)</span> <span class="op"><a href="../../../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../../../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">1</span>, activation <span class="op">=</span> <span class="st">"sigmoid"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create and compile model</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">input_1</span>, <span class="va">input_2</span><span class="op">)</span>, <span class="va">out</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="train">Train<a class="anchor" aria-label="anchor" href="#train"></a>
</h2>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op"><a href="../../../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html" class="external-link">compile</a></span><span class="op">(</span></span>
<span>    optimizer <span class="op">=</span> <span class="st">"rmsprop"</span>,</span>
<span>    <span class="co">#loss = "binary_crossentropy",</span></span>
<span>    loss <span class="op">=</span> <span class="va">contrastive_loss</span>,</span>
<span>    metrics <span class="op">=</span> <span class="va">metric_binary_accuracy</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">history</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="../../../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">tr</span><span class="op">$</span><span class="va">pair1</span>, <span class="va">tr</span><span class="op">$</span><span class="va">pair2</span><span class="op">)</span>, <span class="va">tr</span><span class="op">$</span><span class="va">y</span>,</span>
<span>    batch_size <span class="op">=</span> <span class="fl">128</span>,</span>
<span>    epochs <span class="op">=</span> <span class="fl">20</span>,</span>
<span>    validation_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">te</span><span class="op">$</span><span class="va">pair1</span>, <span class="va">te</span><span class="op">$</span><span class="va">pair2</span><span class="op">)</span>,</span>
<span>        <span class="va">te</span><span class="op">$</span><span class="va">y</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Epoch 1/20</span></span>
<span><span class="co">## 469/469 - 5s - 11ms/step - binary_accuracy: 0.7566 - loss: 0.1639 - val_binary_accuracy: 0.8824 - val_loss: 0.0976</span></span>
<span><span class="co">## Epoch 2/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.8906 - loss: 0.0862 - val_binary_accuracy: 0.9223 - val_loss: 0.0623</span></span>
<span><span class="co">## Epoch 3/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9246 - loss: 0.0595 - val_binary_accuracy: 0.9372 - val_loss: 0.0497</span></span>
<span><span class="co">## Epoch 4/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9434 - loss: 0.0451 - val_binary_accuracy: 0.9502 - val_loss: 0.0401</span></span>
<span><span class="co">## Epoch 5/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9555 - loss: 0.0353 - val_binary_accuracy: 0.9593 - val_loss: 0.0322</span></span>
<span><span class="co">## Epoch 6/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9642 - loss: 0.0287 - val_binary_accuracy: 0.9626 - val_loss: 0.0298</span></span>
<span><span class="co">## Epoch 7/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9699 - loss: 0.0243 - val_binary_accuracy: 0.9655 - val_loss: 0.0277</span></span>
<span><span class="co">## Epoch 8/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9733 - loss: 0.0209 - val_binary_accuracy: 0.9684 - val_loss: 0.0258</span></span>
<span><span class="co">## Epoch 9/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9776 - loss: 0.0186 - val_binary_accuracy: 0.9664 - val_loss: 0.0263</span></span>
<span><span class="co">## Epoch 10/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9790 - loss: 0.0166 - val_binary_accuracy: 0.9698 - val_loss: 0.0246</span></span>
<span><span class="co">## Epoch 11/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9813 - loss: 0.0150 - val_binary_accuracy: 0.9729 - val_loss: 0.0216</span></span>
<span><span class="co">## Epoch 12/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9821 - loss: 0.0144 - val_binary_accuracy: 0.9723 - val_loss: 0.0218</span></span>
<span><span class="co">## Epoch 13/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9839 - loss: 0.0131 - val_binary_accuracy: 0.9740 - val_loss: 0.0210</span></span>
<span><span class="co">## Epoch 14/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9845 - loss: 0.0126 - val_binary_accuracy: 0.9744 - val_loss: 0.0201</span></span>
<span><span class="co">## Epoch 15/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9861 - loss: 0.0114 - val_binary_accuracy: 0.9735 - val_loss: 0.0213</span></span>
<span><span class="co">## Epoch 16/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9871 - loss: 0.0106 - val_binary_accuracy: 0.9733 - val_loss: 0.0218</span></span>
<span><span class="co">## Epoch 17/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9872 - loss: 0.0103 - val_binary_accuracy: 0.9762 - val_loss: 0.0188</span></span>
<span><span class="co">## Epoch 18/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9876 - loss: 0.0103 - val_binary_accuracy: 0.9751 - val_loss: 0.0200</span></span>
<span><span class="co">## Epoch 19/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9881 - loss: 0.0096 - val_binary_accuracy: 0.9747 - val_loss: 0.0207</span></span>
<span><span class="co">## Epoch 20/20</span></span>
<span><span class="co">## 469/469 - 1s - 2ms/step - binary_accuracy: 0.9890 - loss: 0.0088 - val_binary_accuracy: 0.9756 - val_loss: 0.0201</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">history</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="mnist_siamese_graph%2Funnamed-chunk-5-1.png" alt="plot of chunk unnamed-chunk-5"><div class="figcaption">plot of chunk unnamed-chunk-5</div>
</div>
</div>
<div class="section level2">
<h2 id="evaluate">Evaluate<a class="anchor" aria-label="anchor" href="#evaluate"></a>
</h2>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># compute final accuracy on training and test sets</span></span>
<span></span>
<span><span class="va">tr_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">tr</span><span class="op">$</span><span class="va">pair1</span>, <span class="va">tr</span><span class="op">$</span><span class="va">pair2</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## 1875/1875 - 2s - 847us/step</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tr_acc</span>  <span class="op">&lt;-</span> <span class="fu">compute_accuracy</span><span class="op">(</span><span class="va">tr_pred</span>, <span class="va">tr</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="va">te_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">te</span><span class="op">$</span><span class="va">pair1</span>, <span class="va">te</span><span class="op">$</span><span class="va">pair2</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## 313/313 - 0s - 1ms/step</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">te_acc</span>  <span class="op">&lt;-</span> <span class="fu">compute_accuracy</span><span class="op">(</span><span class="va">te_pred</span>, <span class="va">te</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">'* Accuracy on training set: %0.2f%%'</span>, <span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">tr_acc</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "* Accuracy on training set: 99.65%"</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">'* Accuracy on test set: %0.2f%%'</span>, <span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">te_acc</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "* Accuracy on test set: 98.14%"</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="plots">Plots<a class="anchor" aria-label="anchor" href="#plots"></a>
</h2>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">vioplot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/vioplot/man/vioplot.html" class="external-link">vioplot</a></span><span class="op">(</span> <span class="va">te_pred</span> <span class="op">~</span> <span class="va">te</span><span class="op">$</span><span class="va">y</span> <span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="mnist_siamese_graph%2Funnamed-chunk-7-1.png" alt="plot of chunk unnamed-chunk-7"><div class="figcaption">plot of chunk unnamed-chunk-7</div>
</div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">i</span><span class="op">=</span><span class="fl">3</span></span>
<span><span class="va">visualizePair</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="va">te</span><span class="op">$</span><span class="va">pair1</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="fl">28</span>,<span class="fl">28</span><span class="op">)</span><span class="op">[</span>,<span class="fl">28</span><span class="op">:</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="va">te</span><span class="op">$</span><span class="va">pair2</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="fl">28</span>,<span class="fl">28</span><span class="op">)</span><span class="op">[</span>,<span class="fl">28</span><span class="op">:</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"true:"</span>, <span class="va">te</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"|  pred:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">te_pred</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">9</span>, <span class="va">visualizePair</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="mnist_siamese_graph%2Funnamed-chunk-7-2.png" alt="plot of chunk unnamed-chunk-7"><div class="figcaption">plot of chunk unnamed-chunk-7</div>
</div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## NULL</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## NULL</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">## NULL</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## [[4]]</span></span>
<span><span class="co">## NULL</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## [[5]]</span></span>
<span><span class="co">## NULL</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## [[6]]</span></span>
<span><span class="co">## NULL</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## [[7]]</span></span>
<span><span class="co">## NULL</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## [[8]]</span></span>
<span><span class="co">## NULL</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## [[9]]</span></span>
<span><span class="co">## NULL</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Tomasz Kalinowski, JJ Allaire, François Chollet, Posit Software, PBC, Google.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
