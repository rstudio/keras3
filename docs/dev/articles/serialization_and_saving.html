<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Save, serialize, and export models • keras3</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Save, serialize, and export models">
<meta name="description" content="Complete guide to saving, serializing, and exporting models.">
<meta property="og:description" content="Complete guide to saving, serializing, and exporting models.">
<meta name="robots" content="noindex">
<!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KHBDBW7');</script><!-- End Google Tag Manager -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KHBDBW7" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) -->


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="inverse" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">keras3</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.4.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/getting_started.html">Getting Started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-guides" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Guides</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-guides">
<li><h6 class="dropdown-header" data-toc-skip>Model definition</h6></li>
    <li><a class="dropdown-item" href="../articles/sequential_model.html">Sequential Model</a></li>
    <li><a class="dropdown-item" href="../articles/functional_api.html">Functional API</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Extending and customizing</h6></li>
    <li><a class="dropdown-item" href="../articles/training_with_built_in_methods.html">Training &amp; evaluation with the built-in methods</a></li>
    <li><a class="dropdown-item" href="../articles/custom_train_step_in_tensorflow.html">Customizing `fit()` with Tensorflow</a></li>
    <li><a class="dropdown-item" href="../articles/writing_your_own_callbacks.html">Writing your own callbacks</a></li>
    <li><a class="dropdown-item" href="../articles/making_new_layers_and_models_via_subclassing.html">Making new layers and models via subclassing</a></li>
    <li><a class="dropdown-item" href="../articles/writing_a_custom_training_loop_in_tensorflow.html">Writing a training loop from scratch in TensorFlow</a></li>
    <li><a class="dropdown-item" href="../articles/serialization_and_saving.html">Serialization and Saving</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Other topics</h6></li>
    <li><a class="dropdown-item" href="../articles/transfer_learning.html">Transfer learning and fine tuning</a></li>
    <li><a class="dropdown-item" href="../articles/distributed_training_with_tensorflow.html">Distributed training with TensorFlow</a></li>
    <li><a class="dropdown-item" href="../articles/distribution.html">Distributed training with Jax</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/examples/index.html">Examples</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rstudio/keras3/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Save, serialize, and export models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/keras3/blob/HEAD/vignettes/serialization_and_saving.Rmd" class="external-link"><code>vignettes/serialization_and_saving.Rmd</code></a></small>
      <div class="d-none name"><code>serialization_and_saving.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>A Keras model consists of multiple components:</p>
<ul>
<li>The architecture, or configuration, which specifies what layers the
model contain, and how they’re connected.</li>
<li>A set of weights values (the “state of the model”).</li>
<li>An optimizer (defined by compiling the model).</li>
<li>A set of losses and metrics (defined by compiling the model).</li>
</ul>
<p>The Keras API saves all of these pieces together in a unified format,
marked by the <code>.keras</code> extension. This is a zip archive
consisting of the following:</p>
<ul>
<li>A JSON-based configuration file (config.json): Records of model,
layer, and other trackables’ configuration.</li>
<li>A H5-based state file, such as <code>model.weights.h5</code> (for
the whole model), with directory keys for layers and their weights.</li>
<li>A metadata file in JSON, storing things such as the current Keras
version.</li>
</ul>
<p>Let’s take a look at how this works.</p>
</div>
<div class="section level2">
<h2 id="how-to-save-and-load-a-model">How to save and load a model<a class="anchor" aria-label="anchor" href="#how-to-save-and-load-a-model"></a>
</h2>
<p>If you only have 10 seconds to read this guide, here’s what you need
to know.</p>
<p><strong>Saving a Keras model:</strong></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get model (Sequential, Functional Model, or Model subclass)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">...</span></span>
<span></span>
<span><span class="co"># The filename needs to end with the .keras extension</span></span>
<span><span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/save_model.html">save_model</a></span><span class="op">(</span><span class="st">'path/to/location.keras'</span><span class="op">)</span></span></code></pre></div>
<p><strong>Loading the model back:</strong></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_model.html">load_model</a></span><span class="op">(</span><span class="st">'path/to/location.keras'</span><span class="op">)</span></span></code></pre></div>
<p>Now, let’s look at the details.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keras3.posit.co/">keras3</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="saving">Saving<a class="anchor" aria-label="anchor" href="#saving"></a>
</h2>
<p>This section is about saving an entire model to a single file. The
file will include:</p>
<ul>
<li>The model’s architecture/config</li>
<li>The model’s weight values (which were learned during training)</li>
<li>The model’s compilation information (if <code><a href="https://generics.r-lib.org/reference/compile.html" class="external-link">compile()</a></code> was
called)</li>
<li>The optimizer and its state, if any (this enables you to restart
training where you left)</li>
</ul>
<div class="section level4">
<h4 id="apis">APIs<a class="anchor" aria-label="anchor" href="#apis"></a>
</h4>
<p>You can save a model with <code><a href="../reference/save_model.html">save_model()</a></code>. You can load it
back with <code><a href="../reference/load_model.html">load_model()</a></code>.</p>
<p>The only supported format in Keras 3 is the “Keras v3” format, which
uses the <code>.keras</code> extension.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create a simple model.</span></span>
<span>  <span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span><span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="fl">32</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">outputs</span> <span class="op">&lt;-</span> <span class="va">inputs</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">outputs</span><span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html" class="external-link">compile</a></span><span class="op">(</span>optimizer <span class="op">=</span> <span class="fu"><a href="../reference/optimizer_adam.html">optimizer_adam</a></span><span class="op">(</span><span class="op">)</span>, loss <span class="op">=</span> <span class="st">"mean_squared_error"</span><span class="op">)</span></span>
<span>  <span class="va">model</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">get_model</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Train the model.</span></span>
<span><span class="va">test_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_uniform.html">random_uniform</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">128</span>, <span class="fl">32</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">test_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_uniform.html">random_uniform</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">128</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">test_input</span>, <span class="va">test_target</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calling `save('my_model.keras')` creates a zip archive `my_model.keras`.</span></span>
<span><span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/save_model.html">save_model</a></span><span class="op">(</span><span class="st">"my_model.keras"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># It can be used to reconstruct the model identically.</span></span>
<span><span class="va">reconstructed_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_model.html">load_model</a></span><span class="op">(</span><span class="st">"my_model.keras"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Let's check:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span></span>
<span>  <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">test_input</span><span class="op">)</span>,</span>
<span>  <span class="va">reconstructed_model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">test_input</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="custom-objects">Custom objects<a class="anchor" aria-label="anchor" href="#custom-objects"></a>
</h3>
<p>This section covers the basic workflows for handling custom layers,
functions, and models in Keras saving and reloading.</p>
<p>When saving a model that includes custom objects, such as a
subclassed Layer, you <strong>must</strong> define a
<code><a href="../reference/get_config.html">get_config()</a></code> method on the object class. If the arguments
passed to the constructor (<code>initialize()</code> method) of the
custom object aren’t simple objects (anything other than types like
ints, strings, etc.), then you <strong>must</strong> also explicitly
deserialize these arguments in the <code><a href="../reference/get_config.html">from_config()</a></code> class
method.</p>
<p>Like this:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">layer_custom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Layer.html">Layer</a></span><span class="op">(</span></span>
<span>  <span class="st">"CustomLayer"</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">sublayer</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">sublayer</span> <span class="op">&lt;-</span> <span class="va">sublayer</span></span>
<span>  <span class="op">}</span>,</span>
<span>  call <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="fu">sublayer</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  get_config <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">base_config</span> <span class="op">&lt;-</span> <span class="va">super</span><span class="op">$</span><span class="fu">get_config</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sublayer <span class="op">=</span> <span class="fu"><a href="../reference/serialize_keras_object.html">serialize_keras_object</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">sublayer</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">base_config</span>, <span class="va">config</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  from_config <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">cls</span>, <span class="va">config</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sublayer_config</span> <span class="op">&lt;-</span> <span class="va">config</span><span class="op">$</span><span class="va">sublayer</span></span>
<span>    <span class="va">sublayer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/deserialize_keras_object.html">deserialize_keras_object</a></span><span class="op">(</span><span class="va">sublayer_config</span><span class="op">)</span></span>
<span>    <span class="fu">cls</span><span class="op">(</span><span class="va">sublayer</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">config</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Please see the <a href="#config_methods">Defining the config methods
section</a> for more details and examples.</p>
<p>The saved <code>.keras</code> file is lightweight and does not store
the Python code for custom objects. Therefore, to reload the model,
<code>load_model</code> requires access to the definition of any custom
objects used through one of the following methods:</p>
<ol style="list-style-type: decimal">
<li>Registering custom objects <strong>(preferred)</strong>,</li>
<li>Passing custom objects directly when loading, or</li>
<li>Using a custom object scope</li>
</ol>
<p>Below are examples of each workflow:</p>
<div class="section level4">
<h4 id="registering-custom-objects-preferred">Registering custom objects (<strong>preferred</strong>)<a class="anchor" aria-label="anchor" href="#registering-custom-objects-preferred"></a>
</h4>
<p>This is the preferred method, as custom object registration greatly
simplifies saving and loading code. Calling
<code><a href="../reference/register_keras_serializable.html">register_keras_serializable()</a></code> on a custom object registers
the object globally in a master list, allowing Keras to recognize the
object when loading the model.</p>
<p>Let’s create a custom model involving both a custom layer and a
custom activation function to demonstrate this.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Clear all previously registered custom objects</span></span>
<span><span class="fu"><a href="../reference/get_custom_objects.html">set_custom_objects</a></span><span class="op">(</span>clear <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## named list()</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">layer_custom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Layer.html">Layer</a></span><span class="op">(</span></span>
<span>  <span class="st">"CustomLayer"</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">self</span>, <span class="va">factor</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">factor</span> <span class="op">=</span> <span class="va">factor</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  call <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">self</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">*</span> <span class="va">self</span><span class="op">$</span><span class="va">factor</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  get_config <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">self</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>factor <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">factor</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Upon registration, you can optionally specify a package or a name.</span></span>
<span><span class="co"># If left blank, the package defaults to "Custom" and the name defaults to</span></span>
<span><span class="co"># the class name.</span></span>
<span><span class="fu"><a href="../reference/register_keras_serializable.html">register_keras_serializable</a></span><span class="op">(</span><span class="va">layer_custom</span>, package <span class="op">=</span> <span class="st">"MyLayers"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">custom_fn</span> <span class="op">&lt;-</span> <span class="fu">keras3</span><span class="fu">:::</span><span class="fu">py_func2</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">^</span><span class="fl">2</span>, name <span class="op">=</span> <span class="st">"custom_fn"</span>, convert <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/register_keras_serializable.html">register_keras_serializable</a></span><span class="op">(</span><span class="va">custom_fn</span>, name<span class="op">=</span><span class="st">"custom_fn"</span>, package<span class="op">=</span><span class="st">"my_package"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Create the model.</span></span>
<span><span class="va">get_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span><span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mid</span> <span class="op">&lt;-</span> <span class="va">inputs</span> <span class="op">|&gt;</span> <span class="fu">layer_custom</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="va">outputs</span> <span class="op">&lt;-</span> <span class="va">mid</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">1</span>, activation <span class="op">=</span> <span class="va">custom_fn</span><span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">outputs</span><span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html" class="external-link">compile</a></span><span class="op">(</span>optimizer <span class="op">=</span> <span class="st">"rmsprop"</span>, loss <span class="op">=</span> <span class="st">"mean_squared_error"</span><span class="op">)</span></span>
<span>  <span class="va">model</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Train the model.</span></span>
<span><span class="va">train_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_uniform.html">random_uniform</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_uniform.html">random_uniform</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">input</span>, <span class="va">target</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span>, epochs <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">model</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">test_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_uniform.html">random_uniform</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">test_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/random_uniform.html">random_uniform</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">get_model</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">train_model</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/save_model.html">save_model</a></span><span class="op">(</span><span class="st">"custom_model.keras"</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now, we can simply load without worrying about our custom objects.</span></span>
<span><span class="va">reconstructed_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_model.html">load_model</a></span><span class="op">(</span><span class="st">"custom_model.keras"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Let's check:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span></span>
<span>  <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">test_input</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="va">reconstructed_model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">test_input</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="passing-custom-objects-to-load_model">Passing custom objects to <code>load_model()</code><a class="anchor" aria-label="anchor" href="#passing-custom-objects-to-load_model"></a>
</h4>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">get_model</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">train_model</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calling `save_model('my_model.keras')` creates a zip archive `my_model.keras`.</span></span>
<span><span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/save_model.html">save_model</a></span><span class="op">(</span><span class="st">"custom_model.keras"</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Upon loading, pass a named list containing the custom objects used in the</span></span>
<span><span class="co"># `custom_objects` argument of `load_model()`.</span></span>
<span><span class="va">reconstructed_model</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/load_model.html">load_model</a></span><span class="op">(</span></span>
<span> <span class="st">"custom_model.keras"</span>,</span>
<span>  custom_objects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>CustomLayer <span class="op">=</span> <span class="va">layer_custom</span>,</span>
<span>                        custom_fn <span class="op">=</span> <span class="va">custom_fn</span><span class="op">)</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Let's check:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span></span>
<span>  <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">test_input</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="va">reconstructed_model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">test_input</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="using-a-custom-object-scope">Using a custom object scope<a class="anchor" aria-label="anchor" href="#using-a-custom-object-scope"></a>
</h4>
<p>Any code within the custom object scope will be able to recognize the
custom objects passed to the scope argument. Therefore, loading the
model within the scope will allow the loading of our custom objects.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">get_model</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">train_model</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/save_model.html">save_model</a></span><span class="op">(</span><span class="st">"custom_model.keras"</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pass the custom objects dictionary to a custom object scope and place</span></span>
<span><span class="co"># the `keras.models.load_model()` call within the scope.</span></span>
<span><span class="va">custom_objects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>CustomLayer <span class="op">=</span> <span class="va">layer_custom</span>, custom_fn <span class="op">=</span> <span class="va">custom_fn</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/with_custom_object_scope.html">with_custom_object_scope</a></span><span class="op">(</span><span class="va">custom_objects</span>, <span class="op">{</span></span>
<span>  <span class="va">reconstructed_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_model.html">load_model</a></span><span class="op">(</span><span class="st">"custom_model.keras"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Let's check:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span></span>
<span>  <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">test_input</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="va">reconstructed_model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">test_input</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="model-serialization">Model serialization<a class="anchor" aria-label="anchor" href="#model-serialization"></a>
</h3>
<p>This section is about saving only the model’s configuration, without
its state. The model’s configuration (or architecture) specifies what
layers the model contains, and how these layers are connected. If you
have the configuration of a model, then the model can be created with a
freshly initialized state (no weights or compilation information).</p>
<div class="section level4">
<h4 id="apis-1">APIs<a class="anchor" aria-label="anchor" href="#apis-1"></a>
</h4>
<p>The following serialization APIs are available:</p>
<ul>
<li>
<code>clone_model(model)</code>: make a (randomly initialized) copy
of a model.</li>
<li>
<code><a href="../reference/get_config.html">get_config()</a></code> and <code>cls.from_config()</code>:
retrieve the configuration of a layer or model, and recreate a model
instance from its config, respectively.</li>
<li>
<code>keras.models.model_to_json()</code> and
<code>keras.models.model_from_json()</code>: similar, but as JSON
strings.</li>
<li>
<code>keras.saving.serialize_keras_object()</code>: retrieve the
configuration any arbitrary Keras object.</li>
<li>
<code>keras.saving.deserialize_keras_object()</code>: recreate an
object instance from its configuration.</li>
</ul>
</div>
<div class="section level4">
<h4 id="in-memory-model-cloning">In-memory model cloning<a class="anchor" aria-label="anchor" href="#in-memory-model-cloning"></a>
</h4>
<p>You can do in-memory cloning of a model via
<code><a href="../reference/clone_model.html">clone_model()</a></code>. This is equivalent to getting the config
then recreating the model from its config (so it does not preserve
compilation information or layer weights values).</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clone_model.html">clone_model</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="get_config-and-from_config">
<code>get_config()</code> and <code>from_config()</code><a class="anchor" aria-label="anchor" href="#get_config-and-from_config"></a>
</h4>
<p>Calling <code>get_config(model)</code> or
<code>get_config(layer)</code> will return a named list containing the
configuration of the model or layer, respectively. You should define
<code><a href="../reference/get_config.html">get_config()</a></code> to contain arguments needed for the
<code>initialize()</code> method of the model or layer. At loading time,
the <code>from_config(config)</code> method will then call
<code>initialize()</code> with these arguments to reconstruct the model
or layer.</p>
<p><strong>Layer example:</strong></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">layer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>, <span class="fl">3</span>, activation<span class="op">=</span><span class="st">"relu"</span><span class="op">)</span></span>
<span><span class="va">layer_config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_config.html">get_config</a></span><span class="op">(</span><span class="va">layer</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">layer_config</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 12</span></span>
<span><span class="co">##  $ name              : chr "dense_4"</span></span>
<span><span class="co">##  $ trainable         : logi TRUE</span></span>
<span><span class="co">##  $ dtype             :List of 4</span></span>
<span><span class="co">##   ..$ module         : chr "keras"</span></span>
<span><span class="co">##   ..$ class_name     : chr "DTypePolicy"</span></span>
<span><span class="co">##   ..$ config         :List of 1</span></span>
<span><span class="co">##   .. ..$ name: chr "float32"</span></span>
<span><span class="co">##   ..$ registered_name: NULL</span></span>
<span><span class="co">##  $ units             : int 3</span></span>
<span><span class="co">##  $ activation        : chr "relu"</span></span>
<span><span class="co">##  $ use_bias          : logi TRUE</span></span>
<span><span class="co">##  $ kernel_initializer:List of 4</span></span>
<span><span class="co">##   ..$ module         : chr "keras.initializers"</span></span>
<span><span class="co">##   ..$ class_name     : chr "GlorotUniform"</span></span>
<span><span class="co">##   ..$ config         :List of 1</span></span>
<span><span class="co">##   .. ..$ seed: NULL</span></span>
<span><span class="co">##   ..$ registered_name: NULL</span></span>
<span><span class="co">##  $ bias_initializer  :List of 4</span></span>
<span><span class="co">##   ..$ module         : chr "keras.initializers"</span></span>
<span><span class="co">##   ..$ class_name     : chr "Zeros"</span></span>
<span><span class="co">##   ..$ config         : Named list()</span></span>
<span><span class="co">##   ..$ registered_name: NULL</span></span>
<span><span class="co">##  $ kernel_regularizer: NULL</span></span>
<span><span class="co">##  $ bias_regularizer  : NULL</span></span>
<span><span class="co">##  $ kernel_constraint : NULL</span></span>
<span><span class="co">##  $ bias_constraint   : NULL</span></span>
<span><span class="co">##  - attr(*, "__class__")=&lt;class 'keras.src.layers.core.dense.Dense'&gt;</span></span></code></pre>
<p>Now let’s reconstruct the layer using the <code><a href="../reference/get_config.html">from_config()</a></code>
method:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_layer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_config.html">from_config</a></span><span class="op">(</span><span class="va">layer_config</span><span class="op">)</span></span></code></pre></div>
<p><strong>Sequential model example:</strong></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span>input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">32</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_config.html">get_config</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="va">new_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_config.html">from_config</a></span><span class="op">(</span><span class="va">config</span><span class="op">)</span></span></code></pre></div>
<p><strong>Functional model example:</strong></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">32</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">outputs</span> <span class="op">&lt;-</span> <span class="va">inputs</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">outputs</span><span class="op">)</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_config.html">get_config</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="va">new_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_config.html">from_config</a></span><span class="op">(</span><span class="va">config</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="save_model_config-and-load_model_config">
<code>save_model_config()</code> and
<code>load_model_config()</code><a class="anchor" aria-label="anchor" href="#save_model_config-and-load_model_config"></a>
</h4>
<p>This is similar to <code>get_config</code> /
<code>from_config</code>, except it turns the model into a JSON file,
which can then be loaded without the original model class. It is also
specific to models, it isn’t meant for layers.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span>input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">32</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/save_model_config.html">save_model_config</a></span><span class="op">(</span><span class="va">model</span>, <span class="st">"model_config.json"</span><span class="op">)</span></span>
<span><span class="va">new_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/save_model_config.html">load_model_config</a></span><span class="op">(</span><span class="st">"model_config.json"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="st">"model_config.json"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="arbitrary-object-serialization-and-deserialization">Arbitrary object serialization and deserialization<a class="anchor" aria-label="anchor" href="#arbitrary-object-serialization-and-deserialization"></a>
</h4>
<p>The <code><a href="../reference/serialize_keras_object.html">serialize_keras_object()</a></code> and
<code><a href="../reference/deserialize_keras_object.html">deserialize_keras_object()</a></code> APIs are general-purpose APIs
that can be used to serialize or deserialize any Keras object and any
custom object. It is at the foundation of saving model architecture and
is behind all <code><a href="https://rdrr.io/r/base/serialize.html" class="external-link">serialize()</a></code>/<code>deserialize()</code> calls
in keras.</p>
<p><strong>Example</strong>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/regularizer_l1.html">regularizer_l1</a></span><span class="op">(</span><span class="fl">0.005</span><span class="op">)</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/serialize_keras_object.html">serialize_keras_object</a></span><span class="op">(</span><span class="va">my_reg</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">config</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 4</span></span>
<span><span class="co">##  $ module         : chr "keras.regularizers"</span></span>
<span><span class="co">##  $ class_name     : chr "L1"</span></span>
<span><span class="co">##  $ config         :List of 1</span></span>
<span><span class="co">##   ..$ l1: num 0.005</span></span>
<span><span class="co">##  $ registered_name: NULL</span></span></code></pre>
<p>Note the serialization format containing all the necessary
information for proper reconstruction:</p>
<ul>
<li>
<code>module</code> containing the name of the Keras module or other
identifying module the object comes from</li>
<li>
<code>class_name</code> containing the name of the object’s
class.</li>
<li>
<code>config</code> with all the information needed to reconstruct
the object</li>
<li>
<code>registered_name</code> for custom objects. See <a href="#custom_object_serialization">here</a>.</li>
</ul>
<p>Now we can reconstruct the regularizer.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/deserialize_keras_object.html">deserialize_keras_object</a></span><span class="op">(</span><span class="va">config</span><span class="op">)</span></span>
<span><span class="va">new_reg</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;keras.src.regularizers.regularizers.L1 object&gt;</span></span>
<span><span class="co">##  signature: (x)</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="model-weights-saving">Model weights saving<a class="anchor" aria-label="anchor" href="#model-weights-saving"></a>
</h3>
<p>You can choose to only save &amp; load a model’s weights. This can be
useful if:</p>
<ul>
<li>You only need the model for inference: in this case you won’t need
to restart training, so you don’t need the compilation information or
optimizer state.</li>
<li>You are doing transfer learning: in this case you will be training a
new model reusing the state of a prior model, so you don’t need the
compilation information of the prior model.</li>
</ul>
<div class="section level4">
<h4 id="apis-for-in-memory-weight-transfer">APIs for in-memory weight transfer<a class="anchor" aria-label="anchor" href="#apis-for-in-memory-weight-transfer"></a>
</h4>
<p>Weights can be copied between different objects by using
<code><a href="../reference/get_weights.html">get_weights()</a></code> and <code><a href="../reference/get_weights.html">set_weights()</a></code>:</p>
<ul>
<li>
<code>get_weights(&lt;layer&gt;)</code>: Returns a list of arrays of
weight values.</li>
<li>
<code>set_weights(&lt;layer&gt;weights)</code>: Sets the model/layer
weights to the values provided (as arrays).</li>
</ul>
<p>Examples:</p>
<p><strong><em>Transferring weights from one layer to another, in
memory</em></strong></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">create_layer</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">layer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>, <span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, name <span class="op">=</span> <span class="st">"dense_2"</span><span class="op">)</span></span>
<span>  <span class="va">layer</span><span class="op">$</span><span class="fu">build</span><span class="op">(</span><span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">784</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">layer</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">layer_1</span> <span class="op">&lt;-</span> <span class="fu">create_layer</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">layer_2</span> <span class="op">&lt;-</span> <span class="fu">create_layer</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Copy weights from layer 1 to layer 2</span></span>
<span><span class="va">layer_2</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/get_weights.html">set_weights</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_weights.html">get_weights</a></span><span class="op">(</span><span class="va">layer_1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong><em>Transferring weights from one model to another model with
a compatible architecture, in memory</em></strong></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a simple functional model</span></span>
<span><span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">784</span><span class="op">)</span>, name<span class="op">=</span><span class="st">"digits"</span><span class="op">)</span></span>
<span><span class="va">outputs</span> <span class="op">&lt;-</span> <span class="va">inputs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, name <span class="op">=</span> <span class="st">"dense_1"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, name <span class="op">=</span> <span class="st">"dense_2"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">10</span>, name <span class="op">=</span> <span class="st">"predictions"</span><span class="op">)</span></span>
<span><span class="va">functional_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">inputs</span>, outputs <span class="op">=</span> <span class="va">outputs</span>,</span>
<span>                               name <span class="op">=</span> <span class="st">"3_layer_mlp"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define a subclassed model with the same architecture</span></span>
<span><span class="va">SubclassedModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_model_class.html">new_model_class</a></span><span class="op">(</span></span>
<span>  <span class="st">"SubclassedModel"</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">output_dim</span>, <span class="va">name</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span>name <span class="op">=</span> <span class="va">name</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">output_dim</span> <span class="op">&lt;-</span> <span class="va">output_dim</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">dense_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>, <span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span>,</span>
<span>                                name <span class="op">=</span> <span class="st">"dense_1"</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">dense_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>, <span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span>,</span>
<span>                                name <span class="op">=</span> <span class="st">"dense_2"</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">dense_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>, <span class="va">self</span><span class="op">$</span><span class="va">output_dim</span>,</span>
<span>                                name <span class="op">=</span> <span class="st">"predictions"</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  call <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">inputs</span> <span class="op">|&gt;</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="fu">dense_1</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="fu">dense_2</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="fu">dense_3</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  get_config <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">self</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>output_dim <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">output_dim</span>,</span>
<span>         name <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">subclassed_model</span> <span class="op">&lt;-</span> <span class="fu">SubclassedModel</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co"># Call the subclassed model once to create the weights.</span></span>
<span><span class="fu">subclassed_model</span><span class="op">(</span><span class="fu"><a href="../reference/op_ones.html">op_ones</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">784</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Copy weights from functional_model to subclassed_model.</span></span>
<span><span class="fu"><a href="../reference/get_weights.html">set_weights</a></span><span class="op">(</span><span class="va">subclassed_model</span>, <span class="fu"><a href="../reference/get_weights.html">get_weights</a></span><span class="op">(</span><span class="va">functional_model</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/get_weights.html">get_weights</a></span><span class="op">(</span><span class="va">functional_model</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/get_weights.html">get_weights</a></span><span class="op">(</span><span class="va">subclassed_model</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong><em>The case of stateless layers</em></strong></p>
<p>Because stateless layers do not change the order or number of
weights, models can have compatible architectures even if there are
extra/missing stateless layers.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">784</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"digits"</span><span class="op">)</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="va">input</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, name <span class="op">=</span> <span class="st">"dense_1"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, name <span class="op">=</span> <span class="st">"dense_2"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">10</span>, name <span class="op">=</span> <span class="st">"predictions"</span><span class="op">)</span></span>
<span><span class="va">functional_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">outputs</span>,</span>
<span>                                name <span class="op">=</span> <span class="st">"3_layer_mlp"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">784</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"digits"</span><span class="op">)</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="va">input</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, name <span class="op">=</span> <span class="st">"dense_1"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, name <span class="op">=</span> <span class="st">"dense_2"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Add a dropout layer, which does not contain any weights.</span></span>
<span>  <span class="fu"><a href="../reference/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">10</span>, name <span class="op">=</span> <span class="st">"predictions"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">functional_model_with_dropout</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, name <span class="op">=</span> <span class="st">"3_layer_mlp"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/get_weights.html">set_weights</a></span><span class="op">(</span><span class="va">functional_model_with_dropout</span>,</span>
<span>            <span class="fu"><a href="../reference/get_weights.html">get_weights</a></span><span class="op">(</span><span class="va">functional_model</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="apis-for-saving-weights-to-disk-loading-them-back">APIs for saving weights to disk &amp; loading them back<a class="anchor" aria-label="anchor" href="#apis-for-saving-weights-to-disk-loading-them-back"></a>
</h4>
<p>Weights can be saved to disk by calling
<code>save_model_weights(filepath)</code>. The filename should end in
<code>.weights.h5</code>.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sequential_model</span> <span class="op">=</span> <span class="fu"><a href="../reference/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span>input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">784</span><span class="op">)</span>,</span>
<span>                                          input_name <span class="op">=</span> <span class="st">"digits"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, name <span class="op">=</span> <span class="st">"dense_1"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, name <span class="op">=</span> <span class="st">"dense_2"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">10</span>, name <span class="op">=</span> <span class="st">"predictions"</span><span class="op">)</span></span>
<span><span class="va">sequential_model</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/save_model_weights.html">save_model_weights</a></span><span class="op">(</span><span class="st">"my_model.weights.h5"</span><span class="op">)</span></span>
<span><span class="va">sequential_model</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/load_model_weights.html">load_model_weights</a></span><span class="op">(</span><span class="st">"my_model.weights.h5"</span><span class="op">)</span></span></code></pre></div>
<p>Note that using <code><a href="../reference/freeze_weights.html">freeze_weights()</a></code> may result in a
different output from <code>get_weights(layer)</code> ordering when the
model contains nested layers.</p>
<div class="section level5">
<h5 id="transfer-learning-example">
<strong>Transfer learning example</strong><a class="anchor" aria-label="anchor" href="#transfer-learning-example"></a>
</h5>
<p>When loading pretrained weights from a weights file, it is
recommended to load the weights into the original checkpointed model,
and then extract the desired weights/layers into a new model.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">create_functional_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">784</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"digits"</span><span class="op">)</span></span>
<span>  <span class="va">outputs</span> <span class="op">&lt;-</span> <span class="va">inputs</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, name <span class="op">=</span> <span class="st">"dense_1"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">64</span>, activation <span class="op">=</span> <span class="st">"relu"</span>, name <span class="op">=</span> <span class="st">"dense_2"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">10</span>, name <span class="op">=</span> <span class="st">"predictions"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">outputs</span>, name <span class="op">=</span> <span class="st">"3_layer_mlp"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">functional_model</span> <span class="op">&lt;-</span> <span class="fu">create_functional_model</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">functional_model</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/save_model_weights.html">save_model_weights</a></span><span class="op">(</span><span class="st">"pretrained.weights.h5"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># In a separate program:</span></span>
<span><span class="va">pretrained_model</span> <span class="op">&lt;-</span> <span class="fu">create_functional_model</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pretrained_model</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/load_model_weights.html">load_model_weights</a></span><span class="op">(</span><span class="st">"pretrained.weights.h5"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a new model by extracting layers from the original model:</span></span>
<span><span class="va">extracted_layers</span> <span class="op">&lt;-</span> <span class="va">pretrained_model</span><span class="op">$</span><span class="va">layers</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span>layers <span class="op">=</span> <span class="va">extracted_layers</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">5</span>, name <span class="op">=</span> <span class="st">"dense_3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="font-weight: bold;">Model: "sequential_4"</span></span></span>
<span><span class="co">## ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓</span></span>
<span><span class="co">## ┃<span style="font-weight: bold;"> Layer (type)                    </span>┃<span style="font-weight: bold;"> Output Shape           </span>┃<span style="font-weight: bold;">       Param # </span>┃</span></span>
<span><span class="co">## ┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩</span></span>
<span><span class="co">## │ dense_1 (<span style="color: #0087FF;">Dense</span>)                 │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">64</span>)             │        <span style="color: #00AF00;">50,240</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ dense_2 (<span style="color: #0087FF;">Dense</span>)                 │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">64</span>)             │         <span style="color: #00AF00;">4,160</span> │</span></span>
<span><span class="co">## ├─────────────────────────────────┼────────────────────────┼───────────────┤</span></span>
<span><span class="co">## │ dense_3 (<span style="color: #0087FF;">Dense</span>)                 │ (<span style="color: #00D7FF;">None</span>, <span style="color: #00AF00;">5</span>)              │           <span style="color: #00AF00;">325</span> │</span></span>
<span><span class="co">## └─────────────────────────────────┴────────────────────────┴───────────────┘</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Total params: </span><span style="color: #00AF00;">54,725</span> (213.77 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Trainable params: </span><span style="color: #00AF00;">54,725</span> (213.77 KB)</span></span>
<span><span class="co">## <span style="font-weight: bold;"> Non-trainable params: </span><span style="color: #00AF00;">0</span> (0.00 B)</span></span></code></pre>
</div>
</div>
</div>
<div class="section level3">
<h3 id="appendix-handling-custom-objects">Appendix: Handling custom objects<a class="anchor" aria-label="anchor" href="#appendix-handling-custom-objects"></a>
</h3>
<!-- <a name="config_methods"></a> -->
<div class="section level4">
<h4 id="defining-the-config-methods">Defining the config methods<a class="anchor" aria-label="anchor" href="#defining-the-config-methods"></a>
</h4>
<p>Specifications:</p>
<ul>
<li>
<code><a href="../reference/get_config.html">get_config()</a></code> should return a JSON-serializable named
list in order to be compatible with the Keras architecture and
model-saving APIs.</li>
<li>
<code>from_config(config)</code> (a class method) should return a
new layer or model object that is created from the config. The default
implementation returns <code>do.call(cls, config)</code>.</li>
</ul>
<p><strong>NOTE</strong>: If all your constructor arguments are already
serializable, e.g. strings and ints, or non-custom Keras objects,
overriding <code><a href="../reference/get_config.html">from_config()</a></code> is not necessary. However, for
more complex objects such as layers or models passed to
<code>initialize()</code>, deserialization must be handled explicitly
either in <code>initialize</code> itself or overriding the
<code><a href="../reference/get_config.html">from_config()</a></code> method.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">layer_my_dense</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/register_keras_serializable.html">register_keras_serializable</a></span><span class="op">(</span></span>
<span>  package <span class="op">=</span> <span class="st">"MyLayers"</span>, name <span class="op">=</span> <span class="st">"KernelMult"</span>,</span>
<span>  object <span class="op">=</span> <span class="fu"><a href="../reference/Layer.html">Layer</a></span><span class="op">(</span></span>
<span>    <span class="st">"MyDense"</span>,</span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">units</span>,</span>
<span>                          <span class="va">...</span>,</span>
<span>                          <span class="va">kernel_regularizer</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                          <span class="va">kernel_initializer</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                          <span class="va">nested_model</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">hidden_units</span> <span class="op">&lt;-</span> <span class="va">units</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">kernel_regularizer</span> <span class="op">&lt;-</span> <span class="va">kernel_regularizer</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">kernel_initializer</span> <span class="op">&lt;-</span> <span class="va">kernel_initializer</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">nested_model</span> <span class="op">&lt;-</span> <span class="va">nested_model</span></span>
<span>    <span class="op">}</span>,</span>
<span>    get_config <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">config</span> <span class="op">&lt;-</span> <span class="va">super</span><span class="op">$</span><span class="fu">get_config</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="co"># Update the config with the custom layer's parameters</span></span>
<span>      <span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/modifyList.html" class="external-link">modifyList</a></span><span class="op">(</span><span class="va">config</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        units <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">hidden_units</span>,</span>
<span>        kernel_regularizer <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">kernel_regularizer</span>,</span>
<span>        kernel_initializer <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">kernel_initializer</span>,</span>
<span>        nested_model <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">nested_model</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">config</span></span>
<span>    <span class="op">}</span>,</span>
<span>    build <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">input_shape</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">input_units</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">input_shape</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">kernel</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">add_weight</span><span class="op">(</span></span>
<span>        name <span class="op">=</span> <span class="st">"kernel"</span>,</span>
<span>        shape <span class="op">=</span> <span class="fu"><a href="../reference/shape.html">shape</a></span><span class="op">(</span><span class="va">input_units</span>, <span class="va">self</span><span class="op">$</span><span class="va">hidden_units</span><span class="op">)</span>,</span>
<span>        regularizer <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">kernel_regularizer</span>,</span>
<span>        initializer <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">kernel_initializer</span>,</span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    call <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="../reference/op_matmul.html">op_matmul</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">self</span><span class="op">$</span><span class="va">kernel</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">layer</span> <span class="op">&lt;-</span> <span class="fu">layer_my_dense</span><span class="op">(</span>units <span class="op">=</span> <span class="fl">16</span>,</span>
<span>                        kernel_regularizer <span class="op">=</span> <span class="st">"l1"</span>,</span>
<span>                        kernel_initializer <span class="op">=</span> <span class="st">"ones"</span><span class="op">)</span></span>
<span><span class="va">layer3</span> <span class="op">&lt;-</span> <span class="fu">layer_my_dense</span><span class="op">(</span>units <span class="op">=</span> <span class="fl">64</span>, nested_model <span class="op">=</span> <span class="va">layer</span><span class="op">)</span></span>
<span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/serialize_keras_object.html">serialize_keras_object</a></span><span class="op">(</span><span class="va">layer3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">config</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 4</span></span>
<span><span class="co">##  $ module         : chr "&lt;r-globalenv&gt;"</span></span>
<span><span class="co">##  $ class_name     : chr "MyDense"</span></span>
<span><span class="co">##  $ config         :List of 5</span></span>
<span><span class="co">##   ..$ name        : chr "my_dense_1"</span></span>
<span><span class="co">##   ..$ trainable   : logi TRUE</span></span>
<span><span class="co">##   ..$ dtype       :List of 4</span></span>
<span><span class="co">##   .. ..$ module         : chr "keras"</span></span>
<span><span class="co">##   .. ..$ class_name     : chr "DTypePolicy"</span></span>
<span><span class="co">##   .. ..$ config         :List of 1</span></span>
<span><span class="co">##   .. .. ..$ name: chr "float32"</span></span>
<span><span class="co">##   .. ..$ registered_name: NULL</span></span>
<span><span class="co">##   ..$ units       : num 64</span></span>
<span><span class="co">##   ..$ nested_model:List of 4</span></span>
<span><span class="co">##   .. ..$ module         : chr "&lt;r-globalenv&gt;"</span></span>
<span><span class="co">##   .. ..$ class_name     : chr "MyDense"</span></span>
<span><span class="co">##   .. ..$ config         :List of 6</span></span>
<span><span class="co">##   .. .. ..$ name              : chr "my_dense"</span></span>
<span><span class="co">##   .. .. ..$ trainable         : logi TRUE</span></span>
<span><span class="co">##   .. .. ..$ dtype             :List of 4</span></span>
<span><span class="co">##   .. .. .. ..$ module         : chr "keras"</span></span>
<span><span class="co">##   .. .. .. ..$ class_name     : chr "DTypePolicy"</span></span>
<span><span class="co">##   .. .. .. ..$ config         :List of 1</span></span>
<span><span class="co">##   .. .. .. .. ..$ name: chr "float32"</span></span>
<span><span class="co">##   .. .. .. ..$ registered_name: NULL</span></span>
<span><span class="co">##   .. .. ..$ units             : num 16</span></span>
<span><span class="co">##   .. .. ..$ kernel_regularizer: chr "l1"</span></span>
<span><span class="co">##   .. .. ..$ kernel_initializer: chr "ones"</span></span>
<span><span class="co">##   .. ..$ registered_name: chr "MyLayers&gt;KernelMult"</span></span>
<span><span class="co">##  $ registered_name: chr "MyLayers&gt;KernelMult"</span></span></code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_layer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/deserialize_keras_object.html">deserialize_keras_object</a></span><span class="op">(</span><span class="va">config</span><span class="op">)</span></span>
<span><span class="va">new_layer</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;MyDense name=my_dense_1, built=False&gt;</span></span>
<span><span class="co">##  signature: (*args, **kwargs)</span></span></code></pre>
<p>Note that overriding <code>from_config</code> is unnecessary above
for <code>MyDense</code> because <code>hidden_units</code>,
<code>kernel_initializer</code>, and <code>kernel_regularizer</code> are
ints, strings, and a built-in Keras object, respectively. This means
that the default <code>from_config</code> implementation of
<code>cls(!!!config)</code> will work as intended.</p>
<p>For more complex objects, such as layers and models passed to
<code>initialize()</code>, for example, you must explicitly deserialize
these objects. Let’s take a look at an example of a model where a
<code>from_config</code> override is necessary.</p>
<p><strong>Example:</strong>
<!-- <a name="registration_example"></a> --></p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`%||%`</span> <span class="op">&lt;-</span> \<span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">y</span> <span class="kw">else</span> <span class="va">x</span></span>
<span><span class="va">layer_custom_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/register_keras_serializable.html">register_keras_serializable</a></span><span class="op">(</span></span>
<span>  package <span class="op">=</span> <span class="st">"ComplexModels"</span>,</span>
<span>  object <span class="op">=</span> <span class="fu"><a href="../reference/Layer.html">Layer</a></span><span class="op">(</span></span>
<span>    <span class="st">"CustomModel"</span>,</span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">first_layer</span>, <span class="va">second_layer</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">first_layer</span> <span class="op">&lt;-</span> <span class="va">first_layer</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">second_layer</span> <span class="op">&lt;-</span> <span class="va">second_layer</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span>, <span class="fl">8</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    get_config <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">config</span> <span class="op">&lt;-</span> <span class="va">super</span><span class="op">$</span><span class="fu">get_config</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/modifyList.html" class="external-link">modifyList</a></span><span class="op">(</span><span class="va">config</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        first_layer <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">first_layer</span>,</span>
<span>        second_layer <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">second_layer</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">config</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    from_config <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">config</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">config</span><span class="op">$</span><span class="va">first_layer</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/deserialize_keras_object.html">deserialize_keras_object</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">config</span><span class="op">$</span><span class="va">second_layer</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html" class="external-link">%&lt;&gt;%</a></span> <span class="fu"><a href="../reference/deserialize_keras_object.html">deserialize_keras_object</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="co"># note that the class is available in methods under the classname symbol,</span></span>
<span>      <span class="co"># (`CustomModel` for this class), and also under the symbol `__class__`</span></span>
<span>      <span class="fu">cls</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">config</span><span class="op">)</span></span>
<span>      <span class="co"># CustomModel(!!!config)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    call <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">self</span>, <span class="va">inputs</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">inputs</span> <span class="op">|&gt;</span></span>
<span>        <span class="va">self</span><span class="op">$</span><span class="fu">first_layer</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="va">self</span><span class="op">$</span><span class="fu">second_layer</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Let's make our first layer the custom layer from the previous example (MyDense)</span></span>
<span><span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_input.html">keras_input</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">32</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">outputs</span> <span class="op">&lt;-</span>  <span class="va">inputs</span> <span class="op">|&gt;</span> <span class="fu">layer_custom_model</span><span class="op">(</span>first_layer<span class="op">=</span><span class="va">layer</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">outputs</span><span class="op">)</span></span>
<span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_config.html">get_config</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="va">new_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_config.html">from_config</a></span><span class="op">(</span><span class="va">config</span><span class="op">)</span></span></code></pre></div>
<!-- <a name="custom_object_serialization"></a> -->
</div>
<div class="section level4">
<h4 id="how-custom-objects-are-serialized">How custom objects are serialized<a class="anchor" aria-label="anchor" href="#how-custom-objects-are-serialized"></a>
</h4>
<p>The serialization format has a special key for custom objects
registered via <code><a href="../reference/register_keras_serializable.html">register_keras_serializable()</a></code>. This
<code>registered_name</code> key allows for easy retrieval at
loading/deserialization time while also allowing users to add custom
naming.</p>
<p>Let’s take a look at the config from serializing the custom layer
<code>MyDense</code> we defined above.</p>
<p><strong>Example</strong>:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">layer</span> <span class="op">&lt;-</span> <span class="fu">layer_my_dense</span><span class="op">(</span></span>
<span>  units <span class="op">=</span> <span class="fl">16</span>,</span>
<span>  kernel_regularizer <span class="op">=</span> <span class="fu"><a href="../reference/regularizer_l1_l2.html">regularizer_l1_l2</a></span><span class="op">(</span>l1 <span class="op">=</span> <span class="fl">1e-5</span>, l2 <span class="op">=</span> <span class="fl">1e-4</span><span class="op">)</span>,</span>
<span>  kernel_initializer <span class="op">=</span> <span class="st">"ones"</span>,</span>
<span><span class="op">)</span></span>
<span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/serialize_keras_object.html">serialize_keras_object</a></span><span class="op">(</span><span class="va">layer</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">config</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 4</span></span>
<span><span class="co">##  $ module         : chr "&lt;r-globalenv&gt;"</span></span>
<span><span class="co">##  $ class_name     : chr "MyDense"</span></span>
<span><span class="co">##  $ config         :List of 6</span></span>
<span><span class="co">##   ..$ name              : chr "my_dense_2"</span></span>
<span><span class="co">##   ..$ trainable         : logi TRUE</span></span>
<span><span class="co">##   ..$ dtype             :List of 4</span></span>
<span><span class="co">##   .. ..$ module         : chr "keras"</span></span>
<span><span class="co">##   .. ..$ class_name     : chr "DTypePolicy"</span></span>
<span><span class="co">##   .. ..$ config         :List of 1</span></span>
<span><span class="co">##   .. .. ..$ name: chr "float32"</span></span>
<span><span class="co">##   .. ..$ registered_name: NULL</span></span>
<span><span class="co">##   ..$ units             : num 16</span></span>
<span><span class="co">##   ..$ kernel_regularizer:List of 4</span></span>
<span><span class="co">##   .. ..$ module         : chr "keras.regularizers"</span></span>
<span><span class="co">##   .. ..$ class_name     : chr "L1L2"</span></span>
<span><span class="co">##   .. ..$ config         :List of 2</span></span>
<span><span class="co">##   .. .. ..$ l1: num 1e-05</span></span>
<span><span class="co">##   .. .. ..$ l2: num 1e-04</span></span>
<span><span class="co">##   .. ..$ registered_name: NULL</span></span>
<span><span class="co">##   ..$ kernel_initializer: chr "ones"</span></span>
<span><span class="co">##  $ registered_name: chr "MyLayers&gt;KernelMult"</span></span></code></pre>
<p>As shown, the <code>registered_name</code> key contains the lookup
information for the Keras master list, including the package
<code>MyLayers</code> and the custom name <code>KernelMult</code> that
we gave when calling <code>register_keras_serializables()</code>. Take a
look again at the custom class definition/registration <a href="#registration_example">here</a>.</p>
<p>Note that the <code>class_name</code> key contains the original name
of the class, allowing for proper re-initialization in
<code>from_config</code>.</p>
<p>Additionally, note that the <code>module</code> key is
<code>NULL</code> since this is a custom object.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Tomasz Kalinowski, JJ Allaire, François Chollet, Posit Software, PBC, Google.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
