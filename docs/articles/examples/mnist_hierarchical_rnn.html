<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mnist_hierarchical_rnn.R • keras</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../jquery.sticky-kit.min.js"></script><script src="../../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../index.html">Keras for R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Getting Started</li>
    <li>
      <a href="../../articles/sequential_model.html">Guide to the Sequential Model</a>
    </li>
    <li>
      <a href="../../articles/functional_api.html">Guide to the Functional API</a>
    </li>
    <li>
      <a href="../../articles/faq.html">Frequently Asked Questions</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Using Keras</li>
    <li>
      <a href="../../articles/about_keras_models.html">About Keras Models</a>
    </li>
    <li>
      <a href="../../articles/about_keras_layers.html">About Keras Layers</a>
    </li>
    <li>
      <a href="../../articles/applications.html">Pre-Trained Models</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Advanced</li>
    <li>
      <a href="../../articles/training_callbacks.html">Training Callbacks</a>
    </li>
    <li>
      <a href="../../articles/backend.html">Backend Functions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../articles/examples/index.html">Examples</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/keras">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>mnist_hierarchical_rnn.R</h1>
            
          </div>

    
    
<div class="contents">
<p>This is an example of using Hierarchical RNN (HRNN) to classify MNIST digits.</p>
<p>HRNNs can learn across multiple levels of temporal hiearchy over a complex sequence. Usually, the first recurrent layer of an HRNN encodes a sentence (e.g. of word vectors) into a sentence vector. The second recurrent layer then encodes a sequence of such vectors (encoded by the first layer) into a document vector. This document vector is considered to preserve both the word-level and sentence-level structure of the context.</p>
<p>References:</p>
<ul>
<li>
<a href="https://arxiv.org/abs/1506.01057">A Hierarchical Neural Autoencoder for Paragraphs and Documents</a> Encodes paragraphs and documents with HRNN. Results have shown that HRNN outperforms standard RNNs and may play some role in more sophisticated generation tasks like summarization or question answering.</li>
<li>
<a href="http://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&amp;arnumber=7298714">Hierarchical recurrent neural network for skeleton based action recognition</a> Achieved state-of-the-art results on skeleton based action recognition with 3 levels of bidirectional HRNN combined with fully connected layers.</li>
</ul>
<p>In the below MNIST example the first LSTM layer first encodes every column of pixels of shape (28, 1) to a column vector of shape (128,). The second LSTM layer encodes then these 28 column vectors of shape (28, 128) to a image vector representing the whole image. A final Dense layer is added for prediction.</p>
<p>After 5 epochs: train acc: 0.9858, val acc: 0.9864</p>
<p>IMPORTANT NOTE: This example does net work correctly with the version of Keras integrated with TensorFlow (the Python variation doesn’t work either). Therefore, we shouldn’t yet add this to the list of published examples.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(keras)

<span class="co"># Training parameters.</span>
batch_size &lt;-<span class="st"> </span><span class="dv">32</span>
num_classes &lt;-<span class="st"> </span><span class="dv">10</span>
epochs &lt;-<span class="st"> </span><span class="dv">5</span>

<span class="co"># Embedding dimensions.</span>
row_hidden &lt;-<span class="st"> </span><span class="dv">128</span>
col_hidden &lt;-<span class="st"> </span><span class="dv">128</span>

<span class="co"># the data, shuffled and split between train and test sets</span>
mnist &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/dataset_mnist.html">dataset_mnist</a></span>()
x_train &lt;-<span class="st"> </span>mnist<span class="op">$</span>train<span class="op">$</span>x
y_train &lt;-<span class="st"> </span>mnist<span class="op">$</span>train<span class="op">$</span>y
x_test &lt;-<span class="st"> </span>mnist<span class="op">$</span>test<span class="op">$</span>x
y_test &lt;-<span class="st"> </span>mnist<span class="op">$</span>test<span class="op">$</span>y

<span class="co"># Reshapes data to 4D for Hierarchical RNN.</span>
x_train &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="kw">as.numeric</span>(x_train), <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">dim</span>(x_train)[[<span class="dv">1</span>]], <span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>))
x_test &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="kw">as.numeric</span>(x_test), <span class="dt">dim =</span> <span class="kw">c</span>(<span class="kw">dim</span>(x_test)[[<span class="dv">1</span>]], <span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>))
x_train &lt;-<span class="st"> </span>x_train <span class="op">/</span><span class="st"> </span><span class="dv">255</span>
x_test &lt;-<span class="st"> </span>x_test <span class="op">/</span><span class="st"> </span><span class="dv">255</span>

dim_x_train &lt;-<span class="st"> </span><span class="kw">dim</span>(x_train)
<span class="kw">cat</span>(<span class="st">'x_train_shape:'</span>, dim_x_train)
<span class="kw">cat</span>(dim_x_train[[<span class="dv">1</span>]], <span class="st">'train samples'</span>)
<span class="kw">cat</span>(<span class="kw">dim</span>(x_test)[[<span class="dv">1</span>]], <span class="st">'test samples'</span>)

<span class="co"># Converts class vectors to binary class matrices</span>
y_train &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/to_categorical.html">to_categorical</a></span>(y_train, num_classes)
y_test &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/to_categorical.html">to_categorical</a></span>(y_test, num_classes)

row &lt;-<span class="st"> </span>dim_x_train[[<span class="dv">2</span>]]
col &lt;-<span class="st"> </span>dim_x_train[[<span class="dv">3</span>]]
pixel &lt;-<span class="st"> </span>dim_x_train[[<span class="dv">4</span>]]

<span class="co"># Model input (4D)</span>
input &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/layer_input.html">layer_input</a></span>(<span class="dt">shape =</span> <span class="kw">c</span>(row, col, pixel))

<span class="co"># Encodes a row of pixels using TimeDistributed Wrapper</span>
encoded_rows &lt;-<span class="st"> </span>input <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/time_distributed.html">time_distributed</a></span>(<span class="kw"><a href="../../reference/layer_lstm.html">layer_lstm</a></span>(<span class="dt">units =</span> row_hidden))

<span class="co"># Encodes columns of encoded rows.</span>
encoded_columns &lt;-<span class="st"> </span>encoded_rows <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/layer_lstm.html">layer_lstm</a></span>(<span class="dt">units =</span> col_hidden)

<span class="co"># Model output</span>
prediction &lt;-<span class="st"> </span>encoded_columns <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../../reference/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> num_classes, <span class="dt">activation =</span> <span class="st">'softmax'</span>)

<span class="co"># Define and compile model</span>
model &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/keras_model.html">keras_model</a></span>(input, prediction)
model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/compile.html">compile</a></span>(
  <span class="dt">loss =</span> <span class="st">'categorical_crossentropy'</span>,
  <span class="dt">optimizer =</span> <span class="st">'rmsprop'</span>,
  <span class="dt">metrics =</span> <span class="kw">c</span>(<span class="st">'accuracy'</span>)
)

<span class="co"># Training</span>
model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/fit.html">fit</a></span>(
  x_train, y_train,
  <span class="dt">batch_size =</span> batch_size,
  <span class="dt">epochs =</span> epochs,
  <span class="dt">verbose =</span> <span class="dv">1</span>,
  <span class="dt">validation_data =</span> <span class="kw">list</span>(x_test, y_test)
)

<span class="co"># Evaluation</span>
scores &lt;-<span class="st"> </span>model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/evaluate.html">evaluate</a></span>(x_test, y_test, <span class="dt">verbose =</span> <span class="dv">0</span>)
<span class="kw">cat</span>(<span class="st">'Test loss:'</span>, scores[[<span class="dv">1</span>]], <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)
<span class="kw">cat</span>(<span class="st">'Test accuracy:'</span>, scores[<span class="dv">2</span>], <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by JJ Allaire, François Chollet, <a href="https://www.rstudio.com"><img src="http://tidyverse.org/rstudio-logo.svg" height="24"></a>,  Google.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
