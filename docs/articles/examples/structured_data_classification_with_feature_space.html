<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Classify tabular data in a few lines of code.">
<title>Structured data classification with FeatureSpace • keras3</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/Fira_Mono-0.4.9/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Structured data classification with FeatureSpace">
<meta property="og:description" content="Classify tabular data in a few lines of code.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar fixed-top navbar-inverse navbar-expand-lg bg-primary"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">keras3</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../articles/getting_started.html">Getting Started</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-guides">Guides</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-guides">
    <h6 class="dropdown-header" data-toc-skip>Model definition</h6>
    <a class="dropdown-item" href="../../articles/sequential_model.html">Sequential Model</a>
    <a class="dropdown-item" href="../../articles/functional_api.html">Functional API</a>
    <h6 class="dropdown-header" data-toc-skip>Extending and customizing</h6>
    <a class="dropdown-item" href="../../articles/training_with_built_in_methods.html">Training &amp; evaluation with the built-in methods</a>
    <a class="dropdown-item" href="../../articles/custom_train_step_in_tensorflow.html">Customizing `fit()` with Tensorflow</a>
    <a class="dropdown-item" href="../../articles/writing_your_own_callbacks.html">Writing your own callbacks</a>
    <a class="dropdown-item" href="../../articles/making_new_layers_and_models_via_subclassing.html">Making new layers and models via subclassing</a>
    <a class="dropdown-item" href="../../articles/writing_a_custom_training_loop_in_tensorflow.html">Writing a training loop from scratch in TensorFlow</a>
    <a class="dropdown-item" href="../../articles/serialization_and_saving.html">Serialization and Saving</a>
    <h6 class="dropdown-header" data-toc-skip>Other topics</h6>
    <a class="dropdown-item" href="../../articles/transfer_learning.html">Transfer learning and fine tuning</a>
    <a class="dropdown-item" href="../../articles/distributed_training_with_tensorflow.html">Distributed training with TensorFlow</a>
    <a class="dropdown-item" href="../../articles/distribution.html">Distributed training with Jax</a>
  </div>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../../articles/examples/index.html">Examples</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../news/index.html">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rstudio/keras/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Structured data classification with FeatureSpace</h1>


      <small class="dont-index">Source: <a href="https://github.com/rstudio/keras/blob/HEAD/vignettes-src/examples/structured_data_classification_with_feature_space.Rmd" class="external-link"><code>vignettes-src/examples/structured_data_classification_with_feature_space.Rmd</code></a></small>
      <div class="d-none name"><code>structured_data_classification_with_feature_space.Rmd</code></div>
    </div>



<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This example demonstrates how to do structured data classification
(also known as tabular data classification), starting from a raw CSV
file. Our data includes numerical features, and integer categorical
features, and string categorical features. We will use the utility
<code><a href="../../reference/layer_feature_space.html">layer_feature_space()</a></code> to index, preprocess, and encode our
features.</p>
<p>The code is adapted from the example <a href="https://keras.io/examples/structured_data/structured_data_classification_from_scratch/" class="external-link">Structured
data classification from scratch</a>. While the previous example managed
its own low-level feature preprocessing and encoding with Keras
preprocessing layers, in this example we delegate everything to
<code><a href="../../reference/layer_feature_space.html">layer_feature_space()</a></code>, making the workflow extremely quick
and easy.</p>
<div class="section level3">
<h3 id="the-dataset">The dataset<a class="anchor" aria-label="anchor" href="#the-dataset"></a>
</h3>
<p><a href="https://archive.ics.uci.edu/ml/datasets/heart+Disease" class="external-link">Our
dataset</a> is provided by the Cleveland Clinic Foundation for Heart
Disease. It’s a CSV file with 303 rows. Each row contains information
about a patient (a <strong>sample</strong>), and each column describes
an attribute of the patient (a <strong>feature</strong>). We use the
features to predict whether a patient has a heart disease
(<strong>binary classification</strong>).</p>
<p>Here’s the description of each feature:</p>
<table class="table">
<colgroup>
<col width="22%">
<col width="37%">
<col width="40%">
</colgroup>
<thead><tr class="header">
<th>Column</th>
<th>Description</th>
<th>Feature Type</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Age</td>
<td>Age in years</td>
<td>Numerical</td>
</tr>
<tr class="even">
<td>Sex</td>
<td>(1 = male; 0 = female)</td>
<td>Categorical</td>
</tr>
<tr class="odd">
<td>CP</td>
<td>Chest pain type (0, 1, 2, 3, 4)</td>
<td>Categorical</td>
</tr>
<tr class="even">
<td>Trestbpd</td>
<td>Resting blood pressure (in mm Hg on admission)</td>
<td>Numerical</td>
</tr>
<tr class="odd">
<td>Chol</td>
<td>Serum cholesterol in mg/dl</td>
<td>Numerical</td>
</tr>
<tr class="even">
<td>FBS</td>
<td>fasting blood sugar in 120 mg/dl (1 = true; 0 = false)</td>
<td>Categorical</td>
</tr>
<tr class="odd">
<td>RestECG</td>
<td>Resting electrocardiogram results (0, 1, 2)</td>
<td>Categorical</td>
</tr>
<tr class="even">
<td>Thalach</td>
<td>Maximum heart rate achieved</td>
<td>Numerical</td>
</tr>
<tr class="odd">
<td>Exang</td>
<td>Exercise induced angina (1 = yes; 0 = no)</td>
<td>Categorical</td>
</tr>
<tr class="even">
<td>Oldpeak</td>
<td>ST depression induced by exercise relative to rest</td>
<td>Numerical</td>
</tr>
<tr class="odd">
<td>Slope</td>
<td>Slope of the peak exercise ST segment</td>
<td>Numerical</td>
</tr>
<tr class="even">
<td>CA</td>
<td>Number of major vessels (0-3) colored by fluoroscopy</td>
<td>Both numerical &amp; categorical</td>
</tr>
<tr class="odd">
<td>Thal</td>
<td>3 = normal; 6 = fixed defect; 7 = reversible defect</td>
<td>Categorical</td>
</tr>
<tr class="even">
<td>Target</td>
<td>Diagnosis of heart disease (1 = true; 0 = false)</td>
<td>Target</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keras3.posit.co/">keras3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow" class="external-link">tensorflow</a></span>, exclude <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"shape"</span>, <span class="st">"set_random_seed"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tfdatasets" class="external-link">tfdatasets</a></span>, exclude <span class="op">=</span> <span class="st">"shape"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">conflicted</span><span class="fu">::</span><span class="fu"><a href="https://conflicted.r-lib.org/reference/conflicts_prefer.html" class="external-link">conflicts_prefer</a></span><span class="op">(</span></span>
<span>  <span class="fu">keras3</span><span class="fu">::</span><span class="fu"><a href="../../reference/shape.html">shape</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">keras3</span><span class="fu">::</span><span class="fu"><a href="../../reference/set_random_seed.html">set_random_seed</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  .quiet <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../../reference/use_backend.html">use_backend</a></span><span class="op">(</span><span class="st">"tensorflow"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="preparing-the-data">Preparing the data<a class="anchor" aria-label="anchor" href="#preparing-the-data"></a>
</h2>
<p>Let’s download the data and load it into a Pandas dataframe:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file_url</span> <span class="op">&lt;-</span></span>
<span>  <span class="st">"http://storage.googleapis.com/download.tensorflow.org/data/heart.csv"</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">file_url</span>, col_types <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html" class="external-link">cols</a></span><span class="op">(</span></span>
<span>  oldpeak <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_double</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  thal <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  .default <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/parse_atomic.html" class="external-link">col_integer</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># the dataset has two malformed rows, filter them out</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">thal</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1"</span>, <span class="st">"2"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The dataset includes 303 samples with 14 columns per sample (13
features, plus the target label)</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Rows: 301</span></span>
<span><span class="co">## Columns: 14</span></span>
<span><span class="co">## $ age      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 63, 67, 67, 37, 41, 56, 62, 57, 63, 53, 57, 56, 56, 44, 5…</span></span>
<span><span class="co">## $ sex      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, …</span></span>
<span><span class="co">## $ cp       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1, 4, 4, 3, 2, 2, 4, 4, 4, 4, 4, 2, 3, 2, 3, 3, 2, 4, 3, …</span></span>
<span><span class="co">## $ trestbps <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 145, 160, 120, 130, 130, 120, 140, 120, 130, 140, 140, 14…</span></span>
<span><span class="co">## $ chol     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 233, 286, 229, 250, 204, 236, 268, 354, 254, 203, 192, 29…</span></span>
<span><span class="co">## $ fbs      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, …</span></span>
<span><span class="co">## $ restecg  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 2, 2, 2, 0, 2, 0, 2, 0, 2, 2, 0, 2, 2, 0, 0, 0, 0, 0, 0, …</span></span>
<span><span class="co">## $ thalach  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 150, 108, 129, 187, 172, 178, 160, 163, 147, 155, 148, 15…</span></span>
<span><span class="co">## $ exang    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 0, 1, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, …</span></span>
<span><span class="co">## $ oldpeak  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 2.3, 1.5, 2.6, 3.5, 1.4, 0.8, 3.6, 0.6, 1.4, 3.1, 0.4, 1.…</span></span>
<span><span class="co">## $ slope    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 3, 2, 2, 3, 1, 1, 3, 1, 2, 3, 2, 2, 2, 1, 1, 1, 3, 1, 1, …</span></span>
<span><span class="co">## $ ca       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 0, 3, 2, 0, 0, 0, 2, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, …</span></span>
<span><span class="co">## $ thal     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "fixed", "normal", "reversible", "normal", "normal", "nor…</span></span>
<span><span class="co">## $ target   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, …</span></span></code></pre>
<p>Here’s a preview of a few samples:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 301 × 14</span></span></span>
<span><span class="co">##      age   sex    cp trestbps  chol   fbs restecg thalach exang oldpeak</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span>    63     1     1      145   233     1       2     150     0     2.3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span>    67     1     4      160   286     0       2     108     1     1.5</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span>    67     1     4      120   229     0       2     129     1     2.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span>    37     1     3      130   250     0       0     187     0     3.5</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span>    41     0     2      130   204     0       2     172     0     1.4</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span>    56     1     2      120   236     0       0     178     0     0.8</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span>    62     0     4      140   268     0       2     160     0     3.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span>    57     0     4      120   354     0       0     163     1     0.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span>    63     1     4      130   254     0       2     147     0     1.4</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span>    53     1     4      140   203     1       2     155     1     3.1</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 291 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 4 more variables: slope &lt;int&gt;, ca &lt;int&gt;, thal &lt;chr&gt;, target &lt;int&gt;</span></span></span></code></pre>
<p>The last column, “target”, indicates whether the patient has a heart
disease (1) or not (0).</p>
<p>Let’s split the data into a training and validation set:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">val_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op"><a href="../../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">.</span> <span class="op">*</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="va">val_df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="va">val_idx</span>, <span class="op">]</span></span>
<span><span class="va">train_df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="op">-</span><span class="va">val_idx</span>, <span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>  <span class="st">"Using %d samples for training and %d for validation"</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">train_df</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">val_df</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Using 241 samples for training and 60 for validation</span></span></code></pre>
<p>Let’s generate <code>tf_dataset</code> objects for each
dataframe:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dataframe_to_dataset</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">labels</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">target</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">inputs</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">target</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tfdatasets/man/tensor_slices_dataset.html" class="external-link">tensor_slices_dataset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">labels</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tfdatasets/man/dataset_shuffle.html" class="external-link">dataset_shuffle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">ds</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">train_ds</span> <span class="op">&lt;-</span> <span class="fu">dataframe_to_dataset</span><span class="op">(</span><span class="va">train_df</span><span class="op">)</span></span>
<span><span class="va">val_ds</span> <span class="op">&lt;-</span> <span class="fu">dataframe_to_dataset</span><span class="op">(</span><span class="va">val_df</span><span class="op">)</span></span></code></pre></div>
<p>Each <code>tf_dataset</code> yields a tuple
<code>(input, target)</code> where <code>input</code> is a dictionary (a
named list) of features and <code>target</code> is the value
<code>0</code> or <code>1</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op"><a href="../../reference/multi-assign.html">%&lt;-%</a></span> <span class="fu"><a href="https://rstudio.github.io/reticulate/reference/iterate.html" class="external-link">iter_next</a></span><span class="op">(</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/iterate.html" class="external-link">as_iterator</a></span><span class="op">(</span><span class="va">train_ds</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Input: "</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Target: "</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Input: List of 13</span></span>
<span><span class="co">##  $ age     :&lt;tf.Tensor: shape=(), dtype=int32, numpy=57&gt;</span></span>
<span><span class="co">##  $ sex     :&lt;tf.Tensor: shape=(), dtype=int32, numpy=0&gt;</span></span>
<span><span class="co">##  $ cp      :&lt;tf.Tensor: shape=(), dtype=int32, numpy=4&gt;</span></span>
<span><span class="co">##  $ trestbps:&lt;tf.Tensor: shape=(), dtype=int32, numpy=140&gt;</span></span>
<span><span class="co">##  $ chol    :&lt;tf.Tensor: shape=(), dtype=int32, numpy=241&gt;</span></span>
<span><span class="co">##  $ fbs     :&lt;tf.Tensor: shape=(), dtype=int32, numpy=0&gt;</span></span>
<span><span class="co">##  $ restecg :&lt;tf.Tensor: shape=(), dtype=int32, numpy=0&gt;</span></span>
<span><span class="co">##  $ thalach :&lt;tf.Tensor: shape=(), dtype=int32, numpy=123&gt;</span></span>
<span><span class="co">##  $ exang   :&lt;tf.Tensor: shape=(), dtype=int32, numpy=1&gt;</span></span>
<span><span class="co">##  $ oldpeak :&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.2&gt;</span></span>
<span><span class="co">##  $ slope   :&lt;tf.Tensor: shape=(), dtype=int32, numpy=2&gt;</span></span>
<span><span class="co">##  $ ca      :&lt;tf.Tensor: shape=(), dtype=int32, numpy=0&gt;</span></span>
<span><span class="co">##  $ thal    :&lt;tf.Tensor: shape=(), dtype=string, numpy=b'reversible'&gt;</span></span>
<span><span class="co">## Target: &lt;tf.Tensor: shape=(), dtype=int32, numpy=0&gt;</span></span></code></pre>
<p>Let’s batch the datasets:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train_ds</span> <span class="op">&lt;-</span> <span class="va">train_ds</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/tfdatasets/man/dataset_batch.html" class="external-link">dataset_batch</a></span><span class="op">(</span><span class="fl">32</span><span class="op">)</span></span>
<span><span class="va">val_ds</span> <span class="op">&lt;-</span> <span class="va">val_ds</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/tfdatasets/man/dataset_batch.html" class="external-link">dataset_batch</a></span><span class="op">(</span><span class="fl">32</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="configuring-a-featurespace">Configuring a <code>FeatureSpace</code><a class="anchor" aria-label="anchor" href="#configuring-a-featurespace"></a>
</h2>
<p>To configure how each feature should be preprocessed, we instantiate
a <code>layer_feature_space</code>, and we pass to it a dictionary
(named list with unique names) that maps the name of our features to a
string that describes the feature type.</p>
<p>We have a few “integer categorical” features such as
<code>"FBS"</code>, one “string categorical” feature
(<code>"thal"</code>), and a few numerical features, which we’d like to
normalize – except <code>"age"</code>, which we’d like to discretize
into a number of bins.</p>
<p>We also use the <code>crosses</code> argument to capture <em>feature
interactions</em> for some categorical features, that is to say, create
additional features that represent value co-occurrences for these
categorical features. You can compute feature crosses like this for
arbitrary sets of categorical features – not just tuples of two
features. Because the resulting co-occurences are hashed into a
fixed-sized vector, you don’t need to worry about whether the
co-occurence space is too large.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">feature_space</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/layer_feature_space.html">layer_feature_space</a></span><span class="op">(</span></span>
<span>  features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="co"># Categorical features encoded as integers</span></span>
<span>    sex <span class="op">=</span> <span class="st">"integer_categorical"</span>,</span>
<span>    cp <span class="op">=</span> <span class="st">"integer_categorical"</span>,</span>
<span>    fbs <span class="op">=</span> <span class="st">"integer_categorical"</span>,</span>
<span>    restecg <span class="op">=</span> <span class="st">"integer_categorical"</span>,</span>
<span>    exang <span class="op">=</span> <span class="st">"integer_categorical"</span>,</span>
<span>    ca <span class="op">=</span> <span class="st">"integer_categorical"</span>,</span>
<span>    <span class="co"># Categorical feature encoded as string</span></span>
<span>    thal <span class="op">=</span> <span class="st">"string_categorical"</span>,</span>
<span>    <span class="co"># Numerical features to discretize</span></span>
<span>    age <span class="op">=</span> <span class="st">"float_discretized"</span>,</span>
<span>    <span class="co"># Numerical features to normalize</span></span>
<span>    trestbps <span class="op">=</span> <span class="st">"float_normalized"</span>,</span>
<span>    chol <span class="op">=</span> <span class="st">"float_normalized"</span>,</span>
<span>    thalach <span class="op">=</span> <span class="st">"float_normalized"</span>,</span>
<span>    oldpeak <span class="op">=</span> <span class="st">"float_normalized"</span>,</span>
<span>    slope <span class="op">=</span> <span class="st">"float_normalized"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># We create additional features by hashing</span></span>
<span>  <span class="co"># value co-occurrences for the</span></span>
<span>  <span class="co"># following groups of categorical features.</span></span>
<span>  crosses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sex"</span>, <span class="st">"age"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"thal"</span>, <span class="st">"ca"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="co"># The hashing space for these co-occurrences</span></span>
<span>  <span class="co"># wil be 32-dimensional.</span></span>
<span>  crossing_dim <span class="op">=</span> <span class="fl">32</span>,</span>
<span>  <span class="co"># Our utility will one-hot encode all categorical</span></span>
<span>  <span class="co"># features and concat all features into a single</span></span>
<span>  <span class="co"># vector (one vector per sample).</span></span>
<span>  output_mode <span class="op">=</span> <span class="st">"concat"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="further-customizing-a-featurespace">Further customizing a <code>FeatureSpace</code><a class="anchor" aria-label="anchor" href="#further-customizing-a-featurespace"></a>
</h2>
<p>Specifying the feature type via a string name is quick and easy, but
sometimes you may want to further configure the preprocessing of each
feature. For instance, in our case, our categorical features don’t have
a large set of possible values – it’s only a handful of values per
feature (e.g. <code>1</code> and <code>0</code> for the feature
<code>"FBS"</code>), and all possible values are represented in the
training set. As a result, we don’t need to reserve an index to
represent “out of vocabulary” values for these features – which would
have been the default behavior. Below, we just specify
<code>num_oov_indices=0</code> in each of these features to tell the
feature preprocessor to skip “out of vocabulary” indexing.</p>
<p>Other customizations you have access to include specifying the number
of bins for discretizing features of type
<code>"float_discretized"</code>, or the dimensionality of the hashing
space for feature crossing.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">feature_space</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/layer_feature_space.html">layer_feature_space</a></span><span class="op">(</span></span>
<span>  features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="co"># Categorical features encoded as integers</span></span>
<span>    sex       <span class="op">=</span> <span class="fu"><a href="../../reference/layer_feature_space.html">feature_integer_categorical</a></span><span class="op">(</span>num_oov_indices <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    cp        <span class="op">=</span> <span class="fu"><a href="../../reference/layer_feature_space.html">feature_integer_categorical</a></span><span class="op">(</span>num_oov_indices <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    fbs       <span class="op">=</span> <span class="fu"><a href="../../reference/layer_feature_space.html">feature_integer_categorical</a></span><span class="op">(</span>num_oov_indices <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    restecg   <span class="op">=</span> <span class="fu"><a href="../../reference/layer_feature_space.html">feature_integer_categorical</a></span><span class="op">(</span>num_oov_indices <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    exang     <span class="op">=</span> <span class="fu"><a href="../../reference/layer_feature_space.html">feature_integer_categorical</a></span><span class="op">(</span>num_oov_indices <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    ca        <span class="op">=</span> <span class="fu"><a href="../../reference/layer_feature_space.html">feature_integer_categorical</a></span><span class="op">(</span>num_oov_indices <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    <span class="co"># Categorical feature encoded as string</span></span>
<span>    thal      <span class="op">=</span> <span class="fu"><a href="../../reference/layer_feature_space.html">feature_string_categorical</a></span><span class="op">(</span>num_oov_indices <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    <span class="co"># Numerical features to discretize</span></span>
<span>    age       <span class="op">=</span> <span class="fu"><a href="../../reference/layer_feature_space.html">feature_float_discretized</a></span><span class="op">(</span>num_bins <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>,</span>
<span>    <span class="co"># Numerical features to normalize</span></span>
<span>    trestbps  <span class="op">=</span> <span class="fu"><a href="../../reference/layer_feature_space.html">feature_float_normalized</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    chol      <span class="op">=</span> <span class="fu"><a href="../../reference/layer_feature_space.html">feature_float_normalized</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    thalach   <span class="op">=</span> <span class="fu"><a href="../../reference/layer_feature_space.html">feature_float_normalized</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    oldpeak   <span class="op">=</span> <span class="fu"><a href="../../reference/layer_feature_space.html">feature_float_normalized</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    slope     <span class="op">=</span> <span class="fu"><a href="../../reference/layer_feature_space.html">feature_float_normalized</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Specify feature cross with a custom crossing dim.</span></span>
<span>  crosses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../../reference/layer_feature_space.html">feature_cross</a></span><span class="op">(</span></span>
<span>      feature_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sex"</span>, <span class="st">"age"</span><span class="op">)</span>,</span>
<span>      crossing_dim <span class="op">=</span> <span class="fl">64</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../../reference/layer_feature_space.html">feature_cross</a></span><span class="op">(</span></span>
<span>      feature_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"thal"</span>, <span class="st">"ca"</span><span class="op">)</span>,</span>
<span>      crossing_dim <span class="op">=</span> <span class="fl">16</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  output_mode <span class="op">=</span> <span class="st">"concat"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="adapt-the-featurespace-to-the-training-data">Adapt the <code>FeatureSpace</code> to the training data<a class="anchor" aria-label="anchor" href="#adapt-the-featurespace-to-the-training-data"></a>
</h2>
<p>Before we start using the <code>FeatureSpace</code> to build a model,
we have to adapt it to the training data. During <code><a href="../../reference/adapt.html">adapt()</a></code>,
the <code>FeatureSpace</code> will:</p>
<ul>
<li>Index the set of possible values for categorical features.</li>
<li>Compute the mean and variance for numerical features to
normalize.</li>
<li>Compute the value boundaries for the different bins for numerical
features to discretize.</li>
</ul>
<p>Note that <code><a href="../../reference/adapt.html">adapt()</a></code> should be called on a
<code>tf_dataset</code> which yields dicts (named lists) of feature
values – no labels.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train_ds_with_no_labels</span> <span class="op">&lt;-</span> <span class="va">train_ds</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/tfdatasets/man/dataset_map.html" class="external-link">dataset_map</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="va">feature_space</span> <span class="op">|&gt;</span> <span class="fu"><a href="../../reference/adapt.html">adapt</a></span><span class="op">(</span><span class="va">train_ds_with_no_labels</span><span class="op">)</span></span></code></pre></div>
<p>At this point, the <code>FeatureSpace</code> can be called on a dict
of raw feature values, and will return a single concatenate vector for
each sample, combining encoded features and feature crosses.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op"><a href="../../reference/multi-assign.html">%&lt;-%</a></span> <span class="fu"><a href="https://rstudio.github.io/reticulate/reference/iterate.html" class="external-link">iter_next</a></span><span class="op">(</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/iterate.html" class="external-link">as_iterator</a></span><span class="op">(</span><span class="va">train_ds</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">preprocessed_x</span> <span class="op">&lt;-</span> <span class="fu">feature_space</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">preprocessed_x</span></span></code></pre></div>
<pre><code><span><span class="co">## tf.Tensor(</span></span>
<span><span class="co">## [[0. 0. 0. ... 1. 0. 0.]</span></span>
<span><span class="co">##  [0. 0. 0. ... 0. 0. 0.]</span></span>
<span><span class="co">##  [0. 0. 0. ... 0. 0. 0.]</span></span>
<span><span class="co">##  ...</span></span>
<span><span class="co">##  [0. 0. 0. ... 0. 0. 0.]</span></span>
<span><span class="co">##  [0. 0. 0. ... 0. 0. 0.]</span></span>
<span><span class="co">##  [0. 0. 0. ... 0. 0. 0.]], shape=(32, 136), dtype=float32)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="two-ways-to-manage-preprocessing-as-part-of-the-tf-data-pipeline-or-in-the-model-itself">Two ways to manage preprocessing: as part of the
<code>tf.data</code> pipeline, or in the model itself<a class="anchor" aria-label="anchor" href="#two-ways-to-manage-preprocessing-as-part-of-the-tf-data-pipeline-or-in-the-model-itself"></a>
</h2>
<p>There are two ways in which you can leverage your
<code>FeatureSpace</code>:</p>
<div class="section level3">
<h3 id="asynchronous-preprocessing-in-tf-data">Asynchronous preprocessing in <code>tf.data</code><a class="anchor" aria-label="anchor" href="#asynchronous-preprocessing-in-tf-data"></a>
</h3>
<p>You can make it part of your data pipeline, before the model. This
enables asynchronous parallel preprocessing of the data on CPU before it
hits the model. Do this if you’re training on GPU or TPU, or if you want
to speed up preprocessing. Usually, this is always the right thing to do
during training.</p>
</div>
<div class="section level3">
<h3 id="synchronous-preprocessing-in-the-model">Synchronous preprocessing in the model<a class="anchor" aria-label="anchor" href="#synchronous-preprocessing-in-the-model"></a>
</h3>
<p>You can make it part of your model. This means that the model will
expect dicts of raw feature values, and the preprocessing batch will be
done synchronously (in a blocking manner) before the rest of the forward
pass. Do this if you want to have an end-to-end model that can process
raw feature values – but keep in mind that your model will only be able
to run on CPU, since most types of feature preprocessing (e.g. string
preprocessing) are not GPU or TPU compatible.</p>
<p>Do not do this on GPU / TPU or in performance-sensitive settings. In
general, you want to do in-model preprocessing when you do inference on
CPU.</p>
<p>In our case, we will apply the <code>FeatureSpace</code> in the
tf.data pipeline during training, but we will do inference with an
end-to-end model that includes the <code>FeatureSpace</code>.</p>
<p>Let’s create a training and validation dataset of preprocessed
batches:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preprocessed_train_ds</span> <span class="op">&lt;-</span> <span class="va">train_ds</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tfdatasets/man/dataset_map.html" class="external-link">dataset_map</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu">feature_space</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>              num_parallel_calls <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">AUTOTUNE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tfdatasets/man/dataset_prefetch.html" class="external-link">dataset_prefetch</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">AUTOTUNE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preprocessed_val_ds</span> <span class="op">&lt;-</span> <span class="va">val_ds</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tfdatasets/man/dataset_map.html" class="external-link">dataset_map</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu">feature_space</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>              num_parallel_calls <span class="op">=</span> <span class="va">tf</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">AUTOTUNE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tfdatasets/man/dataset_prefetch.html" class="external-link">dataset_prefetch</a></span><span class="op">(</span><span class="va">tf</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">AUTOTUNE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="build-a-model">Build a model<a class="anchor" aria-label="anchor" href="#build-a-model"></a>
</h2>
<p>Time to build a model – or rather two models:</p>
<ul>
<li>A training model that expects preprocessed features (one sample =
one vector)</li>
<li>An inference model that expects raw features (one sample = dict of
raw feature values)</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dict_inputs</span> <span class="op">&lt;-</span> <span class="va">feature_space</span><span class="op">$</span><span class="fu">get_inputs</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">encoded_features</span> <span class="op">&lt;-</span> <span class="va">feature_space</span><span class="op">$</span><span class="fu">get_encoded_features</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">predictions</span> <span class="op">&lt;-</span> <span class="va">encoded_features</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">32</span>, activation<span class="op">=</span><span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../../reference/layer_dropout.html">layer_dropout</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../../reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">1</span>, activation<span class="op">=</span><span class="st">"sigmoid"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">training_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/keras_model.html">keras_model</a></span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">encoded_features</span>,</span>
<span>                              outputs <span class="op">=</span> <span class="va">predictions</span><span class="op">)</span></span>
<span><span class="va">training_model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html" class="external-link">compile</a></span><span class="op">(</span>optimizer <span class="op">=</span> <span class="st">"adam"</span>,</span>
<span>                          loss <span class="op">=</span> <span class="st">"binary_crossentropy"</span>,</span>
<span>                          metrics <span class="op">=</span> <span class="st">"accuracy"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">inference_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/keras_model.html">keras_model</a></span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">dict_inputs</span>,</span>
<span>                               outputs <span class="op">=</span> <span class="va">predictions</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="train-the-model">Train the model<a class="anchor" aria-label="anchor" href="#train-the-model"></a>
</h2>
<p>Let’s train our model for 20 epochs. Note that feature preprocessing
is happening as part of the tf.data pipeline, not as part of the
model.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">training_model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span></span>
<span>  <span class="va">preprocessed_train_ds</span>,</span>
<span>  epochs <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  validation_data <span class="op">=</span> <span class="va">preprocessed_val_ds</span>,</span>
<span>  verbose <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Epoch 1/20</span></span>
<span><span class="co">## 8/8 - 3s - 343ms/step - accuracy: 0.5685 - loss: 0.7120 - val_accuracy: 0.6500 - val_loss: 0.6607</span></span>
<span><span class="co">## Epoch 2/20</span></span>
<span><span class="co">## 8/8 - 0s - 13ms/step - accuracy: 0.6722 - loss: 0.6131 - val_accuracy: 0.6500 - val_loss: 0.6212</span></span>
<span><span class="co">## Epoch 3/20</span></span>
<span><span class="co">## 8/8 - 0s - 12ms/step - accuracy: 0.7137 - loss: 0.5685 - val_accuracy: 0.6500 - val_loss: 0.5961</span></span>
<span><span class="co">## Epoch 4/20</span></span>
<span><span class="co">## 8/8 - 0s - 13ms/step - accuracy: 0.7718 - loss: 0.4981 - val_accuracy: 0.6667 - val_loss: 0.5758</span></span>
<span><span class="co">## Epoch 5/20</span></span>
<span><span class="co">## 8/8 - 0s - 12ms/step - accuracy: 0.7635 - loss: 0.4804 - val_accuracy: 0.6500 - val_loss: 0.5575</span></span>
<span><span class="co">## Epoch 6/20</span></span>
<span><span class="co">## 8/8 - 0s - 12ms/step - accuracy: 0.7676 - loss: 0.4739 - val_accuracy: 0.6667 - val_loss: 0.5309</span></span>
<span><span class="co">## Epoch 7/20</span></span>
<span><span class="co">## 8/8 - 0s - 13ms/step - accuracy: 0.7842 - loss: 0.4141 - val_accuracy: 0.6667 - val_loss: 0.5161</span></span>
<span><span class="co">## Epoch 8/20</span></span>
<span><span class="co">## 8/8 - 0s - 13ms/step - accuracy: 0.8133 - loss: 0.3841 - val_accuracy: 0.6667 - val_loss: 0.5080</span></span>
<span><span class="co">## Epoch 9/20</span></span>
<span><span class="co">## 8/8 - 0s - 12ms/step - accuracy: 0.8133 - loss: 0.3997 - val_accuracy: 0.6667 - val_loss: 0.4980</span></span>
<span><span class="co">## Epoch 10/20</span></span>
<span><span class="co">## 8/8 - 0s - 12ms/step - accuracy: 0.8340 - loss: 0.3618 - val_accuracy: 0.6833 - val_loss: 0.4882</span></span>
<span><span class="co">## Epoch 11/20</span></span>
<span><span class="co">## 8/8 - 0s - 12ms/step - accuracy: 0.8548 - loss: 0.3335 - val_accuracy: 0.6833 - val_loss: 0.4814</span></span>
<span><span class="co">## Epoch 12/20</span></span>
<span><span class="co">## 8/8 - 0s - 12ms/step - accuracy: 0.8465 - loss: 0.3535 - val_accuracy: 0.6833 - val_loss: 0.4818</span></span>
<span><span class="co">## Epoch 13/20</span></span>
<span><span class="co">## 8/8 - 0s - 12ms/step - accuracy: 0.8340 - loss: 0.3363 - val_accuracy: 0.7000 - val_loss: 0.4755</span></span>
<span><span class="co">## Epoch 14/20</span></span>
<span><span class="co">## 8/8 - 0s - 12ms/step - accuracy: 0.8548 - loss: 0.3224 - val_accuracy: 0.7333 - val_loss: 0.4745</span></span>
<span><span class="co">## Epoch 15/20</span></span>
<span><span class="co">## 8/8 - 0s - 12ms/step - accuracy: 0.8714 - loss: 0.3083 - val_accuracy: 0.7500 - val_loss: 0.4813</span></span>
<span><span class="co">## Epoch 16/20</span></span>
<span><span class="co">## 8/8 - 0s - 12ms/step - accuracy: 0.8797 - loss: 0.3270 - val_accuracy: 0.7500 - val_loss: 0.4690</span></span>
<span><span class="co">## Epoch 17/20</span></span>
<span><span class="co">## 8/8 - 0s - 12ms/step - accuracy: 0.8631 - loss: 0.2955 - val_accuracy: 0.7500 - val_loss: 0.4782</span></span>
<span><span class="co">## Epoch 18/20</span></span>
<span><span class="co">## 8/8 - 0s - 12ms/step - accuracy: 0.8797 - loss: 0.2831 - val_accuracy: 0.7667 - val_loss: 0.4818</span></span>
<span><span class="co">## Epoch 19/20</span></span>
<span><span class="co">## 8/8 - 0s - 12ms/step - accuracy: 0.8797 - loss: 0.2872 - val_accuracy: 0.7667 - val_loss: 0.4767</span></span>
<span><span class="co">## Epoch 20/20</span></span>
<span><span class="co">## 8/8 - 0s - 12ms/step - accuracy: 0.8631 - loss: 0.2877 - val_accuracy: 0.7833 - val_loss: 0.4781</span></span></code></pre>
<p>We quickly get to 80% validation accuracy.</p>
</div>
<div class="section level2">
<h2 id="inference-on-new-data-with-the-end-to-end-model">Inference on new data with the end-to-end model<a class="anchor" aria-label="anchor" href="#inference-on-new-data-with-the-end-to-end-model"></a>
</h2>
<p>Now, we can use our inference model (which includes the
<code>FeatureSpace</code>) to make predictions based on dicts of raw
features values, as follows:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  age <span class="op">=</span> <span class="fl">60</span>,</span>
<span>  sex <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  cp <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  trestbps <span class="op">=</span> <span class="fl">145</span>,</span>
<span>  chol <span class="op">=</span> <span class="fl">233</span>,</span>
<span>  fbs <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  restecg <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  thalach <span class="op">=</span> <span class="fl">150</span>,</span>
<span>  exang <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  oldpeak <span class="op">=</span> <span class="fl">2.3</span>,</span>
<span>  slope <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  ca <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  thal <span class="op">=</span> <span class="st">"fixed"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">input_dict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">sample</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../../reference/op_convert_to_tensor.html">op_convert_to_tensor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">predictions</span> <span class="op">&lt;-</span> <span class="va">inference_model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">input_dict</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 1/1 - 1s - 548ms/step</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">r"---(</span></span>
<span><span class="st">  This particular patient had a {(100 * predictions) |&gt; signif(3)}% probability</span></span>
<span><span class="st">  of having a heart disease, as evaluated by our model.</span></span>
<span><span class="st">)---"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## This particular patient had a 55% probability</span></span>
<span><span class="co">## of having a heart disease, as evaluated by our model.</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tomasz Kalinowski, JJ Allaire, François Chollet, Posit Software, PBC, Google.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>





  </body>
</html>
